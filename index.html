<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeaBoo</title>
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653147807800151" crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Sistema de Traducción Automática Mejorado -->
  <script type="text/javascript">
    // Detectar idioma del navegador y aplicar traducción inmediatamente
    (function() {
      const userLang = (navigator.language || navigator.userLanguage).split('-')[0];
      console.log('Idioma del navegador detectado:', userLang);
      
      // Guardar idioma preferido
      if (!localStorage.getItem('preferredLanguage')) {
        localStorage.setItem('preferredLanguage', userLang);
      }
      
      // Mapeo de idiomas soportados
      const supportedLanguages = {
        'es': 'es',
        'en': 'en', 
        'pt': 'pt',
        'fr': 'fr',
        'de': 'de',
        'it': 'it',
        'ja': 'ja',
        'ko': 'ko',
        'zh': 'zh-CN',
        'ar': 'ar',
        'hi': 'hi',
        'ru': 'ru',
        'tr': 'tr',
        'vi': 'vi',
        'th': 'th',
        'id': 'id',
        'pl': 'pl',
        'nl': 'nl'
      };
      
      const targetLang = supportedLanguages[userLang] || 'en';
      
      // Si el idioma no es inglés, preparar para traducir
      if (targetLang !== 'en') {
        document.documentElement.setAttribute('data-translate-lang', targetLang);
      }
    })();
    
    

  /* Estilo para el gift drawer (abrir desde abajo) */
  #gift-drawer {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    height: 70%;
    z-index: 60;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    transition: bottom 0.3s ease-in-out;
    overflow-y: auto;
  }

  #gift-drawer.open {
    bottom: 0;
  }

  /* Estilo para corazones animados */
  .heart {
    position: absolute;
    font-size: 25px;
    color: #00D6C9;
    animation: float-up 2s ease-out forwards;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }

  @keyframes float-up {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }

    100% {
      transform: translateY(-100px) scale(1.5);
      opacity: 0;
    }
  }

  /* Estilo para switch toggle */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #00D6C9;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #00D6C9;
  }

  input:checked+.slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  /* Animación de verificación */
  .verification-animation {
    display: inline-block;
    margin: 0 auto;
  }
  
  /* Forzar tema TikTok en botones */
  button[class*="green"],
  .bg-green-500,
  .bg-green-600 {
    background-color: #FE2C55 !important;
  }
  
  button[class*="green"]:hover,
  .hover\:bg-green-600:hover {
    background-color: #e02849 !important;
  }
  
  /* Forzar color de texto negro en capítulos */
  #detail-chapters li span {
    color: #000 !important;
    font-weight: 500 !important;
  }

  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #00D6C9;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #00D6C9;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }

  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #00D6C9;
    fill: none;
    animation: stroke .6s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
  }

  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) .8s forwards;
  }

  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }

  @keyframes scale {

    0%,
    100% {
      transform: none;
    }

    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }

  @keyframes fill {
    100% {
      box-shadow: inset 0px 0px 0px 30px #00D6C9;
    }
  }

  /* Animación de hilos subiendo en el banner expandido */
  #animated-lines {
    position: relative;
    width: 100%;
    height: 50px;
    overflow: hidden;
    margin-top: 20px;
  }

  .line {
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to top, transparent, #00D6C9);
    animation: rise 3s linear infinite;
    opacity: 0.7;
  }

  @keyframes rise {
    0% {
      top: 100%;
      opacity: 0;
    }

    50% {
      opacity: 1;
    }

    100% {
      top: -50px;
      opacity: 0;
    }
  }
</style>

<!-- JavaScript: Funcionalidades y Gestos -->
<script>
  // FUNCIONES DE MARCOS ANIMADOS
  
  // -------------------------------
  // Funciones de Ajustes y Modales
  // -------------------------------
  , false);
  viewerModal.addEventListener("touchend", function(e) {
    touchendX = e.changedTouches[0].screenX;
    handleViewerSwipe();
  }, false);

  
    document.getElementById("viewer-tapCount").classList.remove("hidden");
    document.getElementById("likeCountLiveViewer").classList.remove("hidden");
  }
</script>
</script>

<!-- JAVASCRIPT -->
<script>
  /*********************** FUNCIONES DE NAVEGACIÓN **************************/
  

  
      
      // CARGAR ESTADÍSTICAS EN TIEMPO REAL
      loadUserStats(user.uid);
      
      // Cargar historias de otros usuarios inmediatamente
      setTimeout(() => {
        const storiesScript = document.querySelector('script[src="stories.js"]');
        if (storiesScript && window.loadStories) {
          window.loadStories();
        }
      }, 1000);
      
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data && data.blocked && data.blockedUntil && Date.now() < data.blockedUntil) {
          alert("Tu cuenta ha sido bloqueada por infracciones. Por favor, contacta con el soporte para recuperar el acceso.");
          firebase.auth().signOut();
          return;
        }
        authFormContainer.style.display = 'none';
        mainAppContainer.style.display = 'flex';
        loadStories();
        loadUserStories(user.uid);
        initializeFeedSections();
        
        if (data) {
          let displayName = data.username || "Usuario";
          if (data.founder) {
            displayName += ' <span class="founder-tag">Fundador</span>';
          }
          displayName += getVerificationIcon(data.email);
          
          // Actualizar perfil móvil
          document.getElementById('profile-username').innerHTML = displayName;
          document.getElementById('profile-followers').textContent = formatNumber(data.followersCount || 0);
          document.getElementById('profile-following').textContent = formatNumber(data.followingCount || 0);
          
          // Actualizar perfil desktop
          const usernameDesktop = document.getElementById('profile-username-desktop');
          const followersDesktop = document.getElementById('profile-followers-desktop');
          const followingDesktop = document.getElementById('profile-following-desktop');
          
          if (usernameDesktop) usernameDesktop.innerHTML = displayName;
          if (followersDesktop) followersDesktop.textContent = formatNumber(data.followersCount || 0);
          if (followingDesktop) followingDesktop.textContent = formatNumber(data.followingCount || 0);
          
          if (data.bio) {
            const bioElement = document.getElementById('profile-bio');
            if (bioElement) bioElement.value = data.bio;
          }
          if (data.profileImage) {
            document.getElementById('profile-image').src = data.profileImage;
            const profileImageDesktop = document.getElementById('profile-image-desktop');
            if (profileImageDesktop) profileImageDesktop.src = data.profileImage;
          }
          
          // Cargar marco del perfil del usuario
          loadUserFrame(user.uid, 'profile-frame');
          loadUserFrame(user.uid, 'profile-frame-desktop');
        }
      });
    } else {
      authFormContainer.style.display = 'flex';
      mainAppContainer.style.display = 'none';
    }
  });
  /*********************** AUTENTICACIÓN CON GOOGLE Y FACEBOOK **************************/
  
          // Agregamos una clase para un borde pulsante de color verde (estilo Duolingo)
          document.getElementById('author-profile-image').classList.add('live-border');
        } else {
          let liveLabel = ;
          if (liveLabel) {
            liveLabel.remove();
          }
          document.getElementById('author-profile-image').classList.remove('live-border');
        }
      });
    });
    currentViewedAuthorId = authorId;
    document.getElementById('author-profile-modal').style.display = "block";
    updateFollowIcon();
    loadAuthorStories(authorId);
    document.getElementById('author-profile-image').onclick = function() {
      
        }
      });
    };
  }

  px`;
    heart.style.top = `${y - 12}px`;
    liveContainer.appendChild(heart);
    setTimeout(() => {
      heart.remove();
    }, 1500);
  }

   else {
      likeCountLive.textContent = likesLive;
    }
  }
  if (heartButton) {
    heartButton.addEventListener('click', () => {
      const rect = heartButton.getBoundingClientRect();
      createHeart(rect.left + rect.width / 2, rect.top + rect.height / 2);
      updateLikeCountLive();
    });
  }
</script>

<!-- (El modal de compra de monedas ha sido removido) -->

<script>
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electrónico",
      passwordPlaceholder: "Contraseña",
      btnIniciarSesion: "Iniciar Sesión",
      btnToggleAuth: "¿No tienes cuenta? Regístrate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "Más Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de búsqueda",
      searchBooks: "Libros",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biografía",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "Título de la historia",
      selectCategory: "Selecciona una categoría",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Capítulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Capítulo",
      chapterPlaceholder: "Escribe el contenido del capítulo aquí...",
      btnSaveChapter: "Guardar Capítulo",
      readChapter: "Capítulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con éxito. En breve recibirás una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biografía actualizada.",
      chapterAdded: "Capítulo agregado.",
      noEditingStory: "No hay historia en edición.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Capítulo no encontrado.",
      firstChapter: "Este es el primer capítulo.",
      lastChapter: "Este es el último capítulo.",
      chapterRated: "Capítulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia más tarde desde tu perfil."
    },
    en: {
      appName: "BeaBoo",
      editLater: "You can edit your story later from your profile."
    },
    pt: {
      appName: "BeaBoo",
      tagline: "Seu portal para histórias inesquecíveis",
      editLater: "Você pode editar sua história mais tarde em seu perfil."
    }
  };
  // Función que actualiza los textos de la interfaz según currentLanguage
  function updateTranslations() {
    // Ejemplo: Actualizamos el título de la aplicación y el tagline
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    // ... (continúa actualizando todos los elementos que dependan de traducciones)
  }
  // Función para establecer el idioma y guardar la selección
  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    if (langOverlay) langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      if (langOverlay) langOverlay.style.display = "none";
      const langModal = document.getElementById('language-modal');
      if (langModal) langModal.style.display = "none";
    }, 1000);
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }
</script>

  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>

<!-- Story Viewer Modal -->
<div id="story-viewer">
    <div class="story-content">
        <!-- Story content will be loaded here -->
    </div>
    <button id="story-viewer-close" class="story-close">&times;</button>
</div>

<!-- Story Upload Modal -->
<div id="story-upload-modal">
    <div class="story-upload-content">
        <div class="story-upload-header">
            <button class="back-btn" id="story-upload-back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 style="margin: 0;">Subir Historia</h2>
            <div style="width: 40px;"></div>
        </div>
        
        <div class="story-upload-preview">
            <img src="" alt="Preview">
        </div>
        
        <form id="story-upload-form">
            <div class="file-input-wrapper">
                <label for="story-file" class="file-input-label">
                    <i class="fas fa-camera"></i>
                    <span>Seleccionar imagen</span>
                    <span class="file-hint">Toca para elegir de tu galería</span>
                </label>
                <input type="file" id="story-file" accept="image/*" required>
            </div>
            
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
                <div class="progress-text">Subiendo...</div>
            </div>
            
            <button type="submit">Subir Historia</button>
        </form>
    </div>
</div>

<!-- Global Loading Spinner -->
<div id="global-loader" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden items-center justify-center">
  <div class="loader"></div>
</div>

<style>
.loader {
  border: 4px solid rgba(254, 44, 85, 0.1);
  border-radius: 50%;
  border-top: 4px solid #FE2C55;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
// Global loading spinner functions
function showLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'flex';
  }
}

function hideLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Automatic Firebase to S3 migration on first load
async function autoMigrateFirebaseData() {
  const migrationKey = 'firebase_s3_migration_completed';
  const migrationCompleted = localStorage.getItem(migrationKey);
  
  if (migrationCompleted === 'true') {
    console.log('Migration already completed');
    return;
  }

  try {
    console.log('Starting automatic Firebase to S3 migration...');
    showLoader();
    
    const response = await fetch('/.netlify/functions/migrate-firebase-to-s3', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ deleteFromFirebase: false })
    });

    const result = await response.json();
    
    if (response.ok && result.success) {
      console.log(`Migration successful: ${result.migrated} stories migrated`);
      localStorage.setItem(migrationKey, 'true');
    } else {
      console.warn('Migration had issues:', result);
    }
  } catch (error) {
    console.error('Auto-migration error:', error);
  } finally {
    hideLoader();
  }
}

// Run migration on authenticated user
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    autoMigrateFirebaseData();
  }
});
</script>

<script src="stories.js"></script>
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>
</html>

