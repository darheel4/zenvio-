<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeaBoo</title>
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4653147807800151" crossorigin="anonymous"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pap6t+K2bD6xIxQqkQ3sM8e+RXw7C3DyrgXV++o2aL/88+/9kS/l+SmpD8zZR1oN40Nq3QfT7HigDYfFW1zZAQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Sistema de Traducci√≥n Autom√°tica Mejorado -->
  <script type="text/javascript">
    // Detectar idioma del navegador y aplicar traducci√≥n inmediatamente
    (function() {
      const userLang = (navigator.language || navigator.userLanguage).split('-')[0];
      
      // Guardar idioma preferido solo si no existe
      if (!localStorage.getItem('preferredLanguage')) {
        localStorage.setItem('preferredLanguage', userLang);
      }
      
      // Mapeo de idiomas soportados
      const supportedLanguages = {
        'es': 'es',
        'en': 'en', 
        'pt': 'pt',
        'fr': 'fr',
        'de': 'de',
        'it': 'it',
        'ja': 'ja',
        'ko': 'ko',
        'zh': 'zh-CN',
        'ar': 'ar',
        'hi': 'hi',
        'ru': 'ru',
        'tr': 'tr',
        'vi': 'vi',
        'th': 'th',
        'id': 'id',
        'pl': 'pl',
        'nl': 'nl'
      };
      
      const targetLang = supportedLanguages[userLang] || 'en';
      
      // Si el idioma no es ingl√©s, preparar para traducir
      if (targetLang !== 'en') {
        document.documentElement.setAttribute('data-translate-lang', targetLang);
      }
    })();
    
    function googleTranslateElementInit() {
      const preferredLang = localStorage.getItem('preferredLanguage') || 
                           (navigator.language || navigator.userLanguage).split('-')[0];
      
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,es,pt,fr,de,it,ja,ko,zh-CN,zh-TW,ar,hi,ru,tr,vi,th,id,pl,nl,sv,no,da,fi,el,he,uk,cs,ro,hu,bg,hr,sk,sl,lt,lv,et',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: true,
        multilanguagePage: true
      }, 'google_translate_element');
      
      // Aplicar traducci√≥n autom√°tica inmediatamente
      const applyTranslation = () => {
        const targetLang = document.documentElement.getAttribute('data-translate-lang');
        
        if (targetLang && targetLang !== 'en') {
          const selectField = document.querySelector('.goog-te-combo');
          if (selectField) {
            console.log('Aplicando traducci√≥n autom√°tica a:', targetLang);
            selectField.value = targetLang;
            selectField.dispatchEvent(new Event('change'));
            
            // Marcar como traducido
            setTimeout(() => {
              document.documentElement.setAttribute('data-translated', 'true');
            }, 1000);
          } else {
            // Reintentar si el selector no est√° disponible a√∫n
            setTimeout(applyTranslation, 500);
          }
        }
      };
      
      // Intentar aplicar traducci√≥n inmediatamente
      setTimeout(applyTranslation, 100);
    }
    
    // Forzar recarga de traducci√≥n cuando se carga la p√°gina
    window.addEventListener('load', function() {
      const targetLang = document.documentElement.getAttribute('data-translate-lang');
      if (targetLang && !document.documentElement.getAttribute('data-translated')) {
        setTimeout(() => {
          const selectField = document.querySelector('.goog-te-combo');
          if (selectField && selectField.value !== targetLang) {
            selectField.value = targetLang;
            selectField.dispatchEvent(new Event('change'));
          }
        }, 2000);
      }
    });
  </script>
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <style>
    /* Ocultar banner de Google Translate pero mantener funcionalidad */
    .goog-te-banner-frame.skiptranslate {
      display: none !important;
    }
    .goog-te-banner-frame {
      display: none !important;
    }
    body {
      top: 0px !important;
    }
    /* Ocultar el widget pero mantener funcionalidad */
    #google_translate_element {
      position: fixed;
      top: -9999px;
      left: -9999px;
      visibility: hidden;
      opacity: 0;
      pointer-events: none;
    }
    .goog-te-gadget {
      display: none !important;
    }
    /* Ocultar el logo de Google Translate */
    .goog-logo-link {
      display: none !important;
    }
    .goog-te-gadget-simple {
      display: none !important;
    }
    /* Ocultar el iframe de Google Translate */
    iframe.goog-te-banner-frame {
      display: none !important;
    }
    /* Ocultar elementos de Google */
    .skiptranslate {
      display: none !important;
    }
  </style>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="tiktok-loader.css">

  
  
  
  <style>
    /* ESTILOS BASE ADAPTADOS */
body {
  font-family: 'Roboto', sans-serif;
  background: white;
  color: #000;
}

/* Sobrescribir estilos verdes a rosa TikTok - ELIMINADO PARA EVITAR CONFLICTOS GLOBALES */

/* Ocultar t√≠tulo "Cap√≠tulos" y tagline en la pantalla de inicio */
#detail-chapters-title,
#tagline {
  display: none;
}

/* L√≠nea divisoria */
.section-divider {
  border-bottom: 2px solid #FE2C55;
  margin: 20px 0;
}
/* Estilos para las estrellas seleccionadas */
.star.selected {
  color: #FE2C55;
  transition: color 0.3s ease-in-out;
  text-shadow: 0 0 10px rgba(254,44,85,0.5);
}

/* Margen para la lista de cap√≠tulos */
#detail-chapters {
  margin-top: 10px;
}

/* Notificaciones */
.notification-item {
  padding: 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  margin-bottom: 8px;
  background: #f9f9f9;
  color: #000;
}

.notification-time {
  font-size: 0.8em;
  color: #FE2C55;
  margin-top: 4px;
}

/* Etiqueta de fundador */
.founder-tag {
  font-size: 0.8rem;
  color: #FE2C55;
  background-color: rgba(254,44,85,0.15);
  border-radius: 4px;
  padding: 2px 4px;
  margin-left: 4px;
}

/* Barra inferior con efecto difuminado */
#bottom-nav {
  background-color: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: background-color 0.3s ease-in-out;
  border-top: 1px solid rgba(254,44,85,0.3);
}

/* --- MODALES CON Z-INDEX ALTO --- */
#followers-modal,
#following-modal {
  z-index: 9999 !important;
}

    /* MODAL DE ERROR PARA USUARIO BLOQUEADO */
#blocked-error-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: white;
  align-items: center;
  justify-content: center;
}

#blocked-error-modal img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#blocked-error-modal button {
  display: none;
}

/* MODAL DE CREACI√ìN DE CAP√çTULO FULL SCREEN MODERNIZADO */
#chapter-creation-modal {
  position: fixed;
  inset: 0;
  display: none;
  background-color: rgba(255, 255, 255, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 50;
}

#chapter-creation-modal .modal-content {
  background: white;
  width: 100%;
  height: 100%;
  padding: 1.5rem;
  position: relative;
  overflow: auto;
  color: #000;
}

/* PORTADAS DE HISTORIAS ADAPTATIVAS */
.story-card {
  flex-shrink: 0;
  width: 100%;
  max-width: 250px;
}

@media (max-width: 640px) {
  .story-card {
    max-width: 160px;
  }
}

.story-cover-container {
  position: relative;
  width: 100%;
  padding-top: 133.33%;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.story-cover-image {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.rating-badge {
  position: absolute;
  top: 8px;
  left: 8px;
  background-color: #FE2C55;
  color: white;
  border-radius: 9999px;
  padding: 2px 6px;
  font-size: 0.75rem;
  font-weight: bold;
  z-index: 10;
}

/* ANIMACI√ìN DE CARGA EN B√öSQUEDA - Movida a tiktok-loader.css */

    /* Panel de estad√≠sticas en edici√≥n */
    .stats-panel>div:not(:last-child) {
      border-right: 1px solid #1e4994;
    }

    /* Gift Drawer: modal de regalos que se desliza desde abajo */
    #gift-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 0;
      background-color: #ffffff;
      overflow: hidden;
      transition: height 0.4s ease;
      z-index: 10000;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
      border-top: 1px solid #e5e7eb;
    }

    #gift-drawer.open {
      height: 50vh;
      overflow-y: auto;
    }

    #gift-drawer .gift-container {
      padding: 20px;
    }

    #gift-drawer .gift-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      text-align: center;
    }

    #gift-drawer .gift-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #gift-drawer .gift-item span {
      font-size: 0.8rem;
      margin-top: 4px;
      display: block;
      color: #374151;
    }

    /* Animaci√≥n del regalo (overlay) ‚Äì ajustada para ocupar todo el ancho y centrarse */
    #gift-animation {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 50vh;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 11000;
      opacity: 0;
      transition: opacity 0.3s ease, transform 0.5s ease-out;
      font-size: 0.8rem;
      padding: 5px;
    }

    /* MARCOS ANIMADOS PARA FOTOS DE PERFIL */
    .rainbow-frame {
      border: 4px solid;
      border-image: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) 1;
      animation: rainbow-rotate 3s linear infinite;
    }

    @keyframes rainbow-rotate {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    .fire-frame {
      border: 4px solid #ff4500;
      animation: fire-pulse 1.5s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #ff4500;
    }

    @keyframes fire-pulse {
      0% { 
        border-color: #ff4500; 
        box-shadow: 0 0 20px #ff4500, inset 0 0 20px #ff6500;
      }
      50% { 
        border-color: #ff6500; 
        box-shadow: 0 0 30px #ff6500, inset 0 0 30px #ff8500;
      }
      100% { 
        border-color: #ff8500; 
        box-shadow: 0 0 40px #ff8500, inset 0 0 40px #ffa500;
      }
    }

    .electric-frame {
      border: 4px solid #00ffff;
      animation: electric-spark 0.8s ease-in-out infinite;
      box-shadow: 0 0 15px #00ffff;
    }

    @keyframes electric-spark {
      0%, 100% { 
        border-color: #00ffff; 
        box-shadow: 0 0 15px #00ffff;
      }
      25% { 
        border-color: #66ffff; 
        box-shadow: 0 0 25px #66ffff, 0 0 35px #00ccff;
      }
      50% { 
        border-color: #ffffff; 
        box-shadow: 0 0 35px #ffffff, 0 0 45px #00ffff;
      }
      75% { 
        border-color: #ccffff; 
        box-shadow: 0 0 25px #ccffff, 0 0 35px #00aaff;
      }
    }

    .galaxy-frame {
      border: 4px solid #4b0082;
      background: linear-gradient(45deg, #4b0082, #8a2be2, #9932cc, #ba55d3);
      background-size: 400% 400%;
      animation: galaxy-drift 4s ease-in-out infinite;
      position: relative;
    }

    .galaxy-frame::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffffff, #ffff00, #ffffff);
      border-radius: 50%;
      z-index: -1;
      animation: stars-twinkle 2s ease-in-out infinite alternate;
    }

    @keyframes galaxy-drift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes stars-twinkle {
      0% { opacity: 0.3; }
      100% { opacity: 0.8; }
    }

    .diamond-frame {
      border: 4px solid #b9f2ff;
      animation: diamond-sparkle 2s ease-in-out infinite;
      box-shadow: 0 0 20px #b9f2ff;
      position: relative;
    }

    .diamond-frame::before {
      content: '‚ú®';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite;
    }

    .diamond-frame::after {
      content: 'üíé';
      position: absolute;
      bottom: -10px;
      left: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite reverse;
    }

    @keyframes diamond-sparkle {
      0%, 100% { 
        border-color: #b9f2ff; 
        box-shadow: 0 0 20px #b9f2ff;
      }
      50% { 
        border-color: #ffffff; 
        box-shadow: 0 0 30px #ffffff, 0 0 40px #b9f2ff;
      }
    }

    @keyframes sparkle-rotate {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.2); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* Aplicar marcos al perfil */
    #profile-frame.rainbow { 
      border: 4px solid;
      border-image: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet) 1;
      animation: rainbow-rotate 3s linear infinite;
    }

    #profile-frame.fire { 
      border: 4px solid #ff4500;
      animation: fire-pulse 1.5s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #ff4500;
    }

    #profile-frame.electric { 
      border: 4px solid #00ffff;
      animation: electric-spark 0.8s ease-in-out infinite;
      box-shadow: 0 0 15px #00ffff;
    }

    #profile-frame.galaxy { 
      border: 4px solid #4b0082;
      background: linear-gradient(45deg, #4b0082, #8a2be2, #9932cc, #ba55d3);
      background-size: 400% 400%;
      animation: galaxy-drift 4s ease-in-out infinite;
    }

    #profile-frame.galaxy::before {
      content: '';
      position: absolute;
      top: -4px;
      left: -4px;
      right: -4px;
      bottom: -4px;
      background: linear-gradient(45deg, #ffffff, #ffff00, #ffffff);
      border-radius: 50%;
      z-index: -1;
      animation: stars-twinkle 2s ease-in-out infinite alternate;
    }

    #profile-frame.diamond { 
      border: 4px solid #b9f2ff;
      animation: diamond-sparkle 2s ease-in-out infinite;
      box-shadow: 0 0 20px #b9f2ff;
    }

    #profile-frame.diamond::before {
      content: '‚ú®';
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite;
    }

    #profile-frame.diamond::after {
      content: 'üíé';
      position: absolute;
      bottom: -10px;
      left: -10px;
      font-size: 16px;
      animation: sparkle-rotate 3s linear infinite reverse;
    }

    /* Nuevos marcos */
    .neon-frame {
      border: 4px solid #00ff88;
      animation: neon-glow 2s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
    }

    @keyframes neon-glow {
      0% { 
        border-color: #00ff88; 
        box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
      }
      100% { 
        border-color: #00ffff; 
        box-shadow: 0 0 30px #00ffff, inset 0 0 30px #00ffff;
      }
    }

    .royal-frame {
      border: 4px solid #ffd700;
      animation: royal-shine 3s ease-in-out infinite;
      box-shadow: 0 0 25px #ffd700;
      position: relative;
    }

    .royal-frame::before {
      content: 'üëë';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      animation: crown-bounce 2s ease-in-out infinite;
    }

    @keyframes royal-shine {
      0%, 100% { 
        border-color: #ffd700; 
        box-shadow: 0 0 25px #ffd700;
      }
      50% { 
        border-color: #ffed4e; 
        box-shadow: 0 0 35px #ffed4e, 0 0 45px #ffd700;
      }
    }

    @keyframes crown-bounce {
      0%, 100% { transform: translateX(-50%) translateY(0px); }
      50% { transform: translateX(-50%) translateY(-5px); }
    }

    /* Aplicar nuevos marcos al perfil */
    #profile-frame.neon { 
      border: 4px solid #00ff88;
      animation: neon-glow 2s ease-in-out infinite alternate;
      box-shadow: 0 0 20px #00ff88, inset 0 0 20px #00ff88;
    }

    #profile-frame.royal { 
      border: 4px solid #ffd700;
      animation: royal-shine 3s ease-in-out infinite;
      box-shadow: 0 0 25px #ffd700;
    }

    #profile-frame.royal::before {
      content: 'üëë';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      animation: crown-bounce 2s ease-in-out infinite;
    }

    #gift-animation.show {
      opacity: 1;
      animation: slideUpGift 0.8s ease-out;
      /* Ajustamos la duraci√≥n y el efecto */
    }

    @keyframes slideUpGift {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    /* Fondo del regalo para ocupar toda la pantalla */
    #gift-animation::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      /* Fondo semitransparente */
      pointer-events: none;
      z-index: -1;
    }

    /* Estilos para regalos fuertes */
    .gift-strong {
      width: 100%;
      /* Ocupa todo el ancho */
      max-width: 80%;
      /* Para que tenga un margen en pantallas peque√±as */
      background: linear-gradient(135deg, #ff57a8, #7659ff);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
      font-size: 1.5rem;
      color: #fff;
      text-align: center;
    }

    #gift-animation::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
      pointer-events: none;
    }


    #story-blocked-modal {
      position: fixed;
      inset: 0;
      background-color: rgba(255, 255, 255, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    /* ---------- NUEVA SECCI√ìN: Estilos para Computadora ---------- */
    @media (min-width: 1024px) {
      body.desktop {
        background-color: #ffffff;
        font-family: 'Nunito', sans-serif;
      }

      #bottom-nav {
        background-color: rgba(255, 255, 255, 0.9);
      }

      /* Hacer las im√°genes de autores destacados circulares en desktop */
      #featured-authors .story-card img {
        border-radius: 50%;
        width: 160px;
        height: 160px;
        object-fit: cover;
      }
    }

    /* ----------------- NUEVA SECCI√ìN: Banner ApkPure ----------------- */
    #apk-banner {
      position: relative;
      background: #f0f4f8;
      border: 2px solid #58CC02;
      border-radius: 8px;
      padding: 16px;
      margin: 24px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #apk-banner .floating-bubble {
      position: absolute;
      top: -20px;
      right: -20px;
      width: 60px;
      height: 60px;
      background: rgba(88, 204, 2, 0.2);
      border-radius: 50%;
      animation: float 5s infinite ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #58CC02;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0);
      }

      50% {
        transform: translate(-10px, 10px);
      }

      100% {
        transform: translate(0, 0);
      }
    }

    /* NUEVA FUNCI√ìN: Bot√≥n de descarga de historia para lectura offline */
    #download-story-btn {
      cursor: pointer;
    }
  </style>
  <link rel="stylesheet" href="stories.css">
  <script>
    /*********************** BLOQUEO DE ACCESO EN COMPUTADORAS (M√≥vil obligatorio) ***********************/
    function esDispositivoMovil() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    /*********************** MODO OFFLINE ***********************/
    window.addEventListener('offline', function() {
      document.body.innerHTML = `
        <div id="offline-modal">
          <img src="https://ideogram.ai/assets/image/lossless/response/ZL-_GzzNQdy7CzioYPtDHg" alt="Sin conexi√≥n">
        </div>`;
    });
    window.addEventListener('online', function() {
      location.reload();
    });
    /* TEMA PERMANENTE EN MODO CLARO */
    function setLightTheme() {
      const bg = "#ffffff";
      const fontColor = "#000000";
      document.body.style.backgroundColor = bg;
      document.body.style.color = fontColor;
      updateSectionThemes(bg, fontColor);
      const bottomNav = document.getElementById('bottom-nav');
      if (bottomNav) {
        bottomNav.style.backgroundColor = "rgba(255,255,255,0.9)";
      }
    }

    function updateSectionThemes(bg, fontColor) {
      const sections = [
        "search-view",
        "profile-view",
        "story-detail-modal",
        "story-creation-view",
        "story-details-view",
        "story-edit-view",
        "profile-edit-modal",
        "author-profile-modal",
        "support-modal",
        "followers-modal",
        "following-modal",
        "notifications-modal",
        "blocked-error-modal",
        "gift-drawer",
        "story-blocked-modal",
        "chapter-read-modal"
      ];
      sections.forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
          el.style.backgroundColor = bg;
          el.style.color = fontColor;
        }
      });
      
      // Actualizar live-container si existe
      const liveContainers = document.querySelectorAll('.live-container');
      liveContainers.forEach(function(el) {
        el.style.backgroundColor = bg;
      });
    }
    window.addEventListener('load', setLightTheme);
    window.addEventListener('load', function() {
      if (window.innerWidth >= 1024) {
        document.body.classList.add('desktop');
      }
    });

    function organizeCarousels() {
      const carouselIds = ['new-releases', 'top10', 'popular', 'terror-stories'];
      carouselIds.forEach(id => {
        const carousel = document.getElementById(id);
        if (carousel) {
          carousel.classList.remove('grid', 'grid-cols-2', 'md:grid-cols-4');
          carousel.classList.add('flex', 'space-x-4', 'overflow-x-auto');
        }
      });
    }
    window.addEventListener('load', organizeCarousels);
    document.addEventListener("DOMContentLoaded", function() {
      const savedLang = localStorage.getItem("selectedLanguage");
      if (savedLang) {
        currentLanguage = savedLang;
        updateTranslations();
      } else {
        const languageModal = document.getElementById("language-modal");
        if (languageModal) {
          languageModal.style.display = "flex";
        }
      }
    });

    function updateChapterUI() {
      const chapterSection = document.getElementById('chapter-section');
      if (!chapterSection) return;
      if (storyTypeSelected === 'cuento') {
        chapterSection.style.display = 'none';
      } else if (storyTypeSelected === 'historia_completa') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Cap√≠tulo';
        });
      } else if (storyTypeSelected === 'novela') {
        chapterSection.style.display = 'block';
        document.querySelectorAll('.chapter-label').forEach(label => {
          label.textContent = 'Saga';
        });
      }
    }

    function selectStoryType(type) {
      storyTypeSelected = type;
      document.getElementById('story-creation-view').classList.add('hidden');
      document.getElementById('story-details-view').classList.remove('hidden');
      updateChapterUI();
    }
    /*************** FUNCIONES PARA COMPRA DE MONEDAS (ELIMINADAS) ***************/
    // Se han removido las funciones openBuyCoinsModal(), closeBuyCoinsModal() y buyCoins()
    /*************** FIN FUNCIONES DE COMPRA DE MONEDAS ***************/
    /*********************** LAS FUNCIONES DE HISTORIAS EST√ÅN DEFINIDAS M√ÅS ADELANTE CON AWS S3 ***********************/
    /*************** FIN NUEVAS FUNCIONES ***********************/
  </script>
</head>

<!-- MODAL DE NOTIFICACIONES -->
<div id="notifications-modal" class="fixed inset-0 z-[9999] hidden bg-white">
  <div class="w-full h-full flex flex-col">
    <!-- Header del modal -->
    <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <button onclick="closeNotifications()" class="text-gray-700 hover:text-[#FE2C55] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Notificaciones</h2>
        </div>
      </div>
    </div>
    <!-- Lista de notificaciones -->
    <div class="flex-1 overflow-y-auto p-4">
      <div id="notifications-list" class="space-y-4"></div>
    </div>
  </div>
</div>


<!-- MODAL DE ERROR PARA USUARIO BLOQUEADO -->
<div id="blocked-error-modal" class="fixed inset-0 z-50 hidden" style="z-index: 9999;">
  <button onclick="closeBlockedErrorModal()">Volver</button>
  <img src="https://ideogram.ai/assets/image/lossless/response/0-Re3lMzQ6mmstIxlRxb4Q" alt="Usuario bloqueado">
</div>

<!-- MODAL DE LISTA DE SEGUIDORES -->
<div id="followers-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-white" style="z-index: 9999;">
  <div class="h-full flex flex-col">
    <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <button onclick="closeFollowersModal()" class="text-gray-700 hover:text-[#FE2C55] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Seguidores</h2>
        </div>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto p-4">
      <div id="followers-list" class="space-y-3"></div>
    </div>
  </div>
</div>

<!-- MODAL DE LISTA DE SIGUIENDO -->
<div id="following-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-white" style="z-index: 9999;">
  <div class="h-full flex flex-col">
    <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <button onclick="closeFollowingModal()" class="text-gray-700 hover:text-[#FE2C55] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <h2 class="text-xl font-bold text-gray-900">Siguiendo</h2>
        </div>
      </div>
    </div>
    <div class="flex-1 overflow-y-auto p-4">
      <div id="following-list" class="space-y-3"></div>
    </div>
  </div>
</div>



<!-- SPINNER DE CERRAR SESI√ìN -->
<div id="signout-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- SPINNER PARA PUBLICAR HISTORIA -->
<div id="story-upload-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden">
  <i class="fas fa-spinner fa-spin text-4xl" style="color:#58CC02;"></i>
</div>

<!-- PANTALLA DE CHAT EN TIEMPO REAL -->
<div id="chat-view" class="fixed inset-0 hidden bg-white text-black" style="z-index: 9999;">
  <!-- Vista de conversaciones (m√≥vil first) -->
  <div id="conversations-view" class="h-full flex flex-col">
    <!-- Header principal -->
    <div class="bg-[#FE2C55] text-white p-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <button onclick="closeChat()" class="lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <div class="flex items-center space-x-3">
          <div class="relative">
            <img id="current-user-avatar" src="" alt="" class="w-8 h-8 rounded-full">
            <div class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
          </div>
          <div class="flex flex-col">
            <h2 class="text-xl font-bold">Chat</h2>
            <span class="text-sm text-red-100">Online</span>
          </div>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="openNewMessage()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <div class="relative">
          <button onclick="toggleChatOptions()" class="bg-white bg-opacity-20 p-2 rounded-full hover:bg-opacity-30 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </button>
          <div id="chat-options-menu" class="hidden absolute right-0 top-12 bg-white rounded-lg shadow-lg py-2 w-48 z-10">
            <button onclick="markAllAsRead()" class="w-full px-4 py-2 text-left text-gray-700 hover:bg-gray-100">Mark all as read</button>
            <button onclick="clearAllChats()" class="w-full px-4 py-2 text-left text-red-600 hover:bg-gray-100">Clear all chats</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de b√∫squeda -->
    <div class="p-4 border-b border-gray-200">
      <div class="relative">
        <input type="text" id="search-conversations" placeholder="Buscar conversaciones..." 
               class="w-full p-3 pl-10 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"
               oninput="searchConversations(this.value)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>

    <!-- Lista de conversaciones -->
    <div class="flex-1 overflow-y-auto">
      <div id="conversations-container" class="divide-y divide-gray-100">
        <!-- Las conversaciones se cargar√°n aqu√≠ -->
      </div>
      <div id="no-conversations" class="hidden flex-1 flex items-center justify-center text-gray-500 p-8">
        <div class="text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="text-lg font-medium mb-2">ÊöÇÊó†ÂØπËØù</p>
          <p class="text-sm">‰∏éÊÇ®ÊúÄÂñúÊ¨¢ÁöÑ‰ΩúËÄÖÂºÄÂßãÂØπËØù</p>
          <button onclick="openNewMessage()" class="mt-4 bg-[#FE2C55] text-white px-6 py-2 rounded-full hover:bg-red-600 transition">
          </button>
        </div>
      </div>
    </div>

    
  </div>

  <!-- Vista de chat individual -->
  <div id="individual-chat-view" class="hidden h-full flex flex-col">
    <!-- Header del chat -->
    <div class="bg-[#FE2C55] text-white p-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <button onclick="backToConversations()" class="lg:hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </button>
        <div class="relative">
          <img id="chat-user-avatar" src="" alt="" class="w-10 h-10 rounded-full">
          <div id="chat-user-online-indicator" class="hidden absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
        </div>
        <div>
          <h3 id="chat-user-name" class="font-bold"></h3>
          <p id="chat-user-status" class="text-sm text-red-100">Last active 5 minutes ago</p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <button onclick="makeVoiceCall(currentChatUserId)" class="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
          </svg>
        </button>
        <button onclick="openUserProfile(currentChatUserId)" class="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </button>
        <button onclick="toggleChatMenu()" class="p-2 bg-white bg-opacity-20 rounded-full hover:bg-opacity-30 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Men√∫ del chat -->
    <div id="chat-menu" class="hidden bg-red-50 p-3 border-b border-red-200">
      <div class="flex flex-wrap gap-2">
        <button onclick="clearCurrentChat()" class="bg-white px-3 py-1 rounded-full text-sm text-gray-700 hover:bg-gray-100 transition">
          Clear chat
        </button>
        <button onclick="deleteConversation(currentChatUserId)" class="bg-red-100 px-3 py-1 rounded-full text-sm text-red-700 hover:bg-red-200 transition">
        Delete chat
        </button>
        <button onclick="blockUser(currentChatUserId)" class="bg-red-100 px-3 py-1 rounded-full text-sm text-red-700 hover:bg-red-200 transition">
          Block user
        </button>
      </div>
    </div>

    <!-- √Årea de mensajes -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50" id="messages-container">
      <!-- Los mensajes se cargar√°n aqu√≠ -->
    </div>

    <!-- Indicador de escritura -->
    <div id="typing-indicator" class="hidden px-4 py-2 text-sm text-gray-500">
      <div class="flex items-center space-x-2">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
        <span id="typing-user-name">Usuario</span>
        <span>est√° escribiendo...</span>
      </div>
    </div>

    <!-- Input de mensaje -->
    <div class="p-4 bg-white border-t border-gray-200">
      <div class="flex items-end space-x-3">
        <button onclick="toggleVoiceMessage()" class="p-3 text-gray-500 hover:text-[#FE2C55] transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
          </svg>
        </button>
        <button onclick="attachFile()" class="p-3 text-gray-500 hover:text-[#FE2C55] transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
        </button>
        <div class="flex-1 relative">
          <textarea id="message-input" placeholder="Escribe un mensaje..." 
                   class="w-full p-3 pr-12 border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] resize-none max-h-32"
                   rows="1"
                   oninput="handleMessageInput(this)"
                   onkeypress="handleKeyPress(event)"></textarea>
          <button onclick="toggleEmojiPicker()" class="absolute right-3 bottom-3 text-gray-500 hover:text-[#FE2C55] transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </button>
        </div>
        <button onclick="sendMessage()" id="send-button" class="bg-[#FE2C55] text-white p-3 rounded-full hover:bg-red-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
      
      <!-- Emoji picker -->
      <div id="emoji-picker" class="hidden absolute bottom-20 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 w-80 z-10">
        <div class="grid grid-cols-8 gap-2">
          <button onclick="insertEmoji('üòÄ')" class="p-2 hover:bg-gray-100 rounded">üòÄ</button>
          <button onclick="insertEmoji('üòÇ')" class="p-2 hover:bg-gray-100 rounded">üòÇ</button>
          <button onclick="insertEmoji('‚ù§Ô∏è')" class="p-2 hover:bg-gray-100 rounded">‚ù§Ô∏è</button>
          <button onclick="insertEmoji('üëç')" class="p-2 hover:bg-gray-100 rounded">üëç</button>
          <button onclick="insertEmoji('üëè')" class="p-2 hover:bg-gray-100 rounded">üëè</button>
          <button onclick="insertEmoji('üî•')" class="p-2 hover:bg-gray-100 rounded">üî•</button>
          <button onclick="insertEmoji('‚ú®')" class="p-2 hover:bg-gray-100 rounded">‚ú®</button>
          <button onclick="insertEmoji('üéâ')" class="p-2 hover:bg-gray-100 rounded">üéâ</button>
          <button onclick="insertEmoji('üíï')" class="p-2 hover:bg-gray-100 rounded">üíï</button>
          <button onclick="insertEmoji('ü•∞')" class="p-2 hover:bg-gray-100 rounded">ü•∞</button>
          <button onclick="insertEmoji('üòç')" class="p-2 hover:bg-gray-100 rounded">üòç</button>
          <button onclick="insertEmoji('ü§î')" class="p-2 hover:bg-gray-100 rounded">ü§î</button>
          <button onclick="insertEmoji('üòé')" class="p-2 hover:bg-gray-100 rounded">üòé</button>
          <button onclick="insertEmoji('üôå')" class="p-2 hover:bg-gray-100 rounded">üôå</button>
          <button onclick="insertEmoji('üí™')" class="p-2 hover:bg-gray-100 rounded">üí™</button>
          <button onclick="insertEmoji('üéä')" class="p-2 hover:bg-gray-100 rounded">üéä</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Input oculto para archivos -->
<input type="file" id="file-input" class="hidden" onchange="handleFileAttachment(event)" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"></input>

<!-- SELECTOR DE MARCOS ANIMADOS A PANTALLA COMPLETA -->
<div id="frame-selector-modal" class="fixed inset-0 bg-gradient-to-b from-white to-[#f9f9f9] text-black overflow-y-auto hidden z-50">
  <div class="p-6 max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
      <button onclick="closeFrameSelector()" class="text-[#FE2C55] flex items-center hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span>ËøîÂõû</span>
      </button>
    </div>

    <!-- T√≠tulo -->
    <h2 class="text-3xl font-bold mb-4 text-black text-center">Áç®ÂÆ∂ÂãïÁï´È†≠ÂÉèÊ°Ü</h2>
    <p class="text-center text-gray-600 mb-8">‰ΩøÁî®Áã¨ÁâπÁöÑÊïàÊûúÂÆöÂà∂ÊÇ®ÁöÑ‰∏™‰∫∫ËµÑÊñôÔºåÂÖ∂‰ªñÁî®Êà∑Â∞ÜËÉΩÂ§üÁúãÂà∞</p>
    
    <!-- Grid de marcos expandido -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      <!-- Sin marco (gratis) -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('none', 0)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gray-200 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <span class="text-lg font-semibold">ÁÑ°Ê°ÜÊû∂</span>
        <p class="text-sm text-gray-500 mt-2">Âü∫Êú¨ËµÑÊñô</p>
        <div class="mt-3 bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-bold">
          Free
        </div>
      </div>
      
      <!-- Marco Arco√≠ris -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('rainbow', 25)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full rainbow-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-400 to-pink-400"></div>
        </div>
        <span class="text-lg font-semibold">ÂΩ©Ëôπ</span>
        <p class="text-sm text-gray-500 mt-2">Ëâ≤ÂΩ©ÊïàÊûú</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 25
        </div>
      </div>
      
      <!-- Marco de Fuego -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('fire', 35)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full fire-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-red-500 to-orange-500"></div>
        </div>
        <span class="text-lg font-semibold">Fuego</span>
        <p class="text-sm text-gray-500 mt-2">Energ√≠a ardiente</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 35
        </div>
      </div>
      
      <!-- Marco El√©ctrico -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('electric', 30)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full electric-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-400 to-cyan-400"></div>
        </div>
        <span class="text-lg font-semibold">El√©ctrico</span>
        <p class="text-sm text-gray-500 mt-2">Poder el√©ctrico</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 30
        </div>
      </div>
      
      <!-- Marco Galaxia -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('galaxy', 50)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full galaxy-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600"></div>
        </div>
        <span class="text-lg font-semibold">Galaxia</span>
        <p class="text-sm text-gray-500 mt-2">Cosmos infinito</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 50
        </div>
      </div>
      
      <!-- Marco Diamante -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('diamond', 75)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full diamond-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-200 to-blue-300"></div>
        </div>
        <span class="text-lg font-semibold">Diamante</span>
        <p class="text-sm text-gray-500 mt-2">Lujo premium</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 75
        </div>
      </div>

      <!-- Marco Ne√≥n -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('neon', 40)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full neon-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-400 to-teal-400"></div>
        </div>
        <span class="text-lg font-semibold">Ne√≥n</span>
        <p class="text-sm text-gray-500 mt-2">Brillo nocturno</p>
        <div class="mt-3 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">ü™ô</span> 40
        </div>
      </div>

      <!-- Marco Real -->
      <div class="frame-option text-center cursor-pointer p-6 rounded-2xl bg-white shadow-lg hover:shadow-xl transition-all transform hover:scale-105" onclick="selectFrame('royal', 100)">
        <div class="w-24 h-24 mx-auto mb-4 rounded-full royal-frame flex items-center justify-center relative">
          <div class="w-20 h-20 rounded-full bg-gradient-to-r from-yellow-400 to-amber-500"></div>
        </div>
        <span class="text-lg font-semibold">Real</span>
        <p class="text-sm text-gray-500 mt-2">Elegancia dorada</p>
        <div class="mt-3 bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center justify-center">
          <span class="mr-1">üëë</span> 100
        </div>
      </div>
    </div>

    <!-- Secci√≥n de cambio de nombre -->
    <div class="mt-8 p-6 bg-blue-50 rounded-xl">
      <h3 class="font-bold text-blue-800 mb-3 text-center">üéØ Funciones Especiales</h3>
      <div class="flex flex-col md:flex-row gap-4">
        <button onclick="showFrameHistory()" class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition flex items-center justify-center">
          <span class="mr-2">üìú</span>
          <span>Ver Marcos Comprados</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL PARA NUEVO MENSAJE -->
<div id="new-message-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center" style="z-index: 10000;">
  <div class="bg-white rounded-xl p-6 w-96 max-w-[90vw] max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold">New Message</h3>
      <button onclick="closeNewMessage()" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">Search author:</label>
        <input type="text" id="author-search" placeholder="Author name..." 
               class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"
               oninput="searchAuthors(this.value)">
      </div>
      
      <div id="authors-results" class="max-h-48 overflow-y-auto border border-gray-200 rounded-xl hidden">
        <!-- Search results for authors -->
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Message:</label>
        <textarea id="new-message-text" placeholder="Write your message..." 
                  class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] resize-none" 
                  rows="3"></textarea>
      </div>
      
      <div class="flex space-x-3">
        <button onclick="closeNewMessage()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl hover:bg-gray-300 transition">
          Cancel
        </button>
        <button onclick="sendNewMessage()" class="flex-1 bg-[#FE2C55] text-white py-3 rounded-xl hover:bg-red-600 transition">
          Send
        </button>
      </div>
    </div>
  </div>
</div>


<!-- MODAL DE HISTORIA BLOQUEADA -->
<div id="story-blocked-modal">
  <img src="https://ideogram.ai/g/hJJQb0VZSQicLDiADD7CZQ/3" alt="Historia Bloqueada" class="w-3/4 h-auto">
</div>

<body class="bg-white font-sans text-[#161823]">
  
  <!-- Google Translate (oculto) -->
  <div id="google_translate_element" style="display:none !important; visibility:hidden !important; position:absolute; left:-9999px;"></div>
  
  <div id="auth-form" class="w-full h-screen flex flex-col justify-center p-6" style="display: flex;">
    <!-- Centered title -->
    <h1 id="auth-title" class="text-4xl font-bold text-center mb-8 text-[#FE2C55]">Zenvio</h1>
    <!-- Form takes full available width -->
    <form id="authForm" class="w-full space-y-6 max-w-lg mx-auto">
      <input
        id="emailInput"
        type="email"
        placeholder="Email address"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <input
        id="passwordInput"
        type="password"
        placeholder="Password"
        class="w-full p-4 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-[#FE2C55] transition"
        required
      >
      <button
        id="submitButton"
        type="submit"
        class="w-full bg-[#FE2C55] text-white p-4 font-bold rounded-full transform hover:scale-105 transition"
      >
        Sign In
      </button>
    </form>
    <!-- Links and toggle below the form -->
    <div class="mt-6 text-center space-y-4 max-w-lg mx-auto">
      <a
        href="#"
        onclick="resetPassword()"
        class="block text-sm text-gray-600 hover:text-[#FE2C55] transition"
      >
        Forgot your password?
      </a>
      <button
        id="toggleAuth"
        class="block text-sm font-medium text-[#FE2C55] hover:text-[#25F4EE] transition"
      >
        Don't have an account? Sign up
      </button>
      <div id="authError" class="mt-4 text-red-500 hidden"></div>
    </div>
  </div>
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>

<!-- APLICACI√ìN PRINCIPAL ESTILO TIKTOK (MODO CLARO) -->
<div id="main-app" class="h-screen flex flex-col bg-white font-sans text-black" style="display: none;">
  <!-- TOP BAR WITH NAME + ICONS -->
  <div id="top-navbar" class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 z-50 bg-white">
    <h1 id="app-name" class="text-2xl font-bold text-[#161823]">BeaBoo</h1>
    <div class="flex items-center space-x-4">
      <button onclick="openCalendar()" aria-label="Calendario" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
      </button>
      <button onclick="openMessages()" aria-label="Mensajes" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span id="unread-messages-count" class="hidden absolute -top-2 -right-2 bg-[#FE2C55] text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
      </button>
      <button onclick="openNotifications()" aria-label="Notificaciones" class="relative w-6 h-6 text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-full h-full" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 8a6 6 0 10-12 0c0 7-3 9-3 9h18s-3-2-3-9" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M13.73 21a2 2 0 01-3.46 0" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto pb-20" id="scrollable-content">
    <!-- Carrusel de historias de autores seguidos -->
<section id="stories-carousel" class="overflow-x-auto" style="margin-top: 0; padding-top: 8px;">
  <div class="flex space-x-4 px-4">
    <div id="following-stories" class="flex space-x-4"></div>
  </div>
</section>

<!-- Historias -->
    <section class="stories-container" style="margin-top: 0;">
        <div class="stories">
            <div class="story add-story" id="add-story-btn">
                <div class="image-container">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="username">Tu historia</div>
            </div>
            <div id="stories">
                <!-- Las historias se cargar√°n aqu√≠ -->
            </div>
        </div>
    </section>
    
    <!-- SECCIONES DE CONTENIDO -->
    <div class="p-6" style="padding-top: 0;">

<section id="new-releases-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="new-releases-title" class="text-2xl font-bold text-[#FE2C55]">New Releases</h2>
      </div>
      <div id="new-releases" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
</section>

<script>
function loadFollowingStories() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  firebase.database().ref('following/' + user.uid).once('value').then(followingSnap => {
    const followingStoriesDiv = document.getElementById('following-stories');
    followingStoriesDiv.innerHTML = '';

    followingSnap.forEach(following => {
      const followedUserId = following.key;
      
      firebase.database().ref('users/' + followedUserId).once('value').then(userSnap => {
        const userData = userSnap.val();
        
        // Ê£ÄÊü•ÊúÄËøëÊõ¥Êñ∞ÔºàÊúÄËøë24Â∞èÊó∂Ôºâ
        firebase.database().ref('stories').orderByChild('userId').equalTo(followedUserId).once('value').then(storiesSnap => {
          let hasNewContent = false;
          let latestStoryId = null;
          
          storiesSnap.forEach(storySnap => {
            const story = storySnap.val();
            const lastUpdate = story.lastUpdate || story.createdAt;
            if (Date.now() - lastUpdate < 24 * 60 * 60 * 1000) {
              hasNewContent = true;
              latestStoryId = storySnap.key;
            }
          });

          const storyDiv = document.createElement('div');
          storyDiv.className = 'flex flex-col items-center cursor-pointer';
          
          const imageContainer = document.createElement('div');
          imageContainer.className = `w-16 h-16 rounded-full overflow-hidden ${hasNewContent ? 'border-2 border-[#FE2C55]' : 'border border-gray-300'}`;
          
          if (hasNewContent) {
            imageContainer.classList.add('animate-pulse');
          }
          
          imageContainer.innerHTML = `
            <img src="${userData.profileImage || 'https://via.placeholder.com/150'}" 
                 alt="${userData.username}" 
                 class="w-full h-full object-cover"
                 onclick="openLatestStory('${followedUserId}', '${latestStoryId}')">
          `;
          
          storyDiv.appendChild(imageContainer);
          
          const username = document.createElement('span');
          username.className = 'text-xs mt-1 truncate w-16 text-center';
          username.textContent = userData.username;
          storyDiv.appendChild(username);
          
          followingStoriesDiv.appendChild(storyDiv);
        });
      });
    });
  });
}

function openLatestStory(authorId, storyId) {
  if (storyId) {
    openStoryDetail({id: storyId});
  } else {
    openAuthorProfile(authorId);
  }
}

// È°µÈù¢Âä†ËΩΩÂíåÁî®Êà∑Áä∂ÊÄÅÂèòÂåñÊó∂Ë∞ÉÁî®loadFollowingStories
document.addEventListener('DOMContentLoaded', loadFollowingStories);
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadFollowingStories();
  }
});
</script>

<style>
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.animate-pulse {
  animation: pulse 2s infinite;
}

#stories-carousel {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

#stories-carousel::-webkit-scrollbar {
  display: none;
}
</style>

    <section id="top10-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="top10-title" class="text-2xl font-bold text-[#FE2C55]">Top 10</h2>
      </div>
      <div id="top10" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="popular-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="popular-title" class="text-2xl font-bold text-[#FE2C55]">Most Popular</h2>
      </div>
      <div id="popular" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="terror-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="terror-title" class="text-2xl font-bold text-[#FE2C55]">Featured Horror Stories</h2>
      </div>
      <div id="terror-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="trending-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="trending-title" class="text-2xl font-bold text-[#FE2C55]">Trending Stories</h2>
      </div>
      <div id="trending-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="mystery-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="mystery-title" class="text-2xl font-bold text-[#FE2C55]">Popular in Mystery</h2>
      </div>
      <div id="mystery-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="adventure-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="adventure-title" class="text-2xl font-bold text-[#FE2C55]">Best in Adventure</h2>
      </div>
      <div id="adventure-stories" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </section>

    <section id="suggested-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="suggested-title" class="text-2xl font-bold" style="color: #FE2C55 !important;">Recommended for You</h2>
      </div>
      <div id="suggested-stories" class="flex space-x-4 overflow-x-auto"></div>
    </section>

    <section id="featured-authors-section" class="mb-10">
      <div class="flex justify-between items-center mb-4">
        <h2 id="featured-authors-title" class="text-2xl font-bold" style="color: #FE2C55 !important;">Featured Authors</h2>
      </div>
      <div id="featured-authors" class="flex space-x-4 overflow-x-auto px-2"></div>
    </section>
    </div>
  </div>

  <!-- BOTTOM NAVIGATION TIKTOK STYLE -->
  <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 border-t border-gray-200 bg-white transition-transform duration-300">
    <div class="grid grid-cols-5 gap-2 p-3">
      <button onclick="openHome()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2L2 8v10a1 1 0 001 1h5v-5h4v5h5a1 1 0 001-1V8l-8-6z" />
        </svg>
        <span class="text-xs">Home</span>
      </button>
      <button onclick="openSearch()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8" stroke-linecap="round" stroke-linejoin="round" />
          <line x1="21" y1="21" x2="16.65" y2="16.65" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        <span class="text-xs">Search</span>
      </button>
      <button onclick="openCommunity()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
          <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
        </svg>
        <span class="text-xs">Community</span>
      </button>
      <button onclick="openCreatorHub()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span class="text-xs">Create</span>
      </button>
      <button onclick="openProfile()" class="flex flex-col items-center text-[#161823] hover:text-[#FE2C55] transition">
        <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 10a4 4 0 100-8 4 4 0 000 8zM2 18a8 8 0 1116 0H2z" clip-rule="evenodd" />
        </svg>
        <span class="text-xs">Profile</span>
      </button>
    </div>
  </div>

  <style>
    .transition { transition: all 0.2s ease-in-out; }
    #bottom-nav.hide { transform: translateY(100%); }
  </style>

  <script>
    let lastScrollTop = 0;
    const bottomNav = document.getElementById("bottom-nav");
    const scrollArea = document.getElementById("scrollable-content");

    scrollArea.addEventListener("scroll", () => {
      const scrollTop = scrollArea.scrollTop;
      if (scrollTop > lastScrollTop) {
        bottomNav.classList.add("hide");
      } else {
        bottomNav.classList.remove("hide");
      }
      lastScrollTop = scrollTop;
    });
  </script>
</div>



<!-- VISTA CREATOR HUB (NUEVA SECCI√ìN DE CREACI√ìN) -->
<div id="creator-hub-view" class="fixed inset-0 bg-gradient-to-b from-white to-gray-50 text-black hidden z-50 overflow-hidden">
  <div class="h-full flex flex-col">
    <!-- Header fijo -->
    <div class="flex-shrink-0 p-4 bg-white border-b border-gray-200">
      <button onclick="closeCreatorHub()" class="text-[#FE2C55] flex items-center hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span>Back</span>
      </button>
    </div>

    <!-- Contenido con scroll -->
    <div class="flex-1 overflow-y-auto">
      <div class="p-4 pb-24">
        <!-- Header -->
        <div class="text-center mb-8">
          <h1 class="text-3xl font-bold text-[#FE2C55] mb-2">Âàõ‰ΩúËÄÖ‰∏≠ÂøÉ</h1>
          <p class="text-gray-600">Âàõ‰ΩúÁ≤æÂΩ©ÂÜÖÂÆπÔºå‰∏éÁ§æÂå∫ÂàÜ‰∫´</p>
        </div>

        <!-- Grid de opciones de creaci√≥n -->
        <div class="grid grid-cols-1 gap-6 max-w-2xl mx-auto">
          
          <!-- Crear Historia -->
          <div onclick="openStoryCreation()" class="group cursor-pointer">
            <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
              <div class="flex items-center">
                <div class="w-16 h-16 mr-4 bg-gradient-to-br from-[#FE2C55] to-[#ff6b7a] rounded-full flex items-center justify-center flex-shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="text-xl font-bold mb-2 text-black">ÂàõÂª∫ÊïÖ‰∫ã</h3>
                  <p class="text-gray-600 mb-3">Êí∞ÂÜôÂπ∂ÂèëÂ∏ÉÊÇ®ÁöÑÂéüÂàõÊïÖ‰∫ã</p>
                  <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                    <span class="font-medium mr-2">Start</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Crear Nota en Comunidad -->
          <div onclick="openNoteCreation()" class="group cursor-pointer">
            <div class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
              <div class="flex items-center">
                <div class="w-16 h-16 mr-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <h3 class="text-xl font-bold mb-2 text-black">Crear Nota</h3>
                  <p class="text-gray-600 mb-3">Comparte pensamientos e im√°genes con la comunidad</p>
                  <div class="flex items-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                    <span class="font-medium mr-2">Comenzar</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de estad√≠sticas del creador -->
        <div class="mt-12 bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] rounded-2xl p-6 text-white max-w-2xl mx-auto">
          <div class="text-center">
            <h3 class="text-xl font-bold mb-4">üí° Estad√≠sticas del Creador</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold mb-1" id="creator-stories-count">0</div>
                <div class="text-sm opacity-90">Historias creadas</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold mb-1" id="creator-notes-count">0</div>
                <div class="text-sm opacity-90">Notas publicadas</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Community View -->
<div id="community-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">
    <!-- Back Button -->
    <button onclick="closeCommunity()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Back</span>
    </button>

    <!-- Navigation Tabs -->
    <div class="flex border-b border-gray-200 mb-4">
      <button onclick="switchCommunityTab('feed')" class="flex-1 py-2 text-center text-[#FE2C55] border-b-2 border-[#FE2C55]" id="feed-tab">
        Feed
      </button>
      <button onclick="switchCommunityTab('photos'); loadPhotos();" class="flex-1 py-2 text-center text-gray-500" id="photos-tab">
        Photos
      </button>
    </div>
    
    <!-- Photos Section -->
    <div id="photos-feed" class="hidden">
      <div class="grid grid-cols-2 gap-2">
        <!-- Photos will be loaded dynamically here -->
      </div>
    </div>

    <!-- Notes Feed -->
    <div id="notes-feed" class="space-y-4">
      <!-- Notes will be loaded dynamically here -->
    </div>

    <!-- Add Note Form -->
    <div id="add-note-form" class="hidden">
      <textarea id="note-content" placeholder="What would you like to share? (200 characters max)" maxlength="200" class="w-full p-4 border border-gray-200 rounded-xl resize-none h-32 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]"></textarea>
<div id="char-counter" class="text-sm text-gray-500 mt-2">200 characters remaining</div>
<script>
document.getElementById('note-content').addEventListener('input', function() {
  const remaining = 200 - this.value.length;
  document.getElementById('char-counter').textContent = remaining + ' characters remaining';
  if (remaining <= 20) {
    document.getElementById('char-counter').classList.add('text-[#FE2C55]');
  } else {
    document.getElementById('char-counter').classList.remove('text-[#FE2C55]');
  }
});
</script>
      <div class="mt-4 flex items-center space-x-4">
        <label class="flex-1 cursor-pointer bg-gray-100 p-3 rounded-xl hover:bg-gray-200 transition text-center">
          <input type="file" id="note-image" accept="image/*" class="hidden" onchange="handleNoteImagePreview(event)">
          <i class="fas fa-camera mr-2"></i>Add Photo
        </label>
        <button onclick="publishNote()" class="flex-1 bg-[#FE2C55] text-white p-3 rounded-xl font-medium">
          Post
        </button>
      </div>
      <div id="image-preview" class="mt-4 hidden">
        <img id="preview-img" class="max-h-40 rounded-lg mx-auto">
        <button onclick="removeImage()" class="mt-2 text-red-500 text-sm">
          <i class="fas fa-times mr-1"></i>Remove Photo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Search View - TikTok Style -->
<div id="search-view" class="fixed inset-0 bg-white text-black overflow-y-auto hidden z-50">
  <div class="p-4">

    <!-- Back Button -->
    <button onclick="closeSearch()" class="text-gray-800 mb-4 flex items-center font-medium hover:text-[#FE2C55] transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-search">Back</span>
    </button>

    <!-- Search Bar and Category Filter -->
    <div class="space-y-4 mb-6">
      <div class="relative">
        <input id="search-input" type="text" placeholder="Search for stories or authors" class="w-full pl-12 pr-4 py-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent text-base">
        <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </div>
      <select id="category-filter" class="w-full p-3 rounded-full bg-gray-100 text-black border border-gray-200 focus:outline-none focus:ring-2 focus:ring-[#FE2C55]">
        <option value="">All Categories</option>
        <option value="aventura">Adventure</option>
        <option value="romance">Romance</option>
        <option value="misterio">Mystery</option>
        <option value="fantasia">Fantasy</option>
        <option value="terror">Horror</option>
      </select>
    </div>

    <!-- Search Results -->
    <h2 id="search-results-title" class="text-xl font-bold mb-4 text-black">Search Results</h2>
    <div class="flex justify-around border-b border-gray-200 mb-4">
      <button data-tab="books" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55] active">
        Stories
      </button>
      <button data-tab="authors" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55]">
        Authors
      </button>
      <button data-tab="notes" class="tab-button py-2 w-1/3 text-center font-medium text-gray-500 hover:text-[#FE2C55]">
        Notes
      </button>
    </div>

    <!-- Stories Section -->
    <div id="books-section" class="block">
      <h3 id="search-books-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Stories</h3>
      <div id="search-loading" class="tiktok-loader mx-auto my-4"></div>
<div id="search-books-carousel" class="flex space-x-3 overflow-x-auto mb-6 p-1 scrollbar-hide">
        <!-- Stories will be loaded from Firebase here -->
      </div>
    </div>

    <!-- Authors Section -->
    <div id="authors-section" class="hidden">
      <h3 id="search-authors-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Authors</h3>
      <div id="search-authors-list" class="space-y-3">
        <!-- Authors will be loaded from Firebase here -->
      </div>
    </div>

    <!-- Notes Section -->
    <div id="notes-section" class="hidden">
      <h3 id="search-notes-title" class="text-base font-semibold mb-3 text-[#FE2C55]">Notes</h3>
      <div id="search-notes-list" class="space-y-3">
        <!-- Notes will be loaded from Firebase here -->
      </div>
    </div>
  </div>
</div>

<script>
  // Script para cambiar entre tabs
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      // Remover active de todos los botones
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-500');
        btn.classList.remove('text-[#FE2C55]');
      });
      
      // Agregar active al bot√≥n clickeado
      button.classList.add('active');
      button.classList.remove('text-gray-500');
      button.classList.add('text-[#FE2C55]');
      
      // Mostrar la secci√≥n correspondiente
      const tabName = button.getAttribute('data-tab');
      // Ocultar todas las secciones
      document.getElementById('books-section').classList.add('hidden');
      document.getElementById('authors-section').classList.add('hidden');
      document.getElementById('notes-section').classList.add('hidden');
      
      // Mostrar la secci√≥n seleccionada
      if (tabName === 'books') {
        document.getElementById('books-section').classList.remove('hidden');
        document.getElementById('books-section').classList.add('block');
      } else if (tabName === 'authors') {
        document.getElementById('authors-section').classList.remove('hidden');
        document.getElementById('authors-section').classList.add('block');
      } else if (tabName === 'notes') {
        document.getElementById('notes-section').classList.remove('hidden');
        document.getElementById('notes-section').classList.add('block');
      }
    });
  });

  // Simulaci√≥n de apertura del micr√≥fono
  const voiceSearchBtn = document.getElementById('voice-search-btn');
  if (voiceSearchBtn) {
    voiceSearchBtn.addEventListener('click', () => {
      document.getElementById('voice-animation-container').classList.remove('hidden');
    });
  }

  const cancelVoiceBtn = document.getElementById('cancel-voice');
  if (cancelVoiceBtn) {
    cancelVoiceBtn.addEventListener('click', () => {
      document.getElementById('voice-animation-container').classList.add('hidden');
    });
  }

  // L√≥gica de seguir autores (simulaci√≥n)
  function toggleFollow(authorId) {
    const followButton = document.getElementById('follow-' + authorId);
    if (followButton.classList.contains('bg-[#FE2C55]')) {
      followButton.classList.remove('bg-[#FE2C55]');
      followButton.classList.add('bg-gray-200');
      followButton.textContent = 'Seguir';
    } else {
      followButton.classList.remove('bg-gray-200');
      followButton.classList.add('bg-[#FE2C55]');
      followButton.textContent = 'Dejar de seguir';
    }
  }

  // Ejemplo de como cargar autores desde Firebase
  function loadAuthors(authors) {
    const authorsList = document.getElementById('search-authors-list');
    authors.forEach(author => {
      const authorItem = document.createElement('div');
      authorItem.classList.add('flex', 'items-center', 'justify-between', 'p-4', 'bg-gray-100', 'rounded-lg', 'shadow-sm');
      authorItem.innerHTML = `
        <div class="flex items-center">
          <img src="${author.photoUrl}" alt="${author.name}" class="h-12 w-12 rounded-full mr-4">
          <span class="font-semibold text-black">${author.name}</span>
        </div>
        <button id="follow-${author.id}" class="px-4 py-2 bg-gray-200 text-black rounded-full font-medium hover:bg-[#FE2C55] transition-all" onclick="toggleFollow('${author.id}')">
          Seguir
        </button>
      `;
      authorsList.appendChild(authorItem);
    });
  }

  // Simulaci√≥n de autores cargados (reemplaza con Firebase)
  loadAuthors([
    { id: '1', name: 'Autor A', photoUrl: 'https://via.placeholder.com/150' },
    { id: '2', name: 'Autor B', photoUrl: 'https://via.placeholder.com/150' },
    { id: '3', name: 'Autor C', photoUrl: 'https://via.placeholder.com/150' },
  ]);
</script>

<script>
  async function handleNoteLike(noteId, likeButton) {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para dar like');
      return;
    }

    if (likeButton.classList.contains('text-[#FE2C55]')) {
      alert('Ya diste like a esta nota');
      return;
    }

    const originalHTML = likeButton.innerHTML;
    likeButton.disabled = true;
    likeButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
      const response = await fetch('/.netlify/functions/like-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          noteId: noteId,
          userId: user.uid
        })
      });

      const result = await response.json();

      if (!response.ok) {
        if (response.status === 429) {
          alert(result.message || 'Has alcanzado el l√≠mite de likes por hoy');
        } else {
          throw new Error(result.error || 'Error al dar like');
        }
        likeButton.disabled = false;
        likeButton.innerHTML = originalHTML;
        return;
      }

      likeButton.classList.add('text-[#FE2C55]');
      const likesCount = likeButton.querySelector('.likes-count');
      if (likesCount) {
        likesCount.textContent = result.likes;
      }
      likeButton.disabled = false;
      likeButton.innerHTML = `<i class="fas fa-heart"></i> <span class="likes-count">${result.likes}</span>`;
      
    } catch (error) {
      console.error('Error al dar like:', error);
      alert('Error al dar like. Por favor intenta de nuevo.');
      likeButton.disabled = false;
      likeButton.innerHTML = originalHTML;
    }
  }
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  }

  body {
    background-color: #fff;
  }

  .tab-button.active {
    color: #FE2C55;
    border-bottom: 2px solid #FE2C55;
    font-weight: 500;
  }

  /* Estilos del autor */
  .author-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background-color: #f0f0f0;
    border-radius: 10px;
    margin-bottom: 12px;
  }

  .author-item img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 16px;
  }

  /* Ocultar scrollbar pero mantener funcionalidad */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .scrollbar-hide {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
</style>

<!-- Script para cambiar entre libros y autores -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        var tab = button.getAttribute('data-tab');
        document.getElementById('books-section').classList.toggle('hidden', tab !== 'books');
        document.getElementById('authors-section').classList.toggle('hidden', tab !== 'authors');
        tabButtons.forEach(function(btn) {
          btn.classList.remove('text-white', 'border-b-2', 'border-[#ff0050]');
        });
        button.classList.add('text-white', 'border-b-2', 'border-[#ff0050]');
      });
    });
  });
</script>
<!-- PERFIL PROPIO CON SUBIDA DE FOTO EN TIEMPO REAL -->
<div id="profile-view" class="fixed inset-0 overflow-y-auto z-40 hidden bg-white text-black scrollbar-hide">
  <!-- Vista m√≥vil -->
  <div class="block lg:hidden p-4 max-w-md mx-auto">
    <!-- Header con bot√≥n volver y botones de acci√≥n -->
    <div class="flex justify-between items-center mb-4">
      <button onclick="openHome()" class="text-[#FE2C55] font-medium flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        <span id="btn-volver-profile">Volver</span>
      </button>
      
      <!-- Botones de acci√≥n en la esquina superior derecha -->
      <div class="flex items-center space-x-2">
        <!-- Bot√≥n de crear historia -->
        <button onclick="openStoryCreation()" class="text-[#FE2C55] p-2 hover:bg-gray-100 rounded-full transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </button>
        
        <!-- Bot√≥n de ajustes -->
        <button onclick="openProfileEdit()" class="text-[#FE2C55] p-2 hover:bg-gray-100 rounded-full transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-col items-center">
      <!-- Imagen de perfil centrada -->
      <div class="relative mb-4">
        <!-- Marco animado seleccionado -->
        <div id="profile-frame" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
        
        <!-- Imagen de perfil (SOLO VISUALIZACI√ìN) -->
        <div class="relative block">
          <img id="profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55] relative z-0" alt="Foto de perfil">
        </div>
        
        <!-- Bot√≥n para abrir selector de marcos -->
        <button onclick="openFrameSelector()" class="absolute -bottom-1 -right-1 bg-[#FE2C55] text-white rounded-full p-2 hover:bg-red-600 transition-all z-30">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
          </svg>
        </button>
      </div>

      <!-- Nombre de usuario debajo de la foto -->
      <h2 id="profile-username" class="text-xl font-semibold mb-4">@nombre_usuario</h2>

      <!-- Estad√≠sticas de seguidores y siguiendo -->
      <div class="flex space-x-8 mb-6">
        <button onclick="openMyFollowersModal()" class="text-center focus:outline-none hover:opacity-80 transition-opacity">
          <span id="profile-followers" class="font-bold text-[#FE2C55] text-xl">0</span>
          <p class="text-sm text-gray-600">Seguidores</p>
        </button>
        <button onclick="openMyFollowingModal()" class="text-center focus:outline-none hover:opacity-80 transition-opacity">
          <span id="profile-following" class="font-bold text-[#FE2C55] text-xl">0</span>
          <p class="text-sm text-gray-600">Siguiendo</p>
        </button>
      </div>

      <!-- Bot√≥n BeaBoo Studio -->
      <button onclick="openBeabooStudio()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg flex items-center justify-center mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
        </svg>
        BeaBoo Studio
      </button>

      <!-- Tabs de navegaci√≥n m√≥vil -->
      <hr class="border-t border-gray-300 w-full my-4">
      <div class="flex border-b border-gray-200 mb-4 w-full">
        <button onclick="switchProfileTab('stories')" class="flex-1 py-2 text-center text-[#FE2C55] border-b-2 border-[#FE2C55] font-medium" id="mobile-stories-tab">
          Historias
        </button>
        <button onclick="switchProfileTab('notes')" class="flex-1 py-2 text-center text-gray-500 font-medium" id="mobile-notes-tab">
          Notas
        </button>
      </div>

      <!-- Historias del usuario -->
      <div id="mobile-stories-content" class="mt-6 w-full">
        <h3 id="profile-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">0 Historias</h3>
        <div id="user-stories" class="grid grid-cols-2 gap-4"></div>
      </div>

      <!-- Notas del usuario (m√≥vil) -->
      <div id="mobile-notes-content" class="mt-6 w-full hidden">
        <h3 id="profile-notes-title" class="text-lg font-bold mb-2 text-[#FE2C55]">0 Notas</h3>
        <div id="user-notes-mobile" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- Vista desktop inspirada en Inkspired -->
  <div class="hidden lg:block relative min-h-screen">
    <!-- Header de perfil con fondo gradiente -->
    <div class="relative h-64 bg-gradient-to-r from-[#FE2C55] via-[#ff4757] to-[#FE2C55] overflow-hidden">
      <!-- Patr√≥n de fondo -->
      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
      
      <!-- Bot√≥n volver y opciones -->
      <div class="absolute top-6 left-6 right-6 flex justify-between items-center z-10">
        <button onclick="openHome()" class="text-white font-medium flex items-center hover:bg-white hover:bg-opacity-20 px-3 py-2 rounded-lg transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6" />
          </svg>
          Volver
        </button>
        
        <div class="flex items-center space-x-3">
          <button onclick="openProfileEdit()" class="bg-white text-[#FE2C55] px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-all flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Editar perfil
          </button>
          <button class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Informaci√≥n de perfil centrada -->
      <div class="absolute bottom-0 left-0 right-0 p-8">
        <div class="flex items-end space-x-6">
          <!-- Foto de perfil con marco (SOLO VISUALIZACI√ìN) -->
          <div class="relative">
            <div id="profile-frame-desktop" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
            <div class="relative block">
              <img id="profile-image-desktop" src="https://via.placeholder.com/120" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg relative z-0" alt="Foto de perfil">
            </div>
            <button onclick="openFrameSelector()" class="absolute -bottom-2 -right-2 bg-[#FE2C55] text-white rounded-full p-2 hover:bg-red-600 transition-all z-30 shadow-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
              </svg>
            </button>
          </div>

          <!-- Informaci√≥n del usuario -->
          <div class="flex-1">
            <h1 id="profile-username-desktop" class="text-3xl font-bold text-white mb-2">@nombre_usuario</h1>
            <p id="profile-location-desktop" class="text-white text-opacity-90 mb-4">Ubicaci√≥n no especificada</p>
            
            <!-- Estad√≠sticas -->
            <div class="flex space-x-8">
              <button onclick="openMyFollowersModal()" class="text-center focus:outline-none hover:opacity-80 transition-opacity">
                <div id="profile-followers-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">seguidores</div>
              </button>
              <button onclick="openMyFollowingModal()" class="text-center focus:outline-none hover:opacity-80 transition-opacity">
                <div id="profile-following-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">siguiendo</div>
              </button>
              <div class="text-center">
                <div id="profile-stories-count-desktop" class="text-2xl font-bold text-white">0</div>
                <div class="text-white text-opacity-80 text-sm">historias publicadas</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="bg-gray-50 min-h-screen">
      <!-- Navegaci√≥n de tabs -->
      <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-6">
          <nav class="flex space-x-8">
            <button class="tab-button active py-4 px-2 border-b-2 border-[#FE2C55] text-[#FE2C55] font-medium" data-tab="stories">
              Historias
            </button>
            <button class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium" data-tab="notes">
              Notas
            </button>
            
          </nav>
        </div>
      </div>

      <!-- Contenido de tabs -->
      <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="flex gap-8">
          <!-- Contenido principal -->
          <div class="flex-1">
            <!-- Tab de Historias -->
            <div id="stories-tab-content" class="tab-content">
              <!-- Bot√≥n BeaBoo Studio destacado -->
              <div class="bg-gradient-to-r from-[#FE2C55] to-[#ff6b7a] rounded-2xl p-6 mb-8 text-white">
                <div class="flex items-center justify-between">
                  <div>
                    <h3 class="text-2xl font-bold mb-2">BeaBoo Studio</h3>
                    <p class="text-white text-opacity-90">Crea y gestiona tus historias con herramientas profesionales</p>
                  </div>
                  <button onclick="openBeabooStudio()" class="bg-white text-[#FE2C55] px-6 py-3 rounded-xl font-medium hover:bg-gray-100 transition-all flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    Abrir Studio
                  </button>
                </div>
              </div>

              <!-- Header de historias con bot√≥n crear -->
              <div class="flex justify-between items-center mb-6">
                <div>
                  <h2 id="profile-stories-header" class="text-2xl font-bold text-gray-900">0 Historias</h2>
                  <button onclick="openBeabooStudio()" class="text-[#FE2C55] hover:text-red-600 flex items-center mt-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Gestionar mis historias
                  </button>
                </div>
                <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-6 py-3 rounded-xl hover:bg-red-600 transition-all flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  Nueva historia
                </button>
              </div>

              <!-- Grid de historias -->
              <div id="user-stories-desktop" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Tab de Notas -->
            <div id="notes-tab-content" class="tab-content hidden">
              <!-- Header de notas con bot√≥n crear -->
              <div class="flex justify-between items-center mb-6">
                <div>
                  <h2 id="profile-notes-header" class="text-2xl font-bold text-gray-900">0 Notas</h2>
                  <p class="text-gray-600 mt-1">Tus notas y pensamientos publicados en la comunidad</p>
                </div>
                <button onclick="openNoteCreation()" class="bg-[#FE2C55] text-white px-6 py-3 rounded-xl hover:bg-red-600 transition-all flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  Nueva nota
                </button>
              </div>

              <!-- Grid de notas -->
              <div id="user-notes-desktop" class="grid grid-cols-1 gap-4"></div>
            </div>

            
          </div>

          <!-- Sidebar derecho -->
          <div class="w-80">
            <!-- Estad√≠sticas -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border">
              <h3 class="font-bold text-gray-900 mb-4">Estad√≠sticas</h3>
              <div class="space-y-4">
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Historias publicadas</span>
                  <span id="sidebar-stories-count" class="font-bold text-[#FE2C55]">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Total de lecturas</span>
                  <span id="sidebar-total-views" class="font-bold text-[#FE2C55]">0</span>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-gray-600">Seguidores</span>
                  <span id="sidebar-followers-count" class="font-bold text-[#FE2C55]">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Funciones para manejar tabs en desktop
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tabName = button.getAttribute('data-tab');
      
      // Remover active de todos los botones
      tabButtons.forEach(btn => {
        btn.classList.remove('active', 'border-[#FE2C55]', 'text-[#FE2C55]');
        btn.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Agregar active al bot√≥n clickeado
      button.classList.add('active', 'border-[#FE2C55]', 'text-[#FE2C55]');
      button.classList.remove('border-transparent', 'text-gray-500');
      
      // Ocultar todos los contenidos
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // Mostrar el contenido correspondiente
      const targetContent = document.getElementById(tabName + '-tab-content');
      if (targetContent) {
        targetContent.classList.remove('hidden');
        
        // Si es el tab de notas, cargar las notas del usuario
        if (tabName === 'notes') {
          loadUserNotes();
        }
      }
    });
  });
});

// FUNCI√ìN REMOVIDA - La subida de foto solo est√° disponible en la secci√≥n de ajustes
</script>

<!-- CSS espec√≠fico para overlay de subida -->
<style>
  /* Ocultar scrollbar */
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
</style>

<!-- La subida de foto de perfil solo est√° disponible en la secci√≥n de ajustes -->


<!-- MODAL DE EDICI√ìN DE PERFIL -->
<div id="profile-edit-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-white text-black">
  <!-- Vista m√≥vil (actual) -->
  <div class="block lg:hidden p-6">
    <button onclick="closeProfileEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>
    <div class="flex flex-col items-center">
      <div class="relative">
        <img id="edit-profile-image-mobile" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto de perfil">
        <button onclick="document.getElementById('edit-profile-image-input').click();" class="absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v0" />
            <path d="M12 5a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2 2 2 0 0 1-2-2v0a2 2 0 0 1 2-2z" />
            <rect x="3" y="7" width="18" height="14" rx="2" ry="2" />
          </svg>
        </button>
        <input type="file" id="edit-profile-image-input" accept="image/*" class="hidden" onchange="handleEditProfileImageUpload(event)">
      </div>
      <!-- Campos m√≥viles reorganizados -->
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Nombre</label>
        <input id="edit-name" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Tu nombre real">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Nombre de usuario</label>
        <input id="edit-username" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Tu nombre de usuario">
        <p class="text-xs text-blue-600 mt-1">Solo se puede cambiar cada 7 d√≠as</p>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Biograf√≠a</label>
        <textarea id="edit-bio" rows="3" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Escribe tu biograf√≠a..."></textarea>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">G√©nero</label>
        <select id="edit-gender" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black">
          <option value="">Selecciona tu g√©nero</option>
          <option value="male">Masculino</option>
          <option value="female">Femenino</option>
          <option value="other">No definido</option>
        </select>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Pronombres</label>
        <select id="edit-pronouns" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black">
          <option value="">Selecciona tus pronombres</option>
          <option value="he">√âl</option>
          <option value="she">Ella</option>
          <option value="they">Elle</option>
        </select>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Instagram</label>
        <input id="edit-instagram" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Enlace a tu perfil en Instagram">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">TikTok</label>
        <div class="flex items-center space-x-2">
          <input id="edit-tiktok" type="text" class="flex-1 p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="@usuario" readonly>
          <button onclick="connectTikTok()" class="bg-black text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-gray-800 transition-colors">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
            </svg>
            <span>Conectar</span>
          </button>
        </div>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">P√°gina Web</label>
        <input id="edit-website" type="url" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="https://tusitio.com">
        <p class="text-xs text-gray-500 mt-1">Este enlace aparecer√° en tu perfil con color azul</p>
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Ciudad</label>
        <input id="edit-city" type="text" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black" placeholder="Ingresa tu ciudad">
      </div>
      <div class="mt-4 w-full">
        <label class="block mb-1 font-bold text-[#FE2C55]">Cumplea√±os</label>
        <input id="edit-birthday" type="date" class="w-full p-2 border border-gray-300 rounded-lg bg-[#f9f9f9] text-black">
      </div>
      <button onclick="saveProfileEdits()" class="mt-6 w-full bg-[#FE2C55] text-white p-3 rounded-lg">Guardar Cambios</button>
      <button onclick="signOutUser()" class="mt-4 w-full bg-[#f9f9f9] text-black p-3 rounded-lg border border-[#FE2C55]">Cerrar Sesi√≥n</button>
      
      <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-center">
        <p class="text-yellow-800 text-sm">
          <span class="text-lg mr-1">‚ú®</span>
          Los efectos y marcos est√°n disponibles en tu perfil
        </p>
      </div>
    </div>
  </div>

  <!-- Vista desktop (nueva estructura) -->
  <div class="hidden lg:flex h-full">
    <!-- Header superior -->
    <div class="absolute top-0 left-0 right-0 bg-white border-b p-6 z-10">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-cog text-[#FE2C55] text-2xl"></i>
          <h1 class="text-2xl font-semibold text-gray-700">Editar Perfil</h1>
        </div>
        <button onclick="closeProfileEdit()" class="text-gray-500 hover:text-gray-700 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="flex-1 flex pt-24">
      <!-- Formulario central -->
      <div class="flex-1 p-8 max-w-2xl">
        <h2 class="text-2xl font-semibold text-[#FE2C55] mb-8">Editar Perfil</h2>
        
        <div class="space-y-6">
          <!-- Primera fila: Username y Email -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Nombre de usuario
              </label>
              <div class="relative">
                <input id="edit-username-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu nombre de usuario">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>E-mail
              </label>
              <div class="relative">
                <input id="edit-email-desktop" type="email" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="usuario@ejemplo.com" readonly>
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Segunda fila: Nombre y Apellido -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Nombre
              </label>
              <div class="relative">
                <input id="edit-first-name-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu nombre">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Apellido
              </label>
              <div class="relative">
                <input id="edit-last-name-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu apellido">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Tercera fila: Fecha de nacimiento y G√©nero -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>Fecha de nacimiento
              </label>
              <div class="relative">
                <input id="edit-birthday-desktop" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent">
                <button class="absolute right-10 top-1/2 transform -translate-y-1/2 text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <span class="text-[#FE2C55]">*</span>G√©nero
              </label>
              <div class="relative">
                <select id="edit-gender-desktop" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none">
                  <option value="male">Masculino</option>
                  <option value="female">Femenino</option>
                  <option value="other">Otro</option>
                  <option value="prefer-not-to-say">Prefiero no decir</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
          </div>

          <!-- Cuarta fila: Pa√≠s y Ciudad -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Pa√≠s</label>
              <div class="relative">
                <select id="edit-country-desktop" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none">
                  <option value="us">Estados Unidos</option>
                  <option value="es">Espa√±a</option>
                  <option value="mx">M√©xico</option>
                  <option value="co">Colombia</option>
                  <option value="ar">Argentina</option>
                </select>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
              <div class="relative">
                <input id="edit-city-desktop" type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu ciudad">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Campos de redes sociales -->
          <div class="grid grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
              <div class="relative">
                <input id="edit-instagram-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Enlace a tu Instagram">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">P√°gina Web</label>
              <div class="relative">
                <input id="edit-website-desktop" type="url" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Tu p√°gina web">
                <button class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">TikTok</label>
            <div class="flex items-center space-x-3">
              <input id="edit-tiktok-desktop" type="text" class="flex-1 p-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="@usuario" readonly>
              <button onclick="connectTikTok()" class="bg-black text-white px-6 py-3 rounded-lg flex items-center space-x-2 hover:bg-gray-800 transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                </svg>
                <span>Conectar TikTok</span>
              </button>
            </div>
          </div>

          <!-- Biograf√≠a -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Biograf√≠a</label>
            <textarea id="edit-bio-desktop" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent" placeholder="Escribe algo sobre ti..."></textarea>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="flex space-x-4 pt-6">
            <button onclick="saveProfileEdits()" class="bg-[#FE2C55] text-white px-8 py-3 rounded-lg hover:bg-[#ef2950] transition-colors font-medium">
              Guardar Cambios
            </button>
            <button onclick="signOutUser()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium">
              Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>

      <!-- Panel derecho con foto de perfil -->
      <div class="w-96 p-8 bg-gray-50">
        <div class="text-right mb-6">
          <h3 class="text-lg font-medium text-gray-700">Profile picture</h3>
        </div>
        
        <div class="flex flex-col items-center">
          <div class="relative mb-6">
            <img id="edit-profile-image-desktop" src="https://via.placeholder.com/200" class="w-48 h-48 rounded-full object-cover border-4 border-white shadow-lg" alt="Profile picture">
            <button onclick="document.getElementById('edit-profile-image-input-desktop').click();" class="absolute bottom-4 right-4 bg-[#FE2C55] text-white rounded-full p-3 shadow-lg hover:bg-[#ef2950] transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </button>
            <input type="file" id="edit-profile-image-input-desktop" accept="image/*" class="hidden" onchange="handleEditProfileImageUpload(event)">
          </div>
          
          <!-- Panel de estad√≠sticas para desktop -->
          <div class="w-full bg-white rounded-lg p-6 shadow-sm">
            <div class="grid grid-cols-2 gap-4 text-center">
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-followers-desktop">0</p>
                <p class="text-sm text-gray-600">Seguidores</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-following-desktop">0</p>
                <p class="text-sm text-gray-600">Siguiendo</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-[#FE2C55]" id="edit-stories-count-desktop">0</p>
                <p class="text-sm text-gray-600">Historias</p>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function handleEditProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para subir una foto de perfil');
      return;
    }

    try {
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64String = e.target.result;
        const timestamp = Date.now();

        // Mostrar preview inmediatamente en TODAS las vistas
        const editProfileImageMobile = document.getElementById('edit-profile-image-mobile');
        const editProfileImageDesktop = document.getElementById('edit-profile-image-desktop');
        const profileImage = document.getElementById('profile-image');
        const profileImageDesktop = document.getElementById('profile-image-desktop');
        
        if (editProfileImageMobile) editProfileImageMobile.src = base64String;
        if (editProfileImageDesktop) editProfileImageDesktop.src = base64String;
        if (profileImage) profileImage.src = base64String;
        if (profileImageDesktop) profileImageDesktop.src = base64String;

        // Subir a S3
        const response = await fetch('/.netlify/functions/upload-image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            imageData: base64String,
            fileName: file.name,
            userId: user.uid,
            timestamp: timestamp,
            contentType: file.type,
            imageType: 'profile'
          })
        });

        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Error al subir imagen');
        }

        // Actualizar TODAS las im√°genes de perfil con la URL final de S3
        if (editProfileImageMobile) editProfileImageMobile.src = result.imageUrl;
        if (editProfileImageDesktop) editProfileImageDesktop.src = result.imageUrl;
        if (profileImage) profileImage.src = result.imageUrl;
        if (profileImageDesktop) profileImageDesktop.src = result.imageUrl;
        
        // Guardar en Firebase Database para que se sincronice en tiempo real
        await firebase.database().ref('users/' + user.uid).update({
          profileImage: result.imageUrl
        });

        // Actualizar todas las instancias de la imagen del usuario en la p√°gina
        // Esto incluye b√∫squedas, listas de autores, comentarios, etc.
        const allUserImages = document.querySelectorAll(`img[data-user-id="${user.uid}"]`);
        allUserImages.forEach(img => {
          img.src = result.imageUrl;
        });
        
        // Tambi√©n actualizar cualquier imagen con src que contenga el userId
        setTimeout(() => {
          const searchResults = document.querySelectorAll('img[src*="placeholder"]');
          searchResults.forEach(img => {
            if (img.closest('[data-author-id="' + user.uid + '"]')) {
              img.src = result.imageUrl;
            }
          });
        }, 100);

        // Mostrar notificaci√≥n de √©xito
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[9999] flex items-center';
        notification.innerHTML = `
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Foto de perfil actualizada correctamente
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transition = 'opacity 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      };
      
      reader.onerror = (error) => {
        console.error("Error al leer la imagen:", error);
        alert('Error al procesar la imagen');
      };
      
      reader.readAsDataURL(file);
    } catch (error) {
      console.error("Error al subir imagen de perfil:", error);
      alert('Error al subir la imagen de perfil: ' + error.message);
    }
  }
</script>

<!-- MODAL DE PERFIL DEL AUTOR -->
<div id="author-profile-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative">
    <!-- Bot√≥n de volver -->
    <button onclick="closeAuthorProfile()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span id="btn-volver-author">Volver</span>
    </button>
    <!-- Bot√≥n de opciones (3 puntos) -->
    <button id="options-button" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.75a.75.75 0 100-1.5.75.75 0 000 1.5zM12 13.25a.75.75 0 100-1.5.75.75 0 000 1.5zM12 19.75a.75.75 0 100-1.5.75.75 0 000 1.5z" />
      </svg>
    </button>
    <!-- Men√∫ de opciones -->
    <div id="options-menu" class="absolute top-12 right-4 bg-white border border-gray-300 rounded-lg shadow-lg hidden">
      <ul class="divide-y">
        <li><button onclick="window.location.href='report.html'" class="w-full text-left px-4 py-2 hover:bg-gray-100">Reportar</button></li>
      </ul>
    </div>

    <div class="flex flex-col items-center mt-4" id="author-profile-content">
      <!-- Foto del autor -->
      <div id="author-profile-img-container" class="relative">
        <!-- Marco animado del autor -->
        <div id="author-profile-frame" class="absolute inset-0 rounded-full pointer-events-none z-10" style="display: none;"></div>
        <img id="author-profile-image" src="https://via.placeholder.com/150" class="w-24 h-24 rounded-full object-cover border-2 border-[#FE2C55]" alt="Foto del autor">
        <!-- Note bubble -->
        <div id="profile-note" class="hidden absolute -top-16 left-1/2 transform -translate-x-1/2 bg-white p-3 rounded-lg shadow-lg w-48 text-center animate-float">
          <p id="note-text" class="text-sm"></p>
          <p id="note-time" class="text-xs text-gray-500 mt-1"></p>
        </div>
        <style>
          @keyframes float {
            0%, 100% { transform: translate(-50%, 0px); }
            50% { transform: translate(-50%, -10px); }
          }
          .animate-float {
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
          }
        </style>
        <!-- Add note button (only visible for profile owner) -->
        <button id="add-note-btn" onclick="openNoteModal()" class="hidden absolute bottom-0 right-0 bg-[#FE2C55] text-white rounded-full p-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>

      <!-- Note Modal -->
      <div id="note-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-4 rounded-lg w-80">
          <h3 class="text-lg font-bold mb-4">Agregar nota temporal</h3>
          <textarea id="note-input" class="w-full p-2 border rounded mb-4" placeholder="Escribe tu nota (m√°x. 100 caracteres)" maxlength="100"></textarea>
          <div class="flex justify-end space-x-2">
            <button onclick="closeNoteModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
            <button onclick="saveNote()" class="px-4 py-2 bg-[#FE2C55] text-white rounded hover:bg-red-600">Guardar</button>
          </div>
        </div>
      </div>

<script>
function openNoteModal() {
  document.getElementById('note-modal').classList.remove('hidden');
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.add('hidden');
  document.getElementById('note-input').value = '';
}

function saveNote() {
  const noteText = document.getElementById('note-input').value.trim();
  const currentUser = firebase.auth().currentUser;
  
  if (!noteText || !currentUser) return;
  
  firebase.database().ref('profileNotes/' + currentUser.uid).set({
    text: noteText,
    timestamp: Date.now()
  }).then(() => {
    closeNoteModal();
    const profileNote = document.getElementById('profile-note');
    profileNote.classList.remove('hidden');
    document.getElementById('note-text').textContent = noteText;
    document.getElementById('note-time').textContent = 'Expira en 12 horas';
  });
}
</script>
      <!-- Nombre de usuario -->
      <h2 id="author-profile-name" class="text-xl font-bold mt-2 text-black"></h2>
      <!-- Biograf√≠a y sitio web -->
      <div id="author-bio" class="text-center text-gray-600 mt-2 max-w-md"></div>
      <!-- Redes sociales -->
      <div id="author-social-links" class="flex space-x-4 mt-4"></div>

      <!-- Estad√≠sticas encima de botones -->
      <div class="flex space-x-8 mt-6">
        <button onclick="openFollowingModal()" class="text-center focus:outline-none hover:opacity-70 transition-opacity">
          <span id="author-following" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Siguiendo</p>
        </button>
        <button onclick="openFollowersModal()" class="text-center focus:outline-none hover:opacity-70 transition-opacity">
          <span id="author-followers" class="font-bold text-black">0</span>
          <p class="text-sm text-[#FE2C55]">Seguidores</p>
        </button>
      </div>

      <!-- Botones de acci√≥n: Seguir, Bloquear y Reportar -->
      <div class="flex items-center justify-center w-full mt-4 space-x-2">
        <button id="follow-button" onclick="followAuthor()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg hover:bg-red-600" title="Seguir/Dejar de seguir">
          <span id="follow-button-text">Seguir</span>
        </button>
        <button id="block-button" onclick="blockAuthor()" class="bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Bloquear/Desbloquear">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
          </svg>
          Bloquear
        </button>
        <button id="report-button" onclick="window.location.href='report.html'" class="flex items-center bg-[#f9f9f9] text-[#FE2C55] px-4 py-2 rounded-lg border border-[#FE2C55] hover:bg-gray-100" title="Reportar">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Reportar
        </button>
      </div>

      <hr class="border-t border-gray-300 w-full my-4">

      <!-- Historias del autor -->
      <div class="mt-4 w-full">
        <h3 id="author-stories-title" class="text-lg font-bold mb-2 text-[#FE2C55]">Historias del autor</h3>
        <div id="author-stories" class="grid grid-cols-2 gap-4"></div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts para opciones y funcionalidad -->
<script>
  // Toggle men√∫ de opciones
  document.getElementById('options-button').addEventListener('click', function() {
    const menu = document.getElementById('options-menu');
    menu.classList.toggle('hidden');
  });

  // Toggling de texto en bot√≥n de seguir
  async function followAuthor() {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para seguir a otros usuarios');
      return;
    }

    const btn = document.getElementById('follow-button');
    const text = document.getElementById('follow-button-text');
    const isFollowing = text.textContent === 'Dejar de seguir';
    
    try {
      const response = await fetch('/.netlify/functions/manage-following', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: isFollowing ? 'unfollow' : 'follow',
          userId: user.uid,
          targetUserId: currentViewedAuthorId
        })
      });

      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al seguir/dejar de seguir');
      }

      text.textContent = isFollowing ? 'Seguir' : 'Dejar de seguir';
      
      // Actualizar contador de seguidores
      const followersElement = document.getElementById('author-followers');
      if (followersElement) {
        const currentCount = parseInt(followersElement.textContent);
        followersElement.textContent = isFollowing ? currentCount - 1 : currentCount + 1;
      }

      // Notificar al autor
      if (!isFollowing) {
        await addNotification(currentViewedAuthorId, `${user.displayName || 'Alguien'} comenz√≥ a seguirte`, 'follow');
      }
    } catch (error) {
      console.error('Error al seguir/dejar de seguir:', error);
      alert('Error al seguir/dejar de seguir. Por favor intenta de nuevo.');
    }
  }
</script>



<!-- VISTA DE CREACI√ìN DE HISTORIAS (Paso 1) - PANTALLA COMPLETA -->
<div id="story-creation-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="min-h-screen w-full">
    <!-- Header fijo -->
    <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4">
      <div class="flex items-center justify-between max-w-4xl mx-auto">
        <button onclick="closeStoryCreation()" class="text-[#FE2C55] font-medium flex items-center hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Volver</span>
        </button>
        <h1 class="text-xl font-bold text-[#FE2C55]">BeaBoo Studio</h1>
        <div class="w-20"></div> <!-- Spacer para centrar el t√≠tulo -->
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="max-w-4xl mx-auto px-4 py-8">
      <div class="text-center mb-12">
        <h2 id="story-type-title" class="text-4xl md:text-5xl font-bold mb-4 text-black">¬øQu√© historia deseas contar?</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">Elige el tipo de historia que mejor se adapte a tu creatividad y comienza a escribir tu pr√≥xima obra maestra.</p>
      </div>

      <!-- Grid de opciones de historia -->
      <div class="grid grid-cols-1 gap-6 max-w-2xl mx-auto">
        <!-- Historia Completa -->
        <div onclick="selectStoryType('historia_completa')" class="group cursor-pointer">
          <div class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border-2 border-transparent hover:border-[#FE2C55]">
            <div class="text-center">
              <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
              </div>
              <h3 class="text-2xl font-bold mb-4 text-black">Historia Completa</h3>
              <p class="text-gray-600 mb-6">Una narrativa dividida en cap√≠tulos, ideal para desarrollar tramas complejas.</p>
              <div class="flex items-center justify-center text-[#FE2C55] group-hover:text-[#ef2950] transition-colors">
                <span class="font-medium mr-2">Comenzar</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      
    </div>
  </div>
</div>

<!-- VISTA DE DETALLES DE HISTORIA (Paso 2) - PANTALLA COMPLETA -->
<div id="story-details-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="min-h-screen w-full">
    <!-- Header fijo -->
    <div class="sticky top-0 z-10 bg-white/80 backdrop-blur-md border-b border-gray-200 p-4">
      <div class="flex items-center justify-between max-w-6xl mx-auto">
        <button onclick="backToStoryType()" class="text-[#FE2C55] font-medium flex items-center hover:bg-gray-100 px-3 py-2 rounded-lg transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          <span>Volver</span>
        </button>
        <h1 class="text-xl font-bold text-[#FE2C55]">Configurar Historia</h1>
        <div class="w-20"></div> <!-- Spacer para centrar el t√≠tulo -->
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="max-w-6xl mx-auto px-4 py-8">
      <div class="text-center mb-12">
        <h2 id="create-story-title" class="text-4xl md:text-5xl font-bold mb-4 text-black">Crear Historia</h2>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto">Configura los detalles de tu historia para que los lectores puedan descubrirla f√°cilmente.</p>
      </div>

      <form id="story-form" class="max-w-4xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Columna izquierda: Formulario -->
          <div class="space-y-6">
            <!-- T√≠tulo -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">T√≠tulo de la historia *</label>
              <div class="relative">
                <input id="story-title" type="text" placeholder="Escribe un t√≠tulo atractivo..." class="w-full p-4 pl-12 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent transition-all" required>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </div>
            </div>

            <!-- Categor√≠a y Rating -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Categor√≠a *</label>
                <div class="relative">
                  <select id="story-category" class="w-full p-4 pl-12 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none transition-all" required>
                    <option value="" disabled selected>Selecciona una categor√≠a</option>
                    <option value="aventura">Aventura</option>
                    <option value="romance">Romance</option>
                    <option value="misterio">Misterio</option>
                    <option value="fantasia">Fantas√≠a</option>
                    <option value="terror">Terror</option>
                    <option value="ciencia_ficcion">Ciencia Ficci√≥n</option>
                    <option value="drama">Drama</option>
                    <option value="comedia">Comedia</option>
                  </select>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                  </svg>
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Clasificaci√≥n *</label>
                <div class="relative">
                  <select id="story-rating" class="w-full p-4 pl-12 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none transition-all" required>
                    <option value="all">Todo p√∫blico</option>
                    <option value="13plus">Mayores de 13</option>
                    <option value="18plus">Mayores de 18</option>
                  </select>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                  </svg>
                </div>
              </div>
            </div>

            <!-- Idioma -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">Idioma de la historia *</label>
              <div class="relative">
                <select id="story-language" class="w-full p-4 pl-12 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent appearance-none transition-all" required>
                  <option value="" disabled selected>Selecciona un idioma</option>
                  <option value="Spanish">Espa√±ol</option>
                  <option value="English">English</option>
                  <option value="Portuguese">Portugu√™s</option>
                  <option value="French">Fran√ßais</option>
                </select>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                </svg>
              </div>
            </div>

            <!-- Sinopsis -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">Sinopsis</label>
              <div class="relative">
                <textarea id="story-synopsis" placeholder="Describe tu historia de manera atractiva para captar la atenci√≥n de los lectores..." class="w-full p-4 pl-12 bg-white border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#FE2C55] focus:border-transparent resize-none transition-all" rows="5"></textarea>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-6 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <p class="text-xs text-gray-500 mt-2">Una buena sinopsis puede aumentar significativamente el n√∫mero de lectores</p>
            </div>
          </div>

          <!-- Columna derecha: Portada y vista previa -->
          <div class="space-y-6">
            <!-- Subir portada -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-3">Portada de la historia</label>
              <label for="story-cover" class="block w-full h-80 bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl border-2 border-dashed border-gray-300 hover:border-[#FE2C55] transition-colors cursor-pointer group">
                <div class="w-full h-full flex flex-col items-center justify-center p-8">
                  <div class="w-16 h-16 mb-4 bg-[#FE2C55] rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <h3 class="text-lg font-semibold text-gray-700 mb-2">Subir portada</h3>
                  <p class="text-sm text-gray-500 text-center">Arrastra una imagen aqu√≠ o haz clic para seleccionar</p>
                  <p class="text-xs text-gray-400 mt-2">Recomendado: 600x900px (formato 2:3)</p>
                </div>
                <input id="story-cover" type="file" accept="image/*" class="hidden">
              </label>
            </div>

            <!-- Vista previa -->
            <div class="bg-white rounded-2xl border-2 border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-700 mb-4">Vista previa</h3>
              <div class="bg-gray-50 rounded-xl p-4">
                <div class="flex space-x-4">
                  <div class="w-16 h-24 bg-gray-200 rounded-lg flex-shrink-0 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 mb-1">T√≠tulo de tu historia</h4>
                    <p class="text-sm text-gray-600 mb-2">Por tu nombre</p>
                    <p class="text-xs text-gray-500">Categor√≠a ‚Ä¢ Idioma</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bot√≥n de crear historia -->
        <div class="mt-12 text-center">
          <button id="btn-create-story" type="submit" class="inline-flex items-center px-12 py-4 text-lg font-semibold text-white bg-gradient-to-r from-[#FE2C55] to-[#f97f97] rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Crear Historia
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Funciones para cambiar vistas
  function selectStoryType(type) {
    document.getElementById('story-creation-view').classList.add('hidden');
    document.getElementById('story-details-view').classList.remove('hidden');
  }
</script>

<!-- MODAL DE EDICI√ìN DE HISTORIAS (Paso 3) -->
<div id="story-edit-view" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-4 relative max-w-md mx-auto">
    <!-- Bot√≥n de cerrar -->
    <button onclick="closeStoryEdit()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      <span>Cerrar</span>
    </button>

    <!-- T√≠tulo -->
    <h2 id="edit-story-title" class="text-2xl font-bold mb-6 text-black">Editar Historia</h2>

    <!-- Edici√≥n de idioma -->
    <div class="mb-5">
      <label for="edit-story-language" class="text-sm text-gray-600 ml-2 mb-1 block">Idioma de la historia</label>
      <div class="relative">
        <select id="edit-story-language" class="w-full p-3 pl-10 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black appearance-none">
          <option value="">Selecciona un idioma</option>
          <option value="English">English</option>
          <option value="Spanish">Espa√±ol</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-[#FE2C55]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
        </svg>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>

    <!-- Bot√≥n guardar -->
    <button onclick="saveStoryEdits()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium mb-6 flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
      </svg>
      <span>Guardar Cambios</span>
    </button>

    <!-- Lista de cap√≠tulos -->
    <div id="chapter-section" class="mb-8">
      <h3 class="text-xl font-semibold mb-4 flex items-center text-[#FE2C55]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
        <span>Cap√≠tulos</span>
      </h3>
      <div id="chapter-list" class="space-y-3 mb-4 max-h-60 overflow-y-auto pr-2"></div>
      <button onclick="openChapterCreationModal()" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        <span>Agregar Cap√≠tulo</span>
      </button>
    </div>

    <hr class="border-t border-gray-300 w-full my-4">

    <!-- Botones adicionales -->
    <button onclick="toggleStoryPrivacy()" class="w-full bg-[#f9f9f9] text-[#FE2C55] border border-[#FE2C55] p-3 rounded-lg font-medium mb-4 flex items-center justify-center hover:bg-gray-100 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
      </svg>
      <span>Hacer privada</span>
    </button>

    <button onclick="deleteStory(currentEditingStory.id)" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
      <span>Eliminar Historia</span>
    </button>
  </div>
</div>

<!-- MODAL DE CREACI√ìN/EDICI√ìN DE CAP√çTULO -->
<div id="chapter-creation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
  <div class="modal-content bg-gradient-to-b from-white to-[#f9f9f9] text-black p-4 rounded-xl shadow-lg w-11/12 max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <h2 id="chapter-creation-title" class="text-2xl font-bold text-[#FE2C55]">Agregar Nuevo Cap√≠tulo</h2>
      <button onclick="closeChapterCreationModal()" class="text-gray-500 hover:text-black transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Barra de herramientas -->
    <div id="chapter-creation-toolbar" class="bg-white p-3 rounded-lg mb-4 flex flex-wrap gap-4 items-center">
      <div class="flex items-center">
        <label for="font-family" class="text-sm text-gray-600 mr-2">Fuente:</label>
        <select id="font-family" class="bg-white border border-gray-300 rounded-lg text-black text-sm p-1.5 focus:ring-2 focus:ring-[#FE2C55]">
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option>
        </select>
      </div>

      <div class="flex items-center flex-1 min-w-[200px]">
        <label for="font-size" class="text-sm text-gray-600 mr-2">Tama√±o:</label>
        <input type="range" id="font-size" min="12" max="36" value="16" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#FE2C55] mr-2">
        <span id="font-size-value" class="text-sm">16px</span>
      </div>

      <div class="bg-white py-1 px-3 rounded-lg text-sm text-gray-600">
        <span id="word-count">0 palabras</span> - <span id="letter-count">0 letras</span>
      </div>
    </div>

    <form id="chapter-form" class="space-y-4">
      <div class="flex items-center gap-4 mb-4">
        <input type="datetime-local" id="chapter-schedule" class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55]">
        <label class="text-sm text-gray-600">Fecha de publicaci√≥n (opcional)</label>
      </div>
      <textarea id="chapter-content" placeholder="Escribe el contenido del cap√≠tulo aqu√≠..." class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#FE2C55] text-black placeholder-gray-500 resize-none" style="font-size:16px; font-family: Arial;" rows="12" required></textarea>

      <button id="btn-save-chapter" type="submit" class="w-full bg-[#FE2C55] text-white p-3 rounded-lg font-medium flex items-center justify-center hover:bg-red-600 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span>Guardar Cap√≠tulo</span>
      </button>
    </form>
  </div>
</div>

<!-- MODAL DE LECTURA DE CAP√çTULO -->
<div id="chapter-read-modal" class="fixed inset-0 bg-white bg-opacity-95 flex flex-col z-50 hidden">
  <div class="bg-white w-full h-screen flex flex-col">
    <button onclick="closeChapterReadModal()" class="absolute top-6 left-6 text-gray-600 hover:text-[#FE2C55] text-3xl z-10 transition-colors duration-200">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </button>
    <div class="flex-1 overflow-y-auto p-8 md:p-12 max-w-3xl mx-auto w-full">


      <h2 id="read-chapter-number" class="text-2xl md:text-3xl font-bold mb-8 mt-16 text-gray-900"></h2>
      <div id="read-chapter-text" class="text-lg leading-relaxed text-gray-700 font-serif"></div>
    </div>
    <div class="bg-gray-50 border-t border-gray-200 p-4 flex justify-between items-center shadow-lg">
      <button id="prev-chapter-btn" class="bg-gray-200 text-gray-700 px-5 py-3 rounded-lg shadow hover:shadow-md hover:bg-gray-300 transition-all duration-200 focus:outline-none flex items-center gap-2 font-medium" onclick="prevChapter()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Anterior
      </button>
      <div id="rating-container" class="flex items-center space-x-3">
        <span class="text-gray-700 font-medium">Califica:</span>
        <div id="star-rating" class="flex">
          <span class="star cursor-pointer text-2xl text-gray-400 hover:text-[#FE2C55] transition-colors duration-150" data-value="1">‚òÖ</span>
          <span class="star cursor-pointer text-2xl text-gray-400 hover:text-[#FE2C55] transition-colors duration-150" data-value="2">‚òÖ</span>
          <span class="star cursor-pointer text-2xl text-gray-400 hover:text-[#FE2C55] transition-colors duration-150" data-value="3">‚òÖ</span>
          <span class="star cursor-pointer text-2xl text-gray-400 hover:text-[#FE2C55] transition-colors duration-150" data-value="4">‚òÖ</span>
          <span class="star cursor-pointer text-2xl text-gray-400 hover:text-[#FE2C55] transition-colors duration-150" data-value="5">‚òÖ</span>
        </div>
      </div>
      <button id="next-chapter-btn" class="bg-[#FE2C55] text-white px-5 py-3 rounded-lg shadow hover:shadow-md hover:bg-red-600 transition-all duration-200 focus:outline-none flex items-center gap-2 font-medium" onclick="nextChapter()">
        Siguiente
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- MODAL DE DETALLE DE HISTORIA -->
<div id="story-detail-modal" class="fixed inset-0 overflow-y-auto z-50 hidden bg-gradient-to-b from-white to-[#f9f9f9] text-black">
  <div class="p-6 relative max-w-4xl mx-auto bg-white min-h-screen">

    <!-- Bot√≥n de volver -->
    <button onclick="closeStoryDetail()" class="text-[#FE2C55] mb-6 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <!-- Secci√≥n principal: portada + t√≠tulo/autor -->
    <div class="flex items-start space-x-6 mb-8">
      <!-- Portada estilo Inkitt/Wattpad -->
      <img id="detail-cover" src="https://via.placeholder.com/400x600" alt="Portada de la historia"
           class="w-40 sm:w-48 md:w-56 aspect-[2/3] object-cover rounded-2xl border-2 border-[#FE2C55] shadow-lg">
      
      <!-- Detalles de historia -->
      <div class="flex-1 flex flex-col">
        <h2 id="detail-title" class="text-2xl sm:text-3xl font-bold text-black mb-2">
          T√≠tulo de la historia
        </h2>
        <p id="detail-author"
           class="text-gray-600 mb-4 cursor-pointer hover:text-[#FE2C55] transition-colors duration-200"
           onclick="openAuthorProfile(this.dataset.userid)">
          Nombre del autor
        </p>
      </div>
    </div>

    <!-- Lista de cap√≠tulos -->
    <div class="w-full mb-8">
      <h3 class="text-lg font-bold mb-4 text-[#FE2C55]">Cap√≠tulos</h3>
      <ul id="detail-chapters" class="space-y-3">
        <!-- Aqu√≠ insertar cada <li> de cap√≠tulo -->
      </ul>
    </div>

    <!-- Sinopsis -->
    <div class="w-full mb-6">
      <h3 class="text-lg font-semibold mb-3 text-[#FE2C55]">Sinopsis</h3>
      <p id="detail-synopsis" class="text-gray-600 leading-relaxed">
        Sinopsis de la historia...
      </p>
    </div>

    <!-- M√©tricas estilizadas debajo de sinopsis -->
    <div id="detail-metrics" class="flex justify-center gap-4">
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">3</span>
        <p class="text-xs text-[#FE2C55] mt-1">Visitas</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">4.5</span>
        <p class="text-xs text-[#FE2C55] mt-1">Calificaci√≥n</p>
      </div>
      <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
        <span class="text-lg font-bold text-black">12</span>
        <p class="text-xs text-[#FE2C55] mt-1">Cap√≠tulos</p>
      </div>
    </div>

  </div>
</div>

<script>
  // Scheduled chapters functionality
function saveScheduledChapter(chapterId, publishDate) {
  firebase.database().ref('scheduledChapters/' + chapterId).set({
    publishDate: publishDate,
    status: 'pending'
  });
}

function checkScheduledChapters() {
  const now = new Date().getTime();
  firebase.database().ref('scheduledChapters').once('value', snapshot => {
    snapshot.forEach(child => {
      const scheduled = child.val();
      if (scheduled.status === 'pending' && new Date(scheduled.publishDate).getTime() <= now) {
        // Publicar el cap√≠tulo
        firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + child.key).update({
          status: 'published'
        });
        // Actualizar estado del cap√≠tulo programado
        child.ref.update({ status: 'published' });
      }
    });
  });
}

// Verificar cap√≠tulos programados cada minuto
setInterval(checkScheduledChapters, 60000);
</script>






<!-- Estilos adicionales -->
<style>
  /* Estilos para los botones laterales */
  .side-buttons {
    z-index: 20;
  }

  /* Estilo para el gift drawer (abrir desde abajo) */
  #gift-drawer {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0;
    height: 70%;
    z-index: 60;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    transition: bottom 0.3s ease-in-out;
    overflow-y: auto;
  }

  #gift-drawer.open {
    bottom: 0;
  }

  /* Estilo para corazones animados */
  .heart {
    position: absolute;
    font-size: 25px;
    color: #00D6C9;
    animation: float-up 2s ease-out forwards;
    opacity: 0.8;
    z-index: 10;
    pointer-events: none;
  }

  @keyframes float-up {
    0% {
      transform: translateY(0) scale(1);
      opacity: 0.8;
    }

    100% {
      transform: translateY(-100px) scale(1.5);
      opacity: 0;
    }
  }

  /* Estilo para switch toggle */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #00D6C9;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #00D6C9;
  }

  input:checked+.slider:before {
    transform: translateX(26px);
  }

  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  /* Animaci√≥n de verificaci√≥n */
  .verification-animation {
    display: inline-block;
    margin: 0 auto;
  }
  
  /* Forzar tema TikTok en botones */
  button[class*="green"],
  .bg-green-500,
  .bg-green-600 {
    background-color: #FE2C55 !important;
  }
  
  button[class*="green"]:hover,
  .hover\:bg-green-600:hover {
    background-color: #e02849 !important;
  }
  
  /* Forzar color de texto negro en cap√≠tulos */
  #detail-chapters li span {
    color: #000 !important;
    font-weight: 500 !important;
  }

  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #00D6C9;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #00D6C9;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }

  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 2;
    stroke-miterlimit: 10;
    stroke: #00D6C9;
    fill: none;
    animation: stroke .6s cubic-bezier(0.650, 0.000, 0.450, 1.000) forwards;
  }

  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.650, 0.000, 0.450, 1.000) .8s forwards;
  }

  @keyframes stroke {
    100% {
      stroke-dashoffset: 0;
    }
  }

  @keyframes scale {

    0%,
    100% {
      transform: none;
    }

    50% {
      transform: scale3d(1.1, 1.1, 1);
    }
  }

  @keyframes fill {
    100% {
      box-shadow: inset 0px 0px 0px 30px #00D6C9;
    }
  }

  /* Animaci√≥n de hilos subiendo en el banner expandido */
  #animated-lines {
    position: relative;
    width: 100%;
    height: 50px;
    overflow: hidden;
    margin-top: 20px;
  }

  .line {
    position: absolute;
    width: 2px;
    height: 100%;
    background: linear-gradient(to top, transparent, #00D6C9);
    animation: rise 3s linear infinite;
    opacity: 0.7;
  }

  @keyframes rise {
    0% {
      top: 100%;
      opacity: 0;
    }

    50% {
      opacity: 1;
    }

    100% {
      top: -50px;
      opacity: 0;
    }
  }
</style>

<!-- JavaScript: Funcionalidades y Gestos -->
<script>
  // FUNCIONES DE MARCOS ANIMADOS
  function openFrameSelector() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    document.getElementById('frame-selector-modal').classList.remove('hidden');
  }

  function closeFrameSelector() {
    document.getElementById('frame-selector-modal').classList.add('hidden');
  }

  function selectFrame(frameType, cost = 0) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Aplicar marco directamente (todos son gratis ahora)
    applyFrame(frameType, 0);
  }

  function applyFrame(frameType, cost) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Mostrar loading
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60]';
    loadingDiv.innerHTML = `
      <div class="bg-white p-6 rounded-xl text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p>${cost > 0 ? 'Comprando y aplicando marco...' : 'Aplicando marco...'}</p>
      </div>
    `;
    document.body.appendChild(loadingDiv);

    const profileFrame = document.getElementById('profile-frame');
    
    // Limpiar clases anteriores
    if (profileFrame) {
      profileFrame.className = 'absolute inset-0 rounded-full pointer-events-none z-10';
      
      if (frameType === 'none') {
        profileFrame.style.display = 'none';
      } else {
        profileFrame.style.display = 'block';
        profileFrame.classList.add(frameType);
      }
    }

    // Guardar en Firebase para que otros usuarios lo vean
    firebase.database().ref('users/' + user.uid).update({
      profileFrame: frameType
    }).then(() => {
      // Verificar que el marco se guard√≥ correctamente
      return firebase.database().ref('users/' + user.uid + '/profileFrame').once('value');
    }).then((snapshot) => {
      loadingDiv.remove();
      closeFrameSelector();
      
      // Mostrar notificaci√≥n de √©xito mejorada
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center';
      notification.innerHTML = `
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        ${frameType === 'none' ? 'Marco removido correctamente' : 
          cost > 0 ? `Marco "${frameType}" comprado y aplicado correctamente` : 'Marco aplicado - Otros usuarios podr√°n verlo'}
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -20px)';
        notification.style.transition = 'all 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }).catch((error) => {
      loadingDiv.remove();
      console.error('Error al aplicar marco:', error);
      alert('Error al aplicar el marco. Por favor intenta de nuevo.');
    });
  }

  function purchaseFrame(frameType, cost) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Marcos son gratis ahora, solo aplicar
    applyFrame(frameType, 0);
  }

  function showFrameHistory() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid + '/purchasedFrames').once('value').then(snapshot => {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      
      let framesHTML = '';
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          const frameData = child.val();
          const frameName = child.key;
          framesHTML += `
            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2">
              <div>
                <span class="font-bold capitalize">${frameName}</span>
                <p class="text-sm text-gray-600">Comprado: ${new Date(frameData.purchaseDate).toLocaleDateString()}</p>
              </div>
              <div class="flex items-center space-x-2">
                <span class="text-yellow-600 font-bold">ü™ô ${frameData.cost}</span>
                <button onclick="applyFrame('${frameName}', 0); this.closest('.fixed').remove();" class="bg-[#FE2C55] text-white px-3 py-1 rounded text-sm">
                  Usar
                </button>
              </div>
            </div>
          `;
        });
      } else {
        framesHTML = '<p class="text-center text-gray-500">No has comprado ning√∫n marco a√∫n</p>';
      }

      modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Marcos Comprados</h2>
            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div>${framesHTML}</div>
        </div>
      `;
      
      document.body.appendChild(modal);
    });
  }

  function loadUserFrame(userId, targetElementId) {
    firebase.database().ref('users/' + userId + '/profileFrame').on('value', snapshot => {
      const frameType = snapshot.val();
      const profileFrame = document.getElementById(targetElementId);
      
      if (profileFrame) {
        // Limpiar todas las clases de marcos anteriores
        profileFrame.className = 'absolute inset-0 rounded-full pointer-events-none z-10';
        
        if (frameType && frameType !== 'none') {
          profileFrame.classList.add(frameType);
          profileFrame.style.display = 'block';
          console.log(`Marco ${frameType} aplicado para usuario ${userId}`);
        } else {
          profileFrame.style.display = 'none';
        }
      }
    });
  }

  // Funci√≥n para cargar estad√≠sticas del perfil desde AWS S3
  async function loadUserStats(userId) {
    try {
      const response = await fetch(`/.netlify/functions/get-user-stats?userId=${userId}`);
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al cargar estad√≠sticas');
      }

      const stats = result.stats;
      
      // Actualizar contador de historias en m√≥vil
      const profileStoriesTitle = document.getElementById('profile-stories-title');
      if (profileStoriesTitle) {
        profileStoriesTitle.textContent = `${stats.storiesCount} Historias`;
      }
      
      // Actualizar en desktop
      const profileStoriesHeader = document.getElementById('profile-stories-header');
      const sidebarStoriesCount = document.getElementById('sidebar-stories-count');
      const profileStoriesCountDesktop = document.getElementById('profile-stories-count-desktop');
      const sidebarTotalViews = document.getElementById('sidebar-total-views');
      const sidebarFollowersCount = document.getElementById('sidebar-followers-count');
      
      if (profileStoriesHeader) {
        profileStoriesHeader.textContent = `${stats.storiesCount} Historias`;
      }
      if (sidebarStoriesCount) {
        sidebarStoriesCount.textContent = stats.storiesCount;
      }
      if (profileStoriesCountDesktop) {
        profileStoriesCountDesktop.textContent = stats.storiesCount;
      }
      if (sidebarTotalViews) {
        sidebarTotalViews.textContent = stats.totalViews;
      }
      if (sidebarFollowersCount) {
        sidebarFollowersCount.textContent = stats.followersCount;
      }

      // Actualizar seguidores y siguiendo en m√≥vil
      const profileFollowers = document.getElementById('profile-followers');
      const profileFollowing = document.getElementById('profile-following');
      
      if (profileFollowers) {
        profileFollowers.textContent = formatNumber(stats.followersCount);
      }
      if (profileFollowing) {
        profileFollowing.textContent = formatNumber(stats.followingCount);
      }

      // Cargar las historias del usuario
      loadUserStoriesFromS3(userId);
    } catch (error) {
      console.error('Error al cargar estad√≠sticas:', error);
    }
  }

  // Nueva funci√≥n para cargar historias desde S3
  async function loadUserStoriesFromS3(userId) {
    try {
      const response = await fetch(`/.netlify/functions/get-stories?userId=${userId}`);
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al cargar historias');
      }

      const userStoriesDesktop = document.getElementById('user-stories-desktop');
      const userStoriesMobile = document.getElementById('user-stories');
      
      if (userStoriesDesktop) userStoriesDesktop.innerHTML = '';
      if (userStoriesMobile) userStoriesMobile.innerHTML = '';
      
      const stories = result.stories || [];

      if (stories.length === 0) {
        const noStoriesMessage = `
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 mb-4">
              <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-600 mb-2">No tienes historias a√∫n</h3>
            <p class="text-gray-500 mb-4">Crea tu primera historia para comenzar</p>
            <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
              Crear primera historia
            </button>
          </div>
        `;
        
        if (userStoriesDesktop) userStoriesDesktop.innerHTML = noStoriesMessage;
        if (userStoriesMobile) userStoriesMobile.innerHTML = noStoriesMessage;
        return;
      }

      stories.forEach(story => {
        const storyCard = createStoryCard(story, userId);
        
        if (userStoriesDesktop) {
          userStoriesDesktop.appendChild(storyCard.cloneNode(true));
        }
        if (userStoriesMobile) {
          userStoriesMobile.appendChild(storyCard);
        }
      });
    } catch (error) {
      console.error('Error al cargar historias del usuario:', error);
    }
  }

  // Funci√≥n para cargar las historias del usuario en el grid
  function loadUserStoriesGrid(userId, storiesSnapshot) {
    const userStoriesDesktop = document.getElementById('user-stories-desktop');
    const userStoriesMobile = document.getElementById('user-stories');
    
    if (userStoriesDesktop) {
      userStoriesDesktop.innerHTML = '';
    }
    if (userStoriesMobile) {
      userStoriesMobile.innerHTML = '';
    }
    
    if (!storiesSnapshot.exists()) {
      // Mostrar mensaje cuando no hay historias
      const noStoriesMessage = `
        <div class="col-span-full text-center py-12">
          <div class="text-gray-400 mb-4">
            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-600 mb-2">No tienes historias a√∫n</h3>
          <p class="text-gray-500 mb-4">Crea tu primera historia para comenzar</p>
          <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
            Crear primera historia
          </button>
        </div>
      `;
      
      if (userStoriesDesktop) {
        userStoriesDesktop.innerHTML = noStoriesMessage;
      }
      if (userStoriesMobile) {
        userStoriesMobile.innerHTML = noStoriesMessage;
      }
      return;
    }

    // Cargar historias existentes
    storiesSnapshot.forEach(child => {
      const story = child.val();
      story.id = child.key;
      
      const storyCard = createStoryCard(story, userId);
      
      if (userStoriesDesktop) {
        userStoriesDesktop.appendChild(storyCard.cloneNode(true));
      }
      if (userStoriesMobile) {
        userStoriesMobile.appendChild(storyCard);
      }
    });
  }

  // Funci√≥n para crear una tarjeta de historia
  function createStoryCard(story, userId) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl shadow-sm border hover:shadow-md transition-shadow cursor-pointer';
    
    const currentUser = firebase.auth().currentUser;
    const isOwner = currentUser && currentUser.uid === userId;
    
    card.innerHTML = `
      <div class="aspect-[3/4] relative">
        <img src="${story.coverImage || '/api/placeholder/300/400'}" 
             alt="${story.title}" 
             class="w-full h-full object-cover rounded-t-xl">
        <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded-full text-xs">
          ${story.views || 0} vistas
        </div>
        ${isOwner ? `
          <div class="absolute top-2 left-2 flex space-x-1">
            <button onclick="openStoryEdit(${JSON.stringify(story).replace(/"/g, '&quot;')})" 
                    class="bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition-colors"
                    title="Editar historia">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
          </div>
        ` : ''}
      </div>
      <div class="p-4">
        <h3 class="font-semibold text-gray-900 mb-1 line-clamp-1">${story.title}</h3>
        <p class="text-sm text-gray-600 mb-2 line-clamp-2">${story.synopsis || 'Sin descripci√≥n'}</p>
        <div class="flex items-center justify-between">
          <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            ${story.category || 'Sin categor√≠a'}
          </span>
          <button onclick="openStoryDetail(${JSON.stringify(story).replace(/"/g, '&quot;')})" 
                  class="text-[#FE2C55] text-sm font-medium hover:text-red-600 transition-colors">
            Leer ‚Üí
          </button>
        </div>
      </div>
    `;
    
    return card;
  }

  // FUNCIONES DEL CREATOR HUB
  function openCreatorHub() {
    showLoader();
    setTimeout(() => {
      document.getElementById('creator-hub-view').classList.remove('hidden');
      mainApp.classList.add('hidden');
      loadCreatorStats();
      hideLoader();
    }, 300);
  }

  function closeCreatorHub() {
    document.getElementById('creator-hub-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function openNoteCreation() {
    // Abrir la comunidad pero directamente en el tab de agregar nota
    closeCreatorHub();
    document.getElementById('community-view').classList.remove('hidden');
    switchCommunityTab('add');
  }

  function loadCreatorStats() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Cargar estad√≠sticas de historias
    firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value').then(snapshot => {
      document.getElementById('creator-stories-count').textContent = snapshot.numChildren();
    });

    // Cargar estad√≠sticas de notas
    firebase.database().ref('communityNotes').orderByChild('authorId').equalTo(user.uid).once('value').then(snapshot => {
      document.getElementById('creator-notes-count').textContent = snapshot.numChildren();
    });
  }

  // Á§æÂå∫ÂäüËÉΩ
  function openCommunity() {
    showLoader();
    setTimeout(() => {
      document.getElementById('community-view').classList.remove('hidden');
      mainApp.classList.add('hidden');
      loadNotes();
      hideLoader();
    }, 300);
  }

  function closeCommunity() {
    document.getElementById('community-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }

  function switchCommunityTab(tab) {
    const feedTab = document.getElementById('feed-tab');
    const photosTab = document.getElementById('photos-tab');
    const notesFeed = document.getElementById('notes-feed');
    const photosFeed = document.getElementById('photos-feed');
    const addNoteForm = document.getElementById('add-note-form');

    if (tab === 'feed') {
      feedTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.remove('hidden');
      photosFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.add('hidden');
      loadNotes();
    } else if (tab === 'photos') {
      photosTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      feedTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosFeed.classList.remove('hidden');
      notesFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.add('hidden');
      loadPhotos();
    } else if (tab === 'add') {
      // ÊòæÁ§∫Ê∑ªÂä†Á¨îËÆ∞Ë°®ÂçïÔºà‰ªéÂàõ‰ΩúËÄÖ‰∏≠ÂøÉËÆøÈóÆÔºâ
      feedTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      photosTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
      notesFeed.classList.add('hidden');
      photosFeed.classList.add('hidden');
      if (addNoteForm) addNoteForm.classList.remove('hidden');
    }
  }

  function handleNoteImagePreview(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('preview-img').src = e.target.result;
      document.getElementById('image-preview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }

  function removeImage() {
    document.getElementById('note-image').value = '';
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('preview-img').src = '';
  }

  async function publishNote() {
    const content = document.getElementById('note-content').value.trim();
    const imageInput = document.getElementById('note-image');
    
    if (!content && !imageInput.files.length) {
      alert('Por favor escribe algo o agrega una imagen');
      return;
    }

    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para publicar una nota');
      return;
    }

    const publishButton = document.querySelector('button[onclick="publishNote()"]');
    publishButton.disabled = true;
    publishButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publicando...';

    try {
      // Primero verificar l√≠mites
      const limitsCheck = await fetch('/.netlify/functions/check-user-limits', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: user.uid,
          action: 'note'
        })
      });

      const limitsResult = await limitsCheck.json();
      
      if (!limitsResult.canPerformAction) {
        publishButton.disabled = false;
        publishButton.innerHTML = 'Publicar';
        alert(limitsResult.message);
        return;
      }

      const snapshot = await firebase.database().ref('users/' + user.uid).once('value');
      const userData = snapshot.val();
      
      let imageData = null;
      let fileName = null;
      let contentType = null;

      if (imageInput.files.length > 0) {
        const reader = new FileReader();
        const file = imageInput.files[0];
        
        const base64String = await new Promise((resolve, reject) => {
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (error) => reject(error);
          reader.readAsDataURL(file);
        });
        
        imageData = base64String;
        fileName = file.name;
        contentType = file.type;
      }

      // Subir nota a AWS S3
      const response = await fetch('/.netlify/functions/upload-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          content: content,
          userId: user.uid,
          authorName: userData.username || 'Usuario',
          authorImage: userData.profileImage || 'https://via.placeholder.com/150',
          imageData: imageData,
          fileName: fileName,
          contentType: contentType
        })
      });

      const result = await response.json();
      
      if (!response.ok) {
        if (response.status === 429) {
          alert(result.message || 'Has alcanzado el l√≠mite de publicaciones');
        } else {
          throw new Error(result.error || 'Error al publicar nota');
        }
        publishButton.disabled = false;
        publishButton.innerHTML = 'Publicar';
        return;
      }

      document.getElementById('note-content').value = '';
      imageInput.value = '';
      document.getElementById('image-preview').classList.add('hidden');
      switchCommunityTab('feed');
      publishButton.disabled = false;
      publishButton.innerHTML = 'Publicar';
      alert('¬°Nota publicada exitosamente!');
      
      // Recargar notas
      loadNotes();
    } catch (error) {
      console.error('Error al publicar:', error);
      alert('Error al publicar la nota. Por favor intenta de nuevo.');
      publishButton.disabled = false;
      publishButton.innerHTML = 'Publicar';
    }
  }

  function publishNoteToDatabase(note) {
    // Verifica el contenido de la nota espec√≠ficamente
    if (moderarContenidoNota(note.content)) {
      alert('Tu nota no puede ser publicada porque contiene contenido inapropiado.');
      return;
    }
    
    firebase.database().ref('communityNotes').push(note).then((ref) => {
      // Verifica una vez m√°s despu√©s de publicar (por si acaso)
      moderarContenidoAutomaticamente(ref.key, note.content);
      
      document.getElementById('note-content').value = '';
      document.getElementById('note-image').value = '';
      document.getElementById('image-preview').classList.add('hidden');
      switchCommunityTab('feed');
    });
  }

  async function loadNotes() {
    const feedContainer = document.getElementById('notes-feed');
    feedContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-[#FE2C55]"></i></div>';
    
    try {
      const response = await fetch('/.netlify/functions/get-notes?limit=50');
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al cargar notas');
      }

      feedContainer.innerHTML = '';
      const notes = result.notes || [];

      if (notes.length === 0) {
        feedContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No hay notas a√∫n. ¬°S√© el primero en publicar!</div>';
        return;
      }

      notes.forEach(note => {
        const noteElement = document.createElement('div');
        noteElement.className = 'bg-white p-4 rounded-xl shadow';
        noteElement.innerHTML = `
          <div class="flex items-center mb-3">
            <img src="${note.authorImage}" alt="${note.authorName}" class="w-10 h-10 rounded-full mr-3">
            <div>
              <h3 class="font-bold">${note.authorName}</h3>
              <p class="text-sm text-gray-500">${new Date(note.timestamp).toLocaleString()}</p>
            </div>
          </div>
          <p class="mb-3">${note.content}</p>
          ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de nota" class="w-full rounded-lg mb-3 max-h-96 object-cover">` : ''}
          <div class="flex items-center space-x-4">
            <button id="like-btn-${note.noteId}" onclick="likeNote('${note.noteId}')" class="flex items-center text-[#FE2C55] hover:text-red-600 transition-colors">
              <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
              </svg>
              <span id="like-count-${note.noteId}">${note.likes || 0}</span>
            </button>
            ${note.authorId === firebase.auth().currentUser?.uid ? 
              `<button onclick="deleteNote('${note.noteId}')" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash"></i> Eliminar
              </button>` : 
              `<button onclick="reportNote('${note.noteId}')" class="text-gray-500 hover:text-gray-700 flex items-center">
                <i class="fas fa-flag mr-1"></i> Reportar
              </button>`
            }
          </div>
        `;
        
        feedContainer.appendChild(noteElement);
      });
    } catch (error) {
      console.error('Error al cargar notas:', error);
      feedContainer.innerHTML = '<div class="text-center py-8 text-red-500">Error al cargar notas. Por favor recarga la p√°gina.</div>';
    }
  }

  function moderarContenidoNota(texto) {
  const palabrasProhibidasNotas = [
    // Insultos y lenguaje ofensivo
    "idiota", "est√∫pido", "imb√©cil", "tonto", "pendejo",
    "maldito", "puta", "mierda", "carajo", "joder",
    "perra", "zorra", "maric√≥n", "puto", "cabr√≥n",
    // Discriminaci√≥n
    "negro", "sudaca", "indio", "gitano", "judio",
    // Contenido inapropiado
    "xxx", "porn", "sex", "desnudo",
    // Violencia
    "matar", "muerte", "suicidio", "sangre",
    // Spam y estafas
    "ganar dinero", "hazte rico", "click aqu√≠",
    // Enlaces maliciosos
    "bit.ly", "acortar.link", "short.io"
  ];
  
  const textoNormalizado = texto.toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z\s]/g, ''); // Elimina caracteres especiales
    
  // Busca palabras completas, no partes de palabras
  const palabras = textoNormalizado.split(/\s+/);
  return palabras.some(palabra => 
    palabrasOfensivas.includes(palabra) ||
    palabrasOfensivas.some(palabraOfensiva => 
      palabra.includes(palabraOfensiva) && palabra.length < palabraOfensiva.length + 3
    )
  );
}

function moderarContenidoAutomaticamente(noteId, content) {
  if (contienePalabrasOfensivas(content)) {
    firebase.database().ref('communityNotes/' + noteId).remove()
      .then(() => {
        console.log('Nota eliminada por contener lenguaje ofensivo');
        alert('Tu nota ha sido eliminada por contener lenguaje inapropiado.');
      });
    return true;
  }
  return false;
}

function contieneContenidoInapropiado(texto) {
  const patronesInapropiados = [
    /\b(?:porn|xxx)\b/i,
    /\b(?:kill|murder)\b/i,
    /\b(?:suicide|death)\b/i,
    /\b(?:cocaine|heroin|drugs)\b/i,
    /\b(?:terrorist|bomb)\b/i
  ];
  
  return patronesInapropiados.some(patron => patron.test(texto));
}

function moderarNota(noteId, content) {
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = `
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded-lg text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-[#FE2C55] mx-auto mb-4"></div>
        <p>Analizando contenido...</p>
      </div>
    </div>
  `;
  document.body.appendChild(loadingDiv);

  setTimeout(() => {
    document.body.removeChild(loadingDiv);
    
    if (contienePalabrasOfensivas(content)) {
      firebase.database().ref('communityNotes/' + noteId).remove();
      alert('La nota ha sido eliminada por contener lenguaje ofensivo.');
    } else if (contieneContenidoInapropiado(content)) {
      firebase.database().ref('communityNotes/' + noteId).update({
        blocked: true,
        blockReason: 'Contenido inapropiado detectado'
      });
      alert('La nota ha sido bloqueada por posible contenido inapropiado.');
    }
  }, 5000);
}

async function deleteNote(noteId) {
  if (!confirm('¬øEst√°s seguro de que quieres eliminar esta nota?')) return;
  
  try {
    const response = await fetch('/.netlify/functions/delete-note', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ noteId })
    });

    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Error al eliminar nota');
    }

    alert('Nota eliminada exitosamente');
    loadNotes(); // Recargar notas
  } catch (error) {
    console.error('Error al eliminar nota:', error);
    alert('Error al eliminar la nota');
  }
}

function reportNote(noteId) {
  alert('Funci√≥n de reporte enviada. El equipo revisar√° esta nota.');
}

async function likeNote(noteId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    try {
      const response = await fetch('/.netlify/functions/like-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          noteId: noteId,
          userId: user.uid 
        })
      });

      const result = await response.json();
      
      if (!response.ok) {
        if (result.error === 'User already liked this note') {
          console.log('Ya has dado like a esta nota');
        } else {
          throw new Error(result.error || 'Error al dar like');
        }
        return;
      }

      // Actualizar el contador en la UI
      const likeCountElement = document.getElementById(`like-count-${noteId}`);
      if (likeCountElement) {
        likeCountElement.textContent = result.likes;
      }

      // Deshabilitar el bot√≥n de like
      const likeBtn = document.getElementById(`like-btn-${noteId}`);
      if (likeBtn) {
        likeBtn.style.opacity = '0.6';
        likeBtn.style.pointerEvents = 'none';
        likeBtn.title = 'Ya has dado like a esta nota';
      }
    } catch (error) {
      console.error('Error al dar like:', error);
    }
}

  
</script>
</script>

<!-- JAVASCRIPT -->
<script>
  /*********************** FUNCIONES DE NAVEGACI√ìN **************************/
  function openHome() {
    document.getElementById('community-view').classList.add('hidden');
    document.getElementById('search-view').classList.add('hidden');
    document.getElementById('profile-view').classList.add('hidden');
    document.getElementById('creator-hub-view').classList.add('hidden');
    const mainApp = document.getElementById('main-app');
    if (mainApp) mainApp.classList.remove('hidden');
    
    // Mostrar la barra de navegaci√≥n superior cuando se vuelve al home
    const topNav = document.getElementById('top-navbar');
    if (topNav) topNav.style.display = 'flex';
  }

  function openSearch() {
    const mainApp = document.getElementById('main-app');
    if (mainApp) mainApp.classList.add('hidden');
    document.getElementById('search-view').classList.remove('hidden');
  }

  function openProfile() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    const mainApp = document.getElementById('main-app');
    if (mainApp) mainApp.classList.add('hidden');
    
    // Ocultar la barra de navegaci√≥n superior cuando se abre el perfil
    const topNav = document.getElementById('top-navbar');
    if (topNav) topNav.style.display = 'none';
    
    document.getElementById('profile-view').classList.remove('hidden');
    loadUserStats(user.uid);
  }

  function openNotifications() {
    const topNav = document.getElementById('top-navbar');
    if (topNav) topNav.style.display = 'none';
    document.getElementById('notifications-modal').classList.remove('hidden');
  }

  /*********************** CONFIGURACI√ìN DE FIREBASE **************************/
  const firebaseConfig = {
    apiKey: "AIzaSyBWBr3sud1_lDPmtLJI42pCBZnco5_vyCc",
    authDomain: "noble-amp-458106-g0.firebaseapp.com",
    databaseURL: "https://noble-amp-458106-g0-default-rtdb.firebaseio.com",
    projectId: "noble-amp-458106-g0",
    storageBucket: "noble-amp-458106-g0.firebasestorage.app",
    messagingSenderId: "744574411059",
    appId: "1:744574411059:web:72a70955f1400df6645e46",
    measurementId: "G-XEQ1J354HM"
  };
  firebase.initializeApp(firebaseConfig);
  const authorizedEmails = [];
  /*********************** FUNCIONES ADICIONALES **************************/
  async function loadPhotos() {
    const photosFeed = document.getElementById('photos-feed');
    if (!photosFeed) return;
    
    const photosContainer = photosFeed.querySelector('.grid');
    if (!photosContainer) return;
    
    photosContainer.innerHTML = '';

    try {
      const response = await fetch('/.netlify/functions/get-notes?limit=50');
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al cargar fotos');
      }

      const photos = (result.notes || []).filter(note => note.imageUrl);
      
      photos.forEach(photo => {
        const photoCard = document.createElement('div');
        photoCard.className = 'relative aspect-square cursor-pointer';
        photoCard.innerHTML = `
          <img src="${photo.imageUrl || ''}" alt="" class="w-full h-full object-cover">
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-2">
            <div class="flex items-center">
              <img src="${photo.authorImage || 'https://via.placeholder.com/150'}" alt="${photo.authorName || 'Usuario'}" class="w-6 h-6 rounded-full mr-2">
              <span class="text-white text-sm truncate">${photo.authorName || 'Usuario'}</span>
            </div>
          </div>
        `;
        photoCard.onclick = () => {
          openPhotoDetail(photo);
        };
        photosContainer.appendChild(photoCard);
      });
    } catch (error) {
      console.error('Error loading photos:', error);
      photosContainer.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Error al cargar fotos</div>';
    }
  }

  function openPhotoDetail(photo) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
      <div class="max-w-2xl w-full bg-white rounded-xl overflow-hidden">
        <img src="${photo.imageUrl || ''}" alt="" class="w-full h-auto">
        <div class="p-4">
          <div class="flex items-center mb-4">
            <img src="${photo.authorImage || 'https://via.placeholder.com/150'}" alt="${photo.authorName || 'Usuario'}" class="w-8 h-8 rounded-full mr-2">
            <span class="font-bold">${photo.authorName || 'Usuario'}</span>
          </div>
          ${photo.content ? `<p class="text-gray-700">${photo.content}</p>` : ''}
          <div class="mt-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button onclick="likePhoto('${photo.id || ''}')" class="flex items-center text-gray-600">
                <i class="fas fa-heart mr-1"></i>
                <span>${photo.likes || 0}</span>
              </button>
            </div>
            <span class="text-gray-500 text-sm">${new Date(photo.timestamp || Date.now()).toLocaleDateString()}</span>
          </div>
        </div>
      </div>
      <button onclick="this.parentElement.remove()" class="absolute top-4 right-4 text-white text-xl">
        <i class="fas fa-times"></i>
      </button>
    `;
    document.body.appendChild(modal);
  }

  function contienePalabrasOfensivas(texto) {
    // Lista de 20 palabras ofensivas en espa√±ol (ejemplo; aj√∫stala seg√∫n tus necesidades)
    const listaOfensiva = [
      "imb√©cil", "idiota", "est√∫pido", "tarado", "pendejo",
      "capullo", "gilipollas", "subnormal", "malparido", "bobo",
      "tonto", "in√∫til", "cretino", "est√∫pida", "pendeja",
      "zorra", "perra", "mierda", "cabr√≥n", "merda"
    ];
    // Normalizamos el texto: quitamos acentos y lo convertimos a min√∫sculas
    const textoNormalizado = texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
    // Se busca cada t√©rmino usando delimitadores para coincidir palabras completas
    return listaOfensiva.some(palabra => {
      const regex = new RegExp("\\b" + palabra + "\\b", "i");
      return regex.test(textoNormalizado);
    });
  }
  /*********************** VARIABLES Y ELEMENTOS DEL DOM **************************/
  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const submitButton = document.getElementById('submitButton');
  const toggleAuth = document.getElementById('toggleAuth');
  const authError = document.getElementById('authError');
  const authFormContainer = document.getElementById('auth-form');
  const mainApp = document.getElementById('main-app');
  let isLogin = true;
  let storyTypeSelected = "";
  let currentEditingStory = null;
  let currentChapters = [];
  let currentViewedAuthorId = null;
  let currentChapterEditId = null;
  let currentLanguage = 'es';

  function closeSearch() {
    document.getElementById('search-view').classList.add('hidden');
    const mainApp = document.getElementById('main-app');
    if (mainApp) mainApp.classList.remove('hidden');
  }

  function closeNotifications() {
    document.getElementById('notifications-modal').classList.add('hidden');
    const topNav = document.getElementById('top-navbar');
    if (topNav) topNav.style.display = 'flex';
  }

  function showLoader() {
    console.log('Loading...');
  }

  function hideLoader() {
    console.log('Loading complete');
  }
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electr√≥nico",
      passwordPlaceholder: "Contrase√±a",
      btnIniciarSesion: "Iniciar Sesi√≥n",
      btnToggleAuth: "¬øNo tienes cuenta? Reg√≠strate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "M√°s Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de b√∫squeda",
      searchBooks: "Libros",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biograf√≠a",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "T√≠tulo de la historia",
      selectCategory: "Selecciona una categor√≠a",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Cap√≠tulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Cap√≠tulo",
      chapterPlaceholder: "Escribe el contenido del cap√≠tulo aqu√≠...",
      btnSaveChapter: "Guardar Cap√≠tulo",
      readChapter: "Cap√≠tulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con √©xito. En breve recibir√°s una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biograf√≠a actualizada.",
      chapterAdded: "Cap√≠tulo agregado.",
      noEditingStory: "No hay historia en edici√≥n.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Cap√≠tulo no encontrado.",
      firstChapter: "Este es el primer cap√≠tulo.",
      lastChapter: "Este es el √∫ltimo cap√≠tulo.",
      chapterRated: "Cap√≠tulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia m√°s tarde desde tu perfil."
    },
    en: {
      /* Traducciones en ingl√©s */ },
    pt: {
      /* Traducciones en portugu√©s */ }
  };

  function getVerificationIcon(email) {
    if (email === "darelvega6@icloud.com" || email === "glamworksappstv@gmail.com" || email === "linapaolaromero99@gmail.com") {
      return '<img src="https://static.vecteezy.com/system/resources/previews/028/084/106/original/verified-check-mark-icon-png.png" alt="Verificado" class="inline-block w-4 h-4 ml-1">';
    }
    return "";
  }

  window.resetPassword = function() {
    const email = emailInput.value;
    if (!email) {
      alert("Please enter your email address to reset your password.");
      return;
    }
    firebase.auth().sendPasswordResetEmail(email)
      .then(() => {
        alert("A password reset email has been sent.");
      })
      .catch(error => {
        alert("Error sending email: " + error.message);
      });
  }

  function updateTranslations() {
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    document.getElementById('auth-title').innerText = translations[currentLanguage].authTitle;
    emailInput.placeholder = translations[currentLanguage].emailPlaceholder;
    passwordInput.placeholder = translations[currentLanguage].passwordPlaceholder;
    submitButton.innerText = translations[currentLanguage].btnIniciarSesion;
    toggleAuth.innerText = translations[currentLanguage].btnToggleAuth;
    document.getElementById('btn-volver-search').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-profile').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('btn-volver-author').innerText = translations[currentLanguage].btnVolver;
    document.getElementById('new-releases-title').innerText = translations[currentLanguage].newReleases;
    document.getElementById('top10-title').innerText = translations[currentLanguage].top10;
    document.getElementById('popular-title').innerText = translations[currentLanguage].popular;
    document.getElementById('terror-title').innerText = translations[currentLanguage].terror;
    document.getElementById('search-input').placeholder = translations[currentLanguage].searchPlaceholder;
    document.getElementById('search-results-title').innerText = translations[currentLanguage].searchResults;
    document.getElementById('search-books-title').innerText = translations[currentLanguage].searchBooks;
    document.getElementById('search-authors-title').innerText = translations[currentLanguage].searchAuthors;
    document.getElementById('profile-stories-title').innerText = translations[currentLanguage].profileStories;
    document.getElementById('story-type-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('create-story-title').innerText = translations[currentLanguage].createStory;
    document.getElementById('story-title').placeholder = translations[currentLanguage].storyTitlePlaceholder;
    document.getElementById('story-category').options[0].text = translations[currentLanguage].selectCategory;
    document.getElementById('btn-create-story').innerText = translations[currentLanguage].btnCreateStory;
    document.getElementById('edit-story-title').innerText = translations[currentLanguage].editStory;
    document.getElementById('chapter-creation-title').innerText = translations[currentLanguage].chapterCreationTitle;
    document.getElementById('chapter-content').placeholder = translations[currentLanguage].chapterPlaceholder;
    document.getElementById('btn-save-chapter').innerText = translations[currentLanguage].btnSaveChapter;
    document.getElementById('prev-chapter-btn').innerText = translations[currentLanguage].btnPrevChapter;
    document.getElementById('next-chapter-btn').innerText = translations[currentLanguage].btnNextChapter;
    document.getElementById('detail-synopsis').innerText = "Sinopsis de la historia...";
    document.getElementById('detail-metrics').innerHTML =
      `<span><strong>0</strong> Visitas</span>
         <span><strong>0</strong> ${translations[currentLanguage].ratings}</span>
         <span><strong>0</strong> Cap√≠tulos</span>`;
    document.getElementById('report-title').innerText = translations[currentLanguage].reportProfile;
    document.getElementById('report-instructions').innerText = translations[currentLanguage].reportInstructions;
    document.getElementById('btn-enviar-report').innerText = translations[currentLanguage].btnSendReport;
    document.getElementById('lang-modal-title').innerText = translations[currentLanguage].languageModalTitle;
  }

  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    localStorage.setItem("preferredLanguage", lang);
    
    // Aplicar traducci√≥n de Google Translate
    const selectField = document.querySelector('.goog-te-combo');
    if (selectField && lang !== 'en') {
      selectField.value = lang;
      selectField.dispatchEvent(new Event('change'));
    }
    
    const langOverlay = document.getElementById('lang-loading-overlay');
    if (langOverlay) {
      langOverlay.style.display = "flex";
      setTimeout(() => {
        updateTranslations();
        langOverlay.style.display = "none";
        const langModal = document.getElementById('language-modal');
        if (langModal) {
          langModal.style.display = "none";
        }
      }, 1000);
    }
  }
  window.addEventListener('load', () => {
    setTimeout(() => {
      const splash = document.getElementById('splash-screen');
      splash.style.opacity = '0';
      setTimeout(() => {
        splash.style.display = 'none';
      }, 1000);
    }, 3000);
  });
  /*********************** NOTIFICACIONES **************************/
  async function addNotification(userId, message, type = 'info') {
    try {
      const response = await fetch('/.netlify/functions/manage-notifications', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action: 'add',
          userId: userId,
          notification: {
            message: message,
            type: type
          }
        })
      });

      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.error || 'Error al crear notificaci√≥n');
      }
    } catch (error) {
      console.error('Error al crear notificaci√≥n:', error);
    }
    
    // Play sound based on notification type
    const audio = new Audio();
    switch(type) {
      case 'follow':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/213/213.wav';
        break;
      case 'like':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/208/208.wav';
        break;
      case 'comment':
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/221/221.wav';
        break;
      default:
        audio.src = 'https://assets.mixkit.co/active_storage/sfx/206/206.wav';
    }
    audio.play().catch(e => console.log('Audio play failed:', e));
    
    // Handle notifications for both mobile and desktop
    if ('Notification' in window) {
      if (Notification.permission === "granted") {
        new Notification("BeaBoo", {
          body: message,
          icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
          vibrate: [200, 100, 200]
        });
      } else if (Notification.permission !== "denied") {
        // Request permission on mobile
        try {
          const permission = await Notification.requestPermission();
          if (permission === "granted") {
            new Notification("BeaBoo", {
              body: message,
              icon: "https://cdn-icons-png.flaticon.com/512/907/907822.png",
              vibrate: [200, 100, 200]
            });
          }
        } catch (error) {
          console.log('Notification permission error:', error);
        }
      }
    }
    
    // Fallback vibration for mobile devices
    if (navigator.vibrate) {
      navigator.vibrate([200, 100, 200]);
    }
}

  function openNotifications() {
    showLoader();
    setTimeout(async () => {
      const currentUser = firebase.auth().currentUser;
      if (!currentUser) {
        hideLoader();
        return;
      }
      
      try {
        // Request notification permission if not granted (only on supported platforms)
        if ('Notification' in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
          Notification.requestPermission().catch(err => {
            console.log('Notification permission error:', err);
          });
        }
        
        // Ocultar la barra superior
        const topNav = document.getElementById('top-navbar');
        if (topNav) {
          topNav.style.display = 'none';
        }
        
        document.getElementById('notifications-modal').classList.remove('hidden');
        
        // Cargar notificaciones desde AWS S3
        const response = await fetch(`/.netlify/functions/manage-notifications?userId=${currentUser.uid}`);
        const result = await response.json();
        
        if (!response.ok) {
          console.error('Error al cargar notificaciones:', result.error);
          hideLoader();
          return;
        }

        const notificationsList = document.getElementById('notifications-list');
        notificationsList.innerHTML = "";
        
        const notifications = result.notifications || [];
        
        notifications.forEach(notification => {
          const div = document.createElement('div');
          div.className = `notification-item ${notification.type || 'info'}`;
          
          // Icon based on notification type
          const iconMap = {
            follow: 'user-plus',
            like: 'heart',
            comment: 'comment',
            info: 'info-circle'
          };
          
          div.innerHTML = `
            <div class="flex items-center gap-2">
              <i class="fas fa-${iconMap[notification.type || 'info']} ${notification.type}-icon"></i>
              <div class="flex-1">
                <div class="notification-message">${notification.message}</div>
                <div class="notification-time">${new Date(notification.timestamp).toLocaleString()}</div>
              </div>
              ${!notification.read ? '<span class="unread-dot"></span>' : ''}
            </div>
          `;
          
          // Mark as read when clicked
          const markAsRead = async () => {
            if (!notification.read) {
              try {
                await fetch('/.netlify/functions/manage-notifications', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    action: 'mark-read',
                    userId: currentUser.uid,
                    notificationId: notification.id
                  })
                });
              } catch (error) {
                console.error('Error al marcar como le√≠da:', error);
              }
            }
          };
          
          div.addEventListener('click', markAsRead);
          div.addEventListener('touchend', (e) => {
            e.preventDefault();
            markAsRead();
          });
          
          notificationsList.appendChild(div);
        });
        hideLoader();
      } catch (error) {
        console.error('Error loading notifications:', error);
        hideLoader();
      }
    }, 100);
  }

  function closeNotifications() {
    document.getElementById('notifications-modal').classList.add('hidden');
    
    // Mostrar la barra superior nuevamente
    const topNav = document.getElementById('top-navbar');
    if (topNav) {
      topNav.style.display = 'flex';
    }
  }
  function formatNumber(num) {
    if (num >= 1000000000) {
      return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
    }
    if (num >= 1000000) {
      return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
    }
    if (num >= 1000) {
      return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
    }
    return num.toString();
  }

  /*********************** AUTENTICACI√ìN **************************/
  function resetPassword() {
    const email = prompt('Ingresa tu correo electr√≥nico para restablecer tu contrase√±a:');
    if (email) {
      firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
          alert('Se ha enviado un correo para restablecer tu contrase√±a. Por favor revisa tu bandeja de entrada.');
        })
        .catch(error => {
          console.error('Error al enviar correo de restablecimiento:', error);
          alert('Error: ' + error.message);
        });
    }
  }

  toggleAuth.addEventListener('click', () => {
    isLogin = !isLogin;
    submitButton.textContent = isLogin ? 'Sign In' : 'Sign Up';
    toggleAuth.textContent = isLogin ? "Don't have an account? Sign up" : 'Already have an account? Sign in';
  });
  authForm.addEventListener('submit', e => {
    e.preventDefault();
    authError.classList.add('hidden');
    const email = emailInput.value;
    const password = passwordInput.value;
    if (isLogin) {
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          console.log("Usuario autenticado:", userCredential.user);
        })
        .catch(error => {
          console.error(error);
          authError.textContent = error.message;
          authError.classList.remove('hidden');
        });
    } else {
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          const user = userCredential.user;
          const userCountRef = firebase.database().ref('userCount');
          userCountRef.transaction(count => (count || 0) + 1).then(result => {
            const newCount = result.snapshot.val();
            const isVerified = newCount <= 100;
            firebase.database().ref('users/' + user.uid).set({
              username: "Nuevo Usuario",
              bio: "",
              profileImage: "",
              followersCount: 0,
              followingCount: 0,
              ratedCount: 0,
              isVerified: isVerified,
              registrationTimestamp: Date.now(),
              founder: false,
              email: user.email
            });
          });
        })
        .catch(error => {
          console.error(error);
          authError.textContent = error.message;
          authError.classList.remove('hidden');
        });
    }
  });
  firebase.auth().onAuthStateChanged(user => {
    // Aplicar traducci√≥n autom√°tica al cargar - MEJORADO
    const applyUserLanguage = () => {
      const preferredLang = localStorage.getItem('preferredLanguage') || 
                           (navigator.language || navigator.userLanguage).split('-')[0];
      
      console.log('Aplicando idioma del usuario:', preferredLang);
      
      if (preferredLang && preferredLang !== 'en') {
        const selectField = document.querySelector('.goog-te-combo');
        if (selectField) {
          // Mapeo de c√≥digos de idioma
          const langMap = {
            'es': 'es', 'pt': 'pt', 'fr': 'fr', 'de': 'de', 
            'it': 'it', 'ja': 'ja', 'ko': 'ko', 'zh': 'zh-CN',
            'ar': 'ar', 'hi': 'hi', 'ru': 'ru', 'tr': 'tr'
          };
          
          const targetLang = langMap[preferredLang] || preferredLang;
          selectField.value = targetLang;
          selectField.dispatchEvent(new Event('change'));
          console.log('Idioma aplicado:', targetLang);
        } else {
          // Reintentar si no est√° disponible
          setTimeout(applyUserLanguage, 500);
        }
      }
    };
    
    // Aplicar inmediatamente y tambi√©n despu√©s de un delay
    setTimeout(applyUserLanguage, 1000);
    setTimeout(applyUserLanguage, 3000);
    
    const authFormContainer = document.getElementById('auth-form');
    const mainAppContainer = document.getElementById('main-app');
    
    if (user) {
      // CARGAR ESTAD√çSTICAS EN TIEMPO REAL
      loadUserStats(user.uid);
      
      // Cargar historias de otros usuarios inmediatamente
      setTimeout(() => {
        const storiesScript = document.querySelector('script[src="stories.js"]');
        if (storiesScript && window.loadStories) {
          window.loadStories();
        }
      }, 1000);
      
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data && data.blocked && data.blockedUntil && Date.now() < data.blockedUntil) {
          alert("Tu cuenta ha sido bloqueada por infracciones. Por favor, contacta con el soporte para recuperar el acceso.");
          firebase.auth().signOut();
          return;
        }
        authFormContainer.style.display = 'none';
        mainAppContainer.style.display = 'flex';
        loadStories();
        loadUserStories(user.uid);
        initializeFeedSections();
        
        if (data) {
          let displayName = data.username || "Usuario";
          if (data.founder) {
            displayName += ' <span class="founder-tag">Fundador</span>';
          }
          displayName += getVerificationIcon(data.email);
          
          // Actualizar perfil m√≥vil
          document.getElementById('profile-username').innerHTML = displayName;
          document.getElementById('profile-followers').textContent = formatNumber(data.followersCount || 0);
          document.getElementById('profile-following').textContent = formatNumber(data.followingCount || 0);
          
          // Actualizar perfil desktop
          const usernameDesktop = document.getElementById('profile-username-desktop');
          const followersDesktop = document.getElementById('profile-followers-desktop');
          const followingDesktop = document.getElementById('profile-following-desktop');
          
          if (usernameDesktop) usernameDesktop.innerHTML = displayName;
          if (followersDesktop) followersDesktop.textContent = formatNumber(data.followersCount || 0);
          if (followingDesktop) followingDesktop.textContent = formatNumber(data.followingCount || 0);
          
          if (data.bio) {
            const bioElement = document.getElementById('profile-bio');
            if (bioElement) bioElement.value = data.bio;
          }
          if (data.profileImage) {
            document.getElementById('profile-image').src = data.profileImage;
            const profileImageDesktop = document.getElementById('profile-image-desktop');
            if (profileImageDesktop) profileImageDesktop.src = data.profileImage;
          }
          
          // Cargar marco del perfil del usuario
          loadUserFrame(user.uid, 'profile-frame');
          loadUserFrame(user.uid, 'profile-frame-desktop');
        }
      });
    } else {
      authFormContainer.style.display = 'flex';
      mainAppContainer.style.display = 'none';
    }
  });
  /*********************** AUTENTICACI√ìN CON GOOGLE Y FACEBOOK **************************/
  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Google sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesi√≥n con Google:", error);
      });
  }

  function signInWithFacebook() {
    const provider = new firebase.auth.FacebookAuthProvider();
    firebase.auth().signInWithPopup(provider)
      .then(result => {
        console.log("Facebook sign-in successful:", result.user);
      })
      .catch(error => {
        console.error("Error al iniciar sesi√≥n con Facebook:", error);
      });
  }
  /*********************** CERRAR SESI√ìN CON SPINNER **************************/
  function signOutUser() {
    const spinner = document.getElementById('signout-spinner');
    spinner.style.display = "flex";
    setTimeout(() => {
      firebase.auth().signOut()
        .then(() => {
          spinner.style.display = "none";
          alert("Has cerrado sesi√≥n.");
        })
        .catch(error => {
          spinner.style.display = "none";
          console.error("Error al cerrar sesi√≥n:", error);
        });
    }, 3000);
  }
  
  
  /*********************** NAVEGACI√ìN Y MODALES **************************/
  function openStoryDetail(story) {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    console.log('Abriendo historia:', story); // Debug
    
    window.currentStoryId = story.id;
    listenForStoryBlock(story.id);
    
    const viewRef = firebase.database().ref('storyViews/' + story.id + '/' + user.uid);
    viewRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        viewRef.set(true);
        const storyViewsRef = firebase.database().ref('stories/' + story.id + '/views');
        storyViewsRef.transaction(current => (current || 0) + 1);
      }
    });
    
    // Actualizar contenido del modal
    document.getElementById('detail-cover').src = story.coverImage || '/api/placeholder/800/400';
    document.getElementById('detail-title').textContent = story.title;
    let authorDisplay = (story.username || "Autor Desconocido") + getVerificationIcon(story.email || "");
    document.getElementById('detail-author').innerHTML = "Por " + authorDisplay;
    document.getElementById('detail-author').dataset.userid = story.userId;
    document.getElementById('detail-author').onclick = () => openAuthorProfile(story.userId);
    document.getElementById('detail-synopsis').textContent = story.synopsis || "Sinopsis no disponible.";
    
    // Cargar cap√≠tulos
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      const chaptersList = document.getElementById('detail-chapters');
      chaptersList.innerHTML = "";
      currentChapters = [];
      let chapterCount = snapshot.numChildren();
      let totalRating = 0, ratingCount = 0;
      
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
        const li = document.createElement('li');
        li.className = "p-4 border border-gray-200 rounded-xl hover:bg-gray-50 flex justify-between items-center";
        li.innerHTML = `<span class="text-black font-medium">Cap√≠tulo ${chapter.chapterNumber}</span>
                          <button class="bg-[#FE2C55] text-white px-3 py-2 rounded-lg hover:bg-red-600 transition-colors font-medium" onclick='openChapterReadModal("${story.id}", "${child.key}")'>Leer</button>`;
        chaptersList.appendChild(li);
        
        if (chapter.ratings) {
          Object.values(chapter.ratings).forEach(r => {
            totalRating += r;
            ratingCount++;
          });
        }
      });
      
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentEditingStory = {
        id: story.id,
        currentChapterId: currentChapters.length ? currentChapters[0].id : null
      };
      
      let overallRating = ratingCount ? (totalRating / ratingCount).toFixed(1) : 0;
      document.getElementById('detail-metrics').innerHTML =
        `<div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${story.views || 0}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Visitas</p>
        </div>
        <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${overallRating}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Rating</p>
        </div>
        <div class="bg-white p-2 rounded-lg shadow-sm flex flex-col items-center w-20">
          <span class="text-lg font-bold text-black">${chapterCount}</span>
          <p class="text-xs text-[#FE2C55] mt-1">Cap√≠tulos</p>
        </div>`;
    });
    
    // Mostrar el modal
    const modal = document.getElementById('story-detail-modal');
    const mainAppElement = document.getElementById('main-app');
    
    console.log('Modal element:', modal); // Debug
    console.log('MainApp element:', mainAppElement); // Debug
    
    if (modal && mainAppElement) {
      modal.classList.remove('hidden');
      mainAppElement.classList.add('hidden');
      console.log('Modal mostrado correctamente'); // Debug
    } else {
      console.error('No se pudo encontrar el modal o main-app'); // Debug
    }
  }

  function closeStoryDetail() {
    const modal = document.getElementById('story-detail-modal');
    const mainAppElement = document.getElementById('main-app');
    
    if (modal) {
      modal.classList.add('hidden');
    }
    if (mainAppElement) {
      mainAppElement.classList.remove('hidden');
    }
  }

  function openStoryEdit(story) {
    currentEditingStory = story;
    document.getElementById('edit-story-language').value = story.language || "";
    firebase.database().ref('stories/' + story.id + '/chapters').on('value', snapshot => {
      currentChapters = [];
      const chapterListDiv = document.getElementById('chapter-list');
      chapterListDiv.innerHTML = "";
      snapshot.forEach(child => {
        const chapter = child.val();
        chapter.id = child.key;
        currentChapters.push(chapter);
      });
      currentChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
      currentChapters.forEach(chapter => {
        const div = document.createElement('div');
        div.className = "flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 border border-gray-200 rounded-xl mb-2";
        const chapterInfo = document.createElement('div');
        chapterInfo.innerHTML = `<span class="font-semibold">${translations[currentLanguage].readChapter} ${chapter.chapterNumber}</span>`;
        const btnContainer = document.createElement('div');
        btnContainer.className = "flex space-x-2 mt-2 sm:mt-0";
        const editButton = document.createElement('button');
        editButton.className = "bg-blue-500 text-white px-2 py-1 rounded";
        editButton.textContent = "Editar";
        editButton.onclick = () => openChapterEditModal(chapter);
        const deleteButton = document.createElement('button');
        deleteButton.className = "bg-red-500 text-white px-2 py-1 rounded";
        deleteButton.textContent = "Eliminar";
        deleteButton.onclick = () => deleteChapter(chapter.id);
        btnContainer.appendChild(editButton);
        btnContainer.appendChild(deleteButton);
        div.appendChild(chapterInfo);
        div.appendChild(btnContainer);
        chapterListDiv.appendChild(div);
      });
    });
    document.getElementById('story-edit-view').classList.remove('hidden');
  }

  function closeStoryEdit() {
    document.getElementById('story-edit-view').classList.add('hidden');
    alert(translations[currentLanguage].editLater);
  }

  function saveStoryEdits() {
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    const newLanguage = document.getElementById('edit-story-language').value;
    firebase.database().ref('stories/' + currentEditingStory.id).update({
        language: newLanguage
      })
      .then(() => {
        currentEditingStory.language = newLanguage;
        alert("Cambios guardados en la historia.");
      })
      .catch(error => {
        console.error("Error al actualizar la historia:", error);
      });
  }

  function openProfile() {
    showLoader();
    setTimeout(() => {
      mainApp.classList.add('hidden');
      
      // Ocultar la barra de navegaci√≥n superior cuando se abre el perfil
      const topNav = document.getElementById('top-navbar');
      if (topNav) topNav.style.display = 'none';
      
      document.getElementById('profile-view').classList.remove('hidden');
      hideLoader();
    }, 300);
  }

  function openHome() {
    showLoader();
    setTimeout(() => {
      document.getElementById('profile-view').classList.add('hidden');
      mainApp.classList.remove('hidden');
      
      // Mostrar la barra de navegaci√≥n superior cuando se vuelve al home
      const topNav = document.getElementById('top-navbar');
      if (topNav) topNav.style.display = 'flex';
      
      hideLoader();
    }, 300);
  }

  function openSearch() {
    mainApp.classList.add('hidden');
    document.getElementById('search-view').classList.remove('hidden');
  }

  function closeSearch() {
    document.getElementById('search-view').classList.add('hidden');
    mainApp.classList.remove('hidden');
  }
  function performRealTimeSearch() {
  const query = document.getElementById('search-input').value.trim().toLowerCase();
  const category = document.getElementById('category-filter').value;
  
  firebase.database().ref('stories').once('value').then(snapshot => {
    let books = [];
    snapshot.forEach(child => {
      const story = child.val();
      const matchesQuery = story.title && story.title.toLowerCase().includes(query);
      const matchesCategory = !category || story.category === category;
      
      if (matchesQuery && matchesCategory) {
        books.push(story);
      }
    });
    
    renderBooksCarousel(books);
    
    // Obtener autores que coincidan con la b√∫squeda
    firebase.database().ref('users').once('value').then(userSnapshot => {
      let authors = [];
      userSnapshot.forEach(child => {
        const user = child.val();
        if (user.username && user.username.toLowerCase().includes(query)) {
          authors.push(user);
        }
      });
      renderAuthorsList(authors);
      document.getElementById('search-loading').classList.remove('loading-active'); // Ocultar animaci√≥n
    });
  });
}

document.getElementById('search-input').addEventListener('input', function() {
  document.getElementById('search-loading').classList.add('loading-active');
  performRealTimeSearch();
});

document.getElementById('category-filter').addEventListener('change', function() {
  document.getElementById('search-loading').classList.add('loading-active');
  performRealTimeSearch();
});

async function performSearch(query) {
  document.getElementById('search-loading').classList.add('loading-active');
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // Buscar historias
  const storiesSnapshot = await firebase.database().ref('stories').once('value');
  let books = [];
  storiesSnapshot.forEach(child => {
    const story = child.val();
    if (story.title && story.title.toLowerCase().includes(query)) books.push(story);
  });
  renderBooksCarousel(books);
  
  // Buscar autores
  const usersSnapshot = await firebase.database().ref('users').once('value');
  let authors = [];
  usersSnapshot.forEach(child => {
    const user = child.val();
    if (user.username && user.username.toLowerCase().includes(query)) authors.push(user);
  });
  renderAuthorsList(authors);
  
  // Buscar notas
  const notesSnapshot = await firebase.database().ref('communityNotes').once('value');
  let notes = [];
  notesSnapshot.forEach(child => {
    const note = child.val();
    if (note.content && note.content.toLowerCase().includes(query)) {
      notes.push({...note, id: child.key});
    }
  });
  renderNotesList(notes);
  
  document.getElementById('search-loading').classList.remove('loading-active');
}

  function renderBooksCarousel(books) {
    const carousel = document.getElementById('search-books-carousel');
    carousel.innerHTML = '';
    books.forEach(book => {
      const card = document.createElement('div');
      card.className = 'flex-shrink-0 w-48 cursor-pointer';
      card.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md">
            <img src="${book.coverImage || '/api/placeholder/200/300'}" alt="${book.title}" class="w-full h-56 object-cover">
          </div>
          <p class="mt-2 text-sm font-semibold">${book.title}</p>
        `;
      card.addEventListener('click', () => openStoryDetail(book));
      carousel.appendChild(card);
    });
  }

  function renderAuthorsList(authors) {
    const list = document.getElementById('search-authors-list');
    list.innerHTML = '';
    authors.forEach(author => {
      const item = document.createElement('div');
      item.className = 'flex items-center space-x-4 cursor-pointer';
      let verifiedIcon = getVerificationIcon(author.email || "");
      item.innerHTML = `
          <img src="${author.profileImage || 'https://via.placeholder.com/50'}" alt="${author.username}" class="w-12 h-12 rounded-full object-cover">
          <span class="font-semibold">${author.username}${verifiedIcon}</span>
        `;
      item.addEventListener('click', () => openAuthorProfile(author.uid));
      list.appendChild(item);
    });
  }

  function renderNotesList(notes) {
    const list = document.getElementById('search-notes-list');
    list.innerHTML = '';
    
    if (notes.length === 0) {
      list.innerHTML = `
        <div class="text-center py-8">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <p class="text-gray-500">No se encontraron notas</p>
        </div>
      `;
      return;
    }
    
    notes.forEach(note => {
      firebase.database().ref('users/' + note.authorId).once('value').then(authorSnap => {
        const authorData = authorSnap.val() || {};
        const item = document.createElement('div');
        item.className = 'bg-gray-50 p-4 rounded-xl hover:bg-gray-100 transition-colors cursor-pointer';
        item.innerHTML = `
          <div class="flex items-start space-x-3 mb-3">
            <img src="${authorData.profileImage || 'https://via.placeholder.com/50'}" alt="${authorData.username}" class="w-10 h-10 rounded-full object-cover">
            <div class="flex-1">
              <div class="font-semibold text-sm">${authorData.username || 'Usuario'}</div>
              <div class="text-xs text-gray-500">${new Date(note.timestamp).toLocaleDateString()}</div>
            </div>
          </div>
          <p class="text-gray-800 mb-2">${note.content}</p>
          ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de la nota" class="w-full rounded-lg mb-2 max-h-40 object-cover">` : ''}
          <div class="flex items-center space-x-4 text-sm text-gray-500">
            <span><i class="far fa-heart mr-1"></i>${note.likes || 0}</span>
            <span><i class="far fa-comment mr-1"></i>${note.commentsCount || 0}</span>
          </div>
        `;
        item.addEventListener('click', () => {
          // Abrir la comunidad y mostrar la nota
          openCommunity();
          setTimeout(() => {
            const noteElement = document.querySelector(`[data-note-id="${note.id}"]`);
            if (noteElement) {
              noteElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 300);
        });
        list.appendChild(item);
      });
    });
  }
  /*********************** PERFIL (Propio) **************************/
  function uploadProfileImage() {
    document.getElementById('profile-image-input').click();
  }

  async function handleProfileImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const user = firebase.auth().currentUser;
    if (!user) return;

    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64String = e.target.result;
        const timestamp = Date.now();

        const response = await fetch('/.netlify/functions/upload-image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            imageData: base64String,
            fileName: file.name,
            userId: user.uid,
            timestamp: timestamp,
            contentType: file.type,
            imageType: 'profile'
          })
        });
      };
      
      reader.onerror = (error) => {
        console.error("Error al convertir la imagen a base64:", error);
        alert('Error al procesar la imagen');
      };
      
      reader.readAsDataURL(file);
    } catch (error) {
      console.error("Error al subir imagen de perfil:", error);
      alert('Error al subir la imagen de perfil');
    }
  }

  function editUsername() {
    openProfileEdit();
  }

  function saveBio() {
    const bio = document.getElementById('profile-bio').value;
    const user = firebase.auth().currentUser;
    firebase.database().ref('users/' + user.uid).update({
        bio
      })
      .then(() => {
        addNotification(user.uid, translations[currentLanguage].bioUpdated);
        alert(translations[currentLanguage].bioUpdated);
      })
      .catch(error => {
        console.error("Error al actualizar la biograf√≠a:", error);
      });
  }
  // Funci√≥n para convertir un archivo a una cadena Base64
  function convertFileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        resolve(e.target.result);
      };
      reader.onerror = (error) => {
        reject("Error al convertir la imagen: " + error);
      };
      reader.readAsDataURL(file);
    });
  }
  /*********************** MODAL DE EDICI√ìN DE PERFIL **************************/
  function openProfileEdit() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Ocultar la barra de navegaci√≥n superior cuando se abre la edici√≥n de perfil
    const topNav = document.getElementById('top-navbar');
    if (topNav) topNav.style.display = 'none';
    
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      
      // Campos m√≥viles
      document.getElementById('edit-name').value = data.name || "";
      document.getElementById('edit-username').value = data.username || "";
      document.getElementById('edit-pronouns').value = data.pronouns || "";
      document.getElementById('edit-bio').value = data.bio || "";
      document.getElementById('edit-instagram').value = data.instagram || "";
      document.getElementById('edit-tiktok').value = data.tiktokUsername || "";
      document.getElementById('edit-website').value = data.website || "";
      document.getElementById('edit-city').value = data.city || "";
      document.getElementById('edit-gender').value = data.gender || "";
      document.getElementById('edit-birthday').value = data.birthday || "";
      document.getElementById('edit-profile-image-mobile').src = data.profileImage || "https://via.placeholder.com/150";
      
      // Campos desktop
      const usernameDesktop = document.getElementById('edit-username-desktop');
      const emailDesktop = document.getElementById('edit-email-desktop');
      const firstNameDesktop = document.getElementById('edit-first-name-desktop');
      const lastNameDesktop = document.getElementById('edit-last-name-desktop');
      const birthdayDesktop = document.getElementById('edit-birthday-desktop');
      const genderDesktop = document.getElementById('edit-gender-desktop');
      const cityDesktop = document.getElementById('edit-city-desktop');
      const websiteDesktop = document.getElementById('edit-website-desktop');
      const bioDesktop = document.getElementById('edit-bio-desktop');
      const profileImageDesktop = document.getElementById('edit-profile-image-desktop');
      const followersDesktop = document.getElementById('edit-followers-desktop');
      const followingDesktop = document.getElementById('edit-following-desktop');
      const storiesDesktop = document.getElementById('edit-stories-count-desktop');
      
      if (usernameDesktop) usernameDesktop.value = data.username || "";
      if (emailDesktop) emailDesktop.value = user.email || "";
      if (firstNameDesktop) firstNameDesktop.value = data.firstName || "";
      if (lastNameDesktop) lastNameDesktop.value = data.lastName || "";
      if (birthdayDesktop) birthdayDesktop.value = data.birthday || "";
      if (genderDesktop) genderDesktop.value = data.gender || "male";
      if (cityDesktop) cityDesktop.value = data.city || "";
      if (websiteDesktop) websiteDesktop.value = data.website || "";
      if (bioDesktop) bioDesktop.value = data.bio || "";
      if (profileImageDesktop) profileImageDesktop.src = data.profileImage || "https://via.placeholder.com/200";
      if (followersDesktop) followersDesktop.textContent = formatNumber(data.followersCount || 0);
      if (followingDesktop) followingDesktop.textContent = formatNumber(data.followingCount || 0);
      
      // Cargar campos de redes sociales en desktop
      const instagramDesktop = document.getElementById('edit-instagram-desktop');
      const tiktokDesktop = document.getElementById('edit-tiktok-desktop');
      
      if (instagramDesktop) instagramDesktop.value = data.instagram || "";
      if (tiktokDesktop) tiktokDesktop.value = data.tiktokUsername || "";
      
      firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value').then(snapshot => {
        if (storiesDesktop) storiesDesktop.textContent = snapshot.numChildren();
      });
      
      document.getElementById('profile-edit-modal').style.display = "block";
    });
  }

  // La funcionalidad de subida de foto usa handleEditProfileImageUpload (unificada)

  function loadUserNotes() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Cargar notas para desktop
    const notesDesktop = document.getElementById('user-notes-desktop');
    const notesHeaderDesktop = document.getElementById('profile-notes-header');
    
    // Cargar notas para m√≥vil
    const notesMobile = document.getElementById('user-notes-mobile');
    const notesTitleMobile = document.getElementById('profile-notes-title');
    
    firebase.database().ref('communityNotes').orderByChild('authorId').equalTo(user.uid).once('value').then(snapshot => {
      const notesCount = snapshot.numChildren();
      
      if (notesHeaderDesktop) {
        notesHeaderDesktop.textContent = `${notesCount} Notas`;
      }
      if (notesTitleMobile) {
        notesTitleMobile.textContent = `${notesCount} Notas`;
      }
      
      if (snapshot.exists()) {
        const notes = [];
        snapshot.forEach(child => {
          notes.push({...child.val(), id: child.key});
        });
        
        notes.sort((a, b) => b.timestamp - a.timestamp);
        
        // Renderizar en desktop
        if (notesDesktop) {
          notesDesktop.innerHTML = '';
          notes.forEach(note => {
            const noteCard = document.createElement('div');
            noteCard.className = 'bg-white p-6 rounded-xl border hover:shadow-md transition-shadow cursor-pointer';
            noteCard.innerHTML = `
              <div class="flex items-start space-x-4">
                ${note.imageUrl ? `
                  <img src="${note.imageUrl}" alt="Imagen de la nota" class="w-32 h-32 rounded-lg object-cover flex-shrink-0">
                ` : ''}
                <div class="flex-1">
                  <p class="mb-3 text-gray-800">${note.content}</p>
                  <div class="flex items-center justify-between text-sm text-gray-500">
                    <span><i class="far fa-calendar mr-1"></i>${new Date(note.timestamp).toLocaleDateString()}</span>
                    <div class="flex items-center space-x-4">
                      <span><i class="far fa-heart mr-1"></i>${note.likes || 0}</span>
                      <span><i class="far fa-comment mr-1"></i>${note.commentsCount || 0}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            notesDesktop.appendChild(noteCard);
          });
        }
        
        // Renderizar en m√≥vil
        if (notesMobile) {
          notesMobile.innerHTML = '';
          notes.forEach(note => {
            const noteCard = document.createElement('div');
            noteCard.className = 'bg-white p-4 rounded-xl border hover:shadow-md transition-shadow';
            noteCard.innerHTML = `
              <p class="mb-3">${note.content}</p>
              ${note.imageUrl ? `<img src="${note.imageUrl}" alt="Imagen de la nota" class="w-full rounded-lg mb-3 max-h-48 object-cover">` : ''}
              <div class="flex items-center justify-between text-sm text-gray-500">
                <span><i class="far fa-calendar mr-1"></i>${new Date(note.timestamp).toLocaleDateString()}</span>
                <div class="flex items-center space-x-3">
                  <span><i class="far fa-heart mr-1"></i>${note.likes || 0}</span>
                  <span><i class="far fa-comment mr-1"></i>${note.commentsCount || 0}</span>
                </div>
              </div>
            `;
            notesMobile.appendChild(noteCard);
          });
        }
      } else {
        // No hay notas
        const emptyMessage = `
          <div class="text-center py-12">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <p class="text-gray-600 mb-4">No has publicado ninguna nota a√∫n</p>
            <button onclick="openNoteCreation()" class="bg-[#FE2C55] text-white px-6 py-2 rounded-xl hover:bg-red-600 transition-all">
              Crear primera nota
            </button>
          </div>
        `;
        if (notesDesktop) notesDesktop.innerHTML = emptyMessage;
        if (notesMobile) notesMobile.innerHTML = emptyMessage;
      }
    });
  }

  function switchProfileTab(tabName) {
    // Para m√≥vil
    const storiesContent = document.getElementById('mobile-stories-content');
    const notesContent = document.getElementById('mobile-notes-content');
    const storiesTab = document.getElementById('mobile-stories-tab');
    const notesTab = document.getElementById('mobile-notes-tab');
    
    if (storiesContent && notesContent && storiesTab && notesTab) {
      if (tabName === 'stories') {
        storiesContent.classList.remove('hidden');
        notesContent.classList.add('hidden');
        storiesTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
        storiesTab.classList.remove('text-gray-500');
        notesTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
        notesTab.classList.add('text-gray-500');
      } else if (tabName === 'notes') {
        notesContent.classList.remove('hidden');
        storiesContent.classList.add('hidden');
        notesTab.classList.add('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
        notesTab.classList.remove('text-gray-500');
        storiesTab.classList.remove('text-[#FE2C55]', 'border-b-2', 'border-[#FE2C55]');
        storiesTab.classList.add('text-gray-500');
        
        // Cargar notas cuando se cambia al tab
        loadUserNotes();
      }
    }
  }

  function closeProfileEdit() {
    document.getElementById('profile-edit-modal').style.display = "none";
    
    // No necesitamos mostrar el navbar aqu√≠ porque el modal de edici√≥n se abre sobre el perfil
    // que ya tiene el navbar oculto
  }

  function saveProfileEdits() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    // Detectar si estamos en m√≥vil o desktop
    const isMobile = window.innerWidth < 1024;
    const newUsername = isMobile ? 
      document.getElementById('edit-username').value : 
      document.getElementById('edit-username-desktop').value;
    
    // Validar cambio de nombre de usuario (solo cada 7 d√≠as)
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const userData = snapshot.val() || {};
      const lastUsernameChange = userData.lastUsernameChange || 0;
      const timeSinceLastChange = Date.now() - lastUsernameChange;
      const USERNAME_CHANGE_COOLDOWN = 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
      
      if (newUsername !== userData.username && timeSinceLastChange < USERNAME_CHANGE_COOLDOWN) {
        const daysLeft = Math.ceil((USERNAME_CHANGE_COOLDOWN - timeSinceLastChange) / (24 * 60 * 60 * 1000));
        alert(`No puedes cambiar tu nombre de usuario hasta dentro de ${daysLeft} d√≠as.`);
        return;
      }
      
      let updates = {};
      
      if (isMobile) {
        // Datos desde campos m√≥viles
        updates = {
          name: document.getElementById('edit-name').value,
          username: newUsername,
          pronouns: document.getElementById('edit-pronouns').value,
          bio: document.getElementById('edit-bio').value,
          instagram: document.getElementById('edit-instagram').value,
          tiktokUsername: document.getElementById('edit-tiktok').value,
          website: document.getElementById('edit-website').value,
          city: document.getElementById('edit-city').value,
          gender: document.getElementById('edit-gender').value,
          birthday: document.getElementById('edit-birthday').value
        };
      } else {
        // Datos desde campos desktop
        updates = {
          username: newUsername,
          firstName: document.getElementById('edit-first-name-desktop').value,
          lastName: document.getElementById('edit-last-name-desktop').value,
          bio: document.getElementById('edit-bio-desktop').value,
          website: document.getElementById('edit-website-desktop').value,
          instagram: document.getElementById('edit-instagram-desktop').value,
          tiktokUsername: document.getElementById('edit-tiktok-desktop').value,
          city: document.getElementById('edit-city-desktop').value,
          gender: document.getElementById('edit-gender-desktop').value,
          birthday: document.getElementById('edit-birthday-desktop').value
        };
      }
      
      // Si cambi√≥ el nombre de usuario, actualizar timestamp
      if (newUsername !== userData.username) {
        updates.lastUsernameChange = Date.now();
      }
      if (updates.username === "darheel_") {
        updates.followersCount = 19000;
        updates.founder = true;
        updates.isVerified = true;
      }
      
      firebase.database().ref('users/' + user.uid).update(updates)
        .then(() => {
          addNotification(user.uid, translations[currentLanguage].usernameUpdated);
          let newName = updates.username;
          if (updates.founder) {
            newName += ' <span class="founder-tag">Fundador</span>';
          }
          newName += getVerificationIcon(updates.email || user.email);
          document.getElementById('profile-username').innerHTML = newName;
          alert("Perfil actualizado");
          closeProfileEdit();
        })
        .catch(error => {
          console.error("Error al guardar cambios en el perfil:", error);
        });
    });
  }

  function uploadEditProfileImage() {
    document.getElementById('edit-profile-image-input').click();
  }

  // DUPLICADO REMOVIDO - La funci√≥n handleEditProfileImageUpload ya est√° definida arriba en la l√≠nea 3245

  // Funci√≥n para conectar con TikTok
  function connectTikTok() {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n primero');
      return;
    }

    // Configuraci√≥n de TikTok OAuth
    const CLIENT_KEY = 'aw5rur2hdvmp1wly';
    const REDIRECT_URI = encodeURIComponent(window.location.origin + '/tiktok-callback');
    const STATE = user.uid; // Usamos el UID como state para seguridad
    
    // URL de autorizaci√≥n de TikTok
    const authUrl = `https://www.tiktok.com/v2/auth/authorize/?client_key=${CLIENT_KEY}&scope=user.info.basic&response_type=code&redirect_uri=${REDIRECT_URI}&state=${STATE}`;
    
    // Abrir ventana de autorizaci√≥n
    const authWindow = window.open(authUrl, 'TikTok Authorization', 'width=600,height=700');
    
    // Escuchar el mensaje de retorno
    window.addEventListener('message', function(event) {
      if (event.data.type === 'tiktok-auth-success') {
        const tiktokUsername = event.data.username;
        
        // Guardar en Firebase
        firebase.database().ref('users/' + user.uid).update({
          tiktokUsername: tiktokUsername,
          tiktokConnected: true
        }).then(() => {
          // Actualizar campos en la UI
          document.getElementById('edit-tiktok').value = '@' + tiktokUsername;
          const tiktokDesktop = document.getElementById('edit-tiktok-desktop');
          if (tiktokDesktop) {
            tiktokDesktop.value = '@' + tiktokUsername;
          }
          
          alert('¬°TikTok conectado exitosamente!');
          authWindow.close();
        });
      }
    });
  }

  // Manejar el callback de TikTok (para la p√°gina de redirecci√≥n)
  if (window.location.pathname === '/tiktok-callback') {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    
    if (code && state) {
      // Aqu√≠ normalmente har√≠as una llamada a tu backend para intercambiar el code por un access token
      // Por simplicidad, simulamos la obtenci√≥n del username
      // En producci√≥n, necesitar√≠as un servidor backend para manejar esto de forma segura
      
      // Enviar mensaje a la ventana principal
      if (window.opener) {
        window.opener.postMessage({
          type: 'tiktok-auth-success',
          username: 'usuario_tiktok' // Esto vendr√≠a de la API de TikTok
        }, window.location.origin);
      }
    }
  }
  /*********************** PERFIL DEL AUTOR **************************/
  function openAuthorProfile(authorId) {
    document.getElementById('story-detail-modal').classList.add('hidden');
    
    // Check if current user is the profile owner
    const currentUser = firebase.auth().currentUser;
    const addNoteBtn = document.getElementById('add-note-btn');
    const profileNote = document.getElementById('profile-note');
    const messageButton = document.getElementById('message-author-button');
    
    if (currentUser && currentUser.uid === authorId) {
      if (addNoteBtn) addNoteBtn.classList.remove('hidden');
      if (messageButton) messageButton.style.display = 'none'; // Ocultar bot√≥n de mensaje para el propio perfil
    } else {
      if (addNoteBtn) addNoteBtn.classList.add('hidden');
      if (messageButton) messageButton.style.display = 'block'; // Mostrar bot√≥n de mensaje para otros perfiles
    }

    // Check for existing note
    firebase.database().ref('profileNotes/' + authorId).once('value').then(snapshot => {
      const noteData = snapshot.val();
      if (noteData && noteData.text && noteData.timestamp) {
        const expirationTime = noteData.timestamp + (12 * 60 * 60 * 1000); // 12 hours
        if (Date.now() < expirationTime) {
          profileNote.classList.remove('hidden');
          document.getElementById('note-text').textContent = noteData.text;
          const timeLeft = Math.floor((expirationTime - Date.now()) / (60 * 60 * 1000));
          document.getElementById('note-time').textContent = `Expira en ${timeLeft} horas`;
        } else {
          profileNote.classList.add('hidden');
          snapshot.ref.remove(); // Remove expired note
        }
      } else {
        profileNote.classList.add('hidden');
      }
    });
    firebase.database().ref('users/' + authorId).once('value').then(snapshot => {
      const authorData = snapshot.val();
      if (!authorData || (authorData.blocked && authorData.blockedUntil && Date.now() < authorData.blockedUntil)) {
        document.getElementById('blocked-error-modal').style.display = "flex";
        return;
      }
      let authorNameHTML = authorData.username || 'Autor desconocido';
      if (authorData.founder) {
        authorNameHTML += ' <span class="founder-tag">Fundador</span>';
      }
      authorNameHTML += getVerificationIcon(authorData.email || "");
      document.getElementById('author-profile-name').innerHTML = authorNameHTML;
      document.getElementById('author-profile-image').src = authorData.profileImage || 'https://via.placeholder.com/150';
      document.getElementById('author-followers').textContent = formatNumber(authorData.followersCount || 0);
      document.getElementById('author-following').textContent = formatNumber(authorData.followingCount || 0);
      document.getElementById('author-rated').textContent = authorData.ratedCount || 0;
      
      // Cargar marco del perfil del autor en tiempo real
      loadUserFrame(authorId, 'author-profile-frame');
      
      // Tambi√©n actualizar la imagen del autor en b√∫squedas si existe
      setTimeout(() => {
        const searchResults = document.querySelectorAll(`[data-author-id="${authorId}"]`);
        searchResults.forEach(element => {
          loadUserFrame(authorId, element.id + '-frame');
        });
      }, 500);
      let socialLinksHTML = "";
      if (authorData.instagram) {
        socialLinksHTML += `<a href="${authorData.instagram}" target="_blank"><img src="https://img.utdstc.com/icon/847/f33/847f33af27bea889ccaa9b1d25135b42ff5bb590297182d0983afb7304d96884:200" alt="Instagram" class="w-6 h-6"></a>`;
      }
      if (authorData.tiktokUsername) {
        socialLinksHTML += `<a href="https://www.tiktok.com/@${authorData.tiktokUsername}" target="_blank"><img src="https://cdn.pixabay.com/photo/2021/06/15/12/28/tiktok-6338432_1280.png" alt="TikTok" class="w-6 h-6"></a>`;
      }
      if (authorData.website) {
        socialLinksHTML += `<a href="${authorData.website}" target="_blank"><i class="fa-solid fa-globe text-2xl"></i></a>`;
      }
      document.getElementById('author-social-links').innerHTML = socialLinksHTML;
      
      // Agregar enlace del sitio web debajo de los botones de seguir
      const bioElement = document.getElementById('author-bio');
      if (authorData.website) {
        bioElement.innerHTML = `
          ${authorData.bio || ''}
          <div class="mt-3">
            <a href="${authorData.website}" target="_blank" class="text-blue-500 hover:text-blue-600 flex items-center text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              ${authorData.website.replace(/^https?:\/\//, '')}
            </a>
          </div>
        `;
      } else {
        bioElement.textContent = authorData.bio || '';
      }
      currentViewedAuthorId = authorId;
      document.getElementById('author-profile-modal').style.display = "block";
      updateFollowIcon();
      loadAuthorStories(authorId);
      document.getElementById('author-profile-image').onclick = function() {
      };
    });
  }

  function closeAuthorProfile() {
    document.getElementById('author-profile-modal').style.display = "none";
    if (document.getElementById('search-view').classList.contains('hidden')) {
      document.getElementById('bottom-nav').classList.remove('hidden');
    }
  }

  // --- FUNCIONES DE BLOQUEO DE PANTALLA (ERROR 503) ---
  function activateBlocker() {
    const blocker = document.getElementById('error-503-blocker');
    if (blocker) {
      blocker.style.display = 'flex';
      document.body.style.overflow = 'hidden'; // Evitar scroll en el fondo
    }
  }

  function deactivateBlocker() {
    const blocker = document.getElementById('error-503-blocker');
    if (blocker) {
      blocker.style.display = 'none';
      document.body.style.overflow = ''; // Restaurar scroll
    }
  }
  // -----------------------------------------------------

  function closeBlockedErrorModal() {
    document.getElementById('blocked-error-modal').style.display = "none";
    document.getElementById('story-detail-modal').classList.remove('hidden');
  }
  /*********************** FUNCIONES PARA SEGUIR **************************/
  function updateFollowIcon() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      const followIcon = document.getElementById('follow-icon');
      followIcon.src = snapshot.exists() ?
        "https://cdn-icons-png.flaticon.com/512/907/907822.png" :
        "https://cdn-icons-png.freepik.com/512/8370/8370007.png";
    });
  }

  function followAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    if (currentUser.uid === currentViewedAuthorId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }

    const followRef = firebase.database().ref('followers/' + currentViewedAuthorId + '/' + currentUser.uid);
    const followButton = document.getElementById('follow-button');
    const authorFollowersRef = firebase.database().ref('users/' + currentViewedAuthorId + '/followersCount');
    const currentFollowersElement = document.getElementById('author-followers');

    // Escuchar cambios en tiempo real del contador de seguidores
    authorFollowersRef.on('value', (snapshot) => {
      const followersCount = snapshot.val() || 0;
      currentFollowersElement.textContent = formatNumber(followersCount);
    });

    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Dejar de seguir
        followRef.remove().then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 1) - 1;
          });
          
          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>`;
        });
      } else {
        // Comenzar a seguir
        followRef.set({
          followedAt: Date.now()
        }).then(() => {
          authorFollowersRef.transaction(current => {
            return (current || 0) + 1;
          });

          firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
            const followerName = userSnap.val().username;
            addNotification(currentViewedAuthorId, `${followerName} te ha seguido`);
          });

          followButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>`;
        });
      }
    });
  }

  

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }

  function followUser(userId) {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) return;
    if (currentUser.uid === userId) {
      alert(translations[currentLanguage].followSelfError);
      return;
    }
    const followRef = firebase.database().ref('followers/' + userId + '/' + currentUser.uid);
    followRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        alert(translations[currentLanguage].alreadyFollowing);
      } else {
        followRef.set({
            followedAt: Date.now()
          })
          .then(() => {
            const userFollowersCountRef = firebase.database().ref('users/' + userId + '/followersCount');
            userFollowersCountRef.transaction(current => (current || 0) + 1);
            firebase.database().ref('users/' + currentUser.uid).once('value').then(userSnap => {
              const followerName = userSnap.val().username;
              addNotification(userId, `${followerName} te ha seguido`);
            });
            
            alert(translations[currentLanguage].nowFollowing);
          });
      }
    });
  }

  function openFollowingModal() {
    if (!currentViewedAuthorId) {
      alert("Por favor, selecciona un perfil primero.");
      return;
    }
    
    firebase.database().ref('following/' + currentViewedAuthorId).once('value').then(snapshot => {
      const followingListDiv = document.getElementById('following-list');
      followingListDiv.innerHTML = '';
      
      if (snapshot.numChildren() === 0) {
        followingListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Este autor a√∫n no sigue a nadie.</p>';
      } else {
        snapshot.forEach(child => {
          const followingUserId = child.key;
          firebase.database().ref('users/' + followingUserId).once('value').then(userSnap => {
            const userData = userSnap.val();
            if (!userData) return;
            
            const followingDiv = document.createElement('div');
            followingDiv.className = 'flex items-center justify-between p-4 bg-white hover:bg-gray-50 rounded-xl border border-gray-200 transition-all';
            let verifiedIcon = getVerificationIcon(userData.email || "");
            
            followingDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" 
                     alt="${userData.username}" 
                     class="w-12 h-12 rounded-full object-cover border-2 border-[#FE2C55]"
                     onclick="closeFollowingModal(); viewAuthorProfile('${followingUserId}');">
                <div onclick="closeFollowingModal(); viewAuthorProfile('${followingUserId}');" class="cursor-pointer">
                  <p class="font-semibold text-gray-800">${userData.username || 'Usuario'}${verifiedIcon}</p>
                  <p class="text-sm text-gray-500">@${userData.username || 'usuario'}</p>
                </div>
              </div>
              <button onclick="followUser('${followingUserId}')" 
                      class="bg-[#FE2C55] hover:bg-[#e02849] text-white px-4 py-2 rounded-full transition-colors">
                <i class="fa-solid fa-user-plus"></i>
                <span class="ml-1">Seguir</span>
              </button>
            `;
            followingListDiv.appendChild(followingDiv);
          });
        });
      }
      
      document.getElementById('following-modal').style.display = "block";
    });
  }

  function closeFollowingModal() {
    document.getElementById('following-modal').style.display = "none";
  }

  function openFollowersModal() {
    if (!currentViewedAuthorId) {
      alert("Por favor, selecciona un perfil primero.");
      return;
    }
    
    firebase.database().ref('followers/' + currentViewedAuthorId).once('value').then(snapshot => {
      const followersListDiv = document.getElementById('followers-list');
      followersListDiv.innerHTML = '';
      
      if (snapshot.numChildren() === 0) {
        followersListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Este autor a√∫n no tiene seguidores.</p>';
      } else {
        snapshot.forEach(child => {
          const followerUserId = child.key;
          firebase.database().ref('users/' + followerUserId).once('value').then(userSnap => {
            const userData = userSnap.val();
            if (!userData) return;
            
            const followerDiv = document.createElement('div');
            followerDiv.className = 'flex items-center justify-between p-4 bg-white hover:bg-gray-50 rounded-xl border border-gray-200 transition-all';
            let verifiedIcon = getVerificationIcon(userData.email || "");
            
            followerDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" 
                     alt="${userData.username}" 
                     class="w-12 h-12 rounded-full object-cover border-2 border-[#FE2C55]"
                     onclick="closeFollowersModal(); viewAuthorProfile('${followerUserId}');">
                <div onclick="closeFollowersModal(); viewAuthorProfile('${followerUserId}');" class="cursor-pointer">
                  <p class="font-semibold text-gray-800">${userData.username || 'Usuario'}${verifiedIcon}</p>
                  <p class="text-sm text-gray-500">@${userData.username || 'usuario'}</p>
                </div>
              </div>
              <button onclick="followUser('${followerUserId}')" 
                      class="bg-[#FE2C55] hover:bg-[#e02849] text-white px-4 py-2 rounded-full transition-colors">
                <i class="fa-solid fa-user-plus"></i>
                <span class="ml-1">Seguir</span>
              </button>
            `;
            followersListDiv.appendChild(followerDiv);
          });
        });
      }
      
      document.getElementById('followers-modal').style.display = "block";
    });
  }

  function closeFollowersModal() {
    document.getElementById('followers-modal').style.display = "none";
  }

  function openMyFollowersModal() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      alert("Debes iniciar sesi√≥n para ver tus seguidores.");
      return;
    }
    
    currentViewedAuthorId = currentUser.uid;
    openFollowersModal();
  }

  function openMyFollowingModal() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser) {
      alert("Debes iniciar sesi√≥n para ver a qui√©n sigues.");
      return;
    }
    
    currentViewedAuthorId = currentUser.uid;
    openFollowingModal();
  }
  /*********************** CREACI√ìN DE HISTORIAS **************************/
  document.getElementById('story-form').addEventListener('submit', function(e) {
    e.preventDefault();
    document.getElementById('story-upload-spinner').style.display = "flex";
    const title = document.getElementById('story-title').value;
    const category = document.getElementById('story-category').value;
    const synopsis = document.getElementById('story-synopsis').value || "";
    const language = document.getElementById('story-language').value;
    const rating = document.getElementById('story-rating').value;
    const coverInput = document.getElementById('story-cover');
    const user = firebase.auth().currentUser;
    if (!user) {
      alert(translations[currentLanguage].userNotAuthenticated);
      document.getElementById('story-upload-spinner').style.display = "none";
      return;
    }
    let newStory = {
      userId: user.uid,
      title,
      category,
      synopsis,
      language,
      type: storyTypeSelected,
      coverImage: "",
      createdAt: Date.now(),
      isPrivate: false,
      views: 0,
      rating: rating,
      email: user.email
    };
    if (storyTypeSelected === 'cuento') {
      newStory.content = document.getElementById('cuento-content') ? document.getElementById('cuento-content').value : "";
    }

    function saveStory(coverURL = "") {
      newStory.coverImage = coverURL;
      firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
        const userData = snapshot.val();
        newStory.username = userData && userData.username ? userData.username : "Autor Desconocido";
        newStory.email = userData.email || user.email;
        const storyRef = firebase.database().ref('stories').push();
        newStory.id = storyRef.key;
        storyRef.set(newStory)
          .then(() => {
            document.getElementById('story-upload-spinner').style.display = "none";
            setTimeout(() => {
              document.getElementById('story-details-view').classList.add('hidden');
              openStoryEdit(newStory);
            }, 3000);
          })
          .catch(error => {
            console.error("Error al guardar la historia:", error);
            document.getElementById('story-upload-spinner').style.display = "none";
          });
      });
    }
    if (coverInput.files.length > 0) {
      const file = coverInput.files[0];
      validateCoverImage(file)
        .then(() => {
          return convertFileToBase64(file);
        })
        .then((base64Image) => {
          saveStory(base64Image);
        })
        .catch(errMsg => {
          alert(errMsg);
          document.getElementById('story-upload-spinner').style.display = "none";
        });
    } else {
      saveStory();
    }
  });

  function openStoryCreation() {
    document.getElementById('story-creation-view').classList.remove('hidden');
    document.getElementById('story-details-view').classList.add('hidden');
    document.getElementById('story-edit-view').classList.add('hidden');
  }

  function closeStoryCreation() {
    document.getElementById('story-creation-view').classList.add('hidden');
  }

  function backToStoryType() {
    document.getElementById('story-details-view').classList.add('hidden');
    document.getElementById('story-creation-view').classList.remove('hidden');
  }

  function validateCoverImage(file) {
    return new Promise((resolve, reject) => {
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = function() {
        const ratio = img.naturalWidth / img.naturalHeight;
        if (ratio > 3 || ratio < 0.3) {
          URL.revokeObjectURL(url);
          reject("La imagen de portada tiene un formato no permitido (posible screenshot).");
        } else {
          URL.revokeObjectURL(url);
          resolve();
        }
      };
      img.onerror = function() {
        URL.revokeObjectURL(url);
        reject("Error al cargar la imagen.");
      };
      img.src = url;
    });
  }
  /*********************** CAP√çTULOS **************************/
  function openChapterCreationModal() {
    currentChapterEditId = null;
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function closeChapterCreationModal() {
    document.getElementById('chapter-creation-modal').style.display = "none";
    document.getElementById('chapter-form').reset();
    document.getElementById('word-count').innerText = "0 palabras";
    document.getElementById('letter-count').innerText = "0 letras";
    document.getElementById('font-size').value = 16;
    document.getElementById('font-size-value').innerText = "16px";
    document.getElementById('chapter-content').style.fontSize = "16px";
    document.getElementById('chapter-content').style.fontFamily = "Arial";
    document.getElementById('chapter-schedule').value = "";
    currentChapterEditId = null;
    document.getElementById('btn-save-chapter').textContent = translations[currentLanguage].btnSaveChapter;
  }
  document.getElementById('chapter-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('chapter-content').value;
    const scheduledDate = document.getElementById('chapter-schedule').value;
    
    if (!currentEditingStory) {
      alert(translations[currentLanguage].noEditingStory);
      return;
    }
    
    const user = firebase.auth().currentUser;
    if (!user) {
      alert(translations[currentLanguage].userNotAuthenticated);
      return;
    }

    if (currentChapterEditId) {
      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + currentChapterEditId);
      chapterRef.update({
          content: content
        })
        .then(() => {
          closeChapterCreationModal();
          alert("Cap√≠tulo actualizado correctamente.");
        })
        .catch(error => {
          console.error("Error al actualizar cap√≠tulo:", error);
        });
    } else {
      const chapterNumber = currentChapters.length + 1;
      const newChapter = {
        chapterNumber,
        content,
        createdAt: Date.now(),
        status: scheduledDate ? 'scheduled' : 'published'
      };

      const chapterRef = firebase.database().ref('stories/' + currentEditingStory.id + '/chapters').push();
      newChapter.id = chapterRef.key;
      
      if (scheduledDate) {
        // Guardar en cap√≠tulos programados
        firebase.database().ref('scheduledChapters/' + chapterRef.key).set({
          storyId: currentEditingStory.id,
          publishDate: new Date(scheduledDate).getTime(),
          status: 'pending'
        });
        
        // Guardar el cap√≠tulo con estado programado
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert("Cap√≠tulo programado para publicaci√≥n el " + new Date(scheduledDate).toLocaleDateString());
          })
          .catch(error => {
            console.error("Error al programar cap√≠tulo:", error);
          });
      } else {
        // Publicaci√≥n inmediata
        chapterRef.set(newChapter)
          .then(() => {
            closeChapterCreationModal();
            alert(translations[currentLanguage].chapterAdded);
          })
          .catch(error => {
            console.error("Error al agregar cap√≠tulo:", error);
          });
      }
    }
  });

  function openChapterEditModal(chapter) {
    currentChapterEditId = chapter.id;
    document.getElementById('chapter-content').value = chapter.content;
    document.getElementById('btn-save-chapter').textContent = "Guardar Cambios";
    document.getElementById('chapter-creation-modal').style.display = "flex";
  }

  function deleteChapter(chapterId) {
    if (confirm("¬øEst√°s seguro de eliminar este cap√≠tulo?")) {
      firebase.database().ref('stories/' + currentEditingStory.id + '/chapters/' + chapterId).remove()
        .then(() => {
          alert("Cap√≠tulo eliminado correctamente.");
        })
        .catch(error => {
          console.error("Error al eliminar cap√≠tulo:", error);
        });
    }
  }

  function openChapterReadModal(storyId, chapterId) {
    console.log('Abriendo cap√≠tulo:', storyId, chapterId); // Debug
    
    // Ocultar el modal de detalle de historia
    const storyDetailModal = document.getElementById('story-detail-modal');
    if (storyDetailModal && !storyDetailModal.classList.contains('hidden')) {
      storyDetailModal.classList.add('hidden');
    }
    
    // Ocultar la app principal si est√° visible
    const mainApp = document.getElementById('main-app');
    if (mainApp && !mainApp.classList.contains('hidden')) {
      mainApp.classList.add('hidden');
    }
    
    firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId).once('value').then(snapshot => {
      const chapter = snapshot.val();
      console.log('Datos del cap√≠tulo:', chapter); // Debug
      
      if (chapter) {
        document.getElementById('read-chapter-number').textContent = "Cap√≠tulo " + chapter.chapterNumber;
        document.getElementById('read-chapter-text').innerHTML = chapter.content.replace(/\n/g, '<br>');
        setupStarRating(storyId, chapterId);
        
        if (!currentEditingStory) {
          currentEditingStory = {
            id: storyId,
            currentChapterId: chapterId
          };
        } else {
          currentEditingStory.currentChapterId = chapterId;
        }
        
        const user = firebase.auth().currentUser;
        if (user) {
          const chapterViewRef = firebase.database().ref('chapterViews/' + chapterId + '/' + user.uid);
          chapterViewRef.once('value').then(viewSnap => {
            if (!viewSnap.exists()) {
              chapterViewRef.set(true);
              const chapterViewsRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/views');
              chapterViewsRef.transaction(current => (current || 0) + 1);
            }
          });
        }
        
        // Mostrar el modal de lectura
        const chapterReadModal = document.getElementById('chapter-read-modal');
        console.log('Modal de lectura:', chapterReadModal); // Debug
        
        if (chapterReadModal) {
          chapterReadModal.classList.remove('hidden');
          console.log('Modal mostrado correctamente'); // Debug
        } else {
          console.error('No se encontr√≥ el modal de lectura'); // Debug
          alert('Error: No se pudo abrir el cap√≠tulo');
        }
      } else {
        alert('Cap√≠tulo no encontrado');
      }
    }).catch(error => {
      console.error('Error al cargar cap√≠tulo:', error);
      alert('Error al cargar el cap√≠tulo');
    });
  }

  function closeChapterReadModal() {
    const chapterReadModal = document.getElementById('chapter-read-modal');
    const storyDetailModal = document.getElementById('story-detail-modal');
    const mainApp = document.getElementById('main-app');
    
    if (chapterReadModal) {
      chapterReadModal.classList.add('hidden');
    }
    
    // Si hay un modal de detalle, mostrarlo, sino mostrar la app principal
    if (storyDetailModal && window.currentStoryId) {
      storyDetailModal.classList.remove('hidden');
    } else if (mainApp) {
      mainApp.classList.remove('hidden');
    }
  }

  function prevChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index > 0) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index - 1].id);
    } else {
      alert(translations[currentLanguage].firstChapter);
    }
  }

  function nextChapter() {
    if (!currentEditingStory || !currentEditingStory.currentChapterId) return;
    const index = currentChapters.findIndex(ch => ch.id === currentEditingStory.currentChapterId);
    if (index < currentChapters.length - 1) {
      openChapterReadModal(currentEditingStory.id, currentChapters[index + 1].id);
    } else {
      alert(translations[currentLanguage].lastChapter);
    }
  }

  function setupStarRating(storyId, chapterId) {
    const stars = document.querySelectorAll("#star-rating .star");
    stars.forEach(star => {
      star.classList.remove("selected");
    });
    const user = firebase.auth().currentUser;
    if (!user) return;
    const ratingRef = firebase.database().ref('stories/' + storyId + '/chapters/' + chapterId + '/ratings/' + user.uid);
    ratingRef.once('value').then(snapshot => {
      const rating = snapshot.val();
      if (rating) {
        stars.forEach(star => {
          if (parseInt(star.getAttribute('data-value')) <= rating) {
            star.classList.add("selected");
          }
        });
      }
    });
    stars.forEach(star => {
      star.onclick = function() {
        const value = parseInt(this.getAttribute('data-value'));
        ratingRef.set(value)
          .then(() => {
            stars.forEach(s => {
              if (parseInt(s.getAttribute('data-value')) <= value) {
                s.classList.add("selected");
              } else {
                s.classList.remove("selected");
              }
            });
            alert(translations[currentLanguage].chapterRated.replace("{value}", value));
          })
          .catch(error => {
            console.error("Error al guardar calificaci√≥n:", error);
          });
      };
    });
  }
  /*********************** EFECTO SKELETON **************************/
  function applySkeletonEffect() {
    document.getElementById('profile-image').classList.add('skeleton');
    document.getElementById('profile-username').classList.add('skeleton');
    document.getElementById('profile-bio').classList.add('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.add('skeleton');
    }
  }

  function removeSkeletonEffect() {
    document.getElementById('profile-image').classList.remove('skeleton');
    document.getElementById('profile-username').classList.remove('skeleton');
    document.getElementById('profile-bio').classList.remove('skeleton');
    const userStories = document.getElementById('user-stories');
    if (userStories) {
      userStories.classList.remove('skeleton');
    }
  }
  if (!navigator.onLine) {
    applySkeletonEffect();
  }
  window.addEventListener('offline', applySkeletonEffect);
  window.addEventListener('online', removeSkeletonEffect);
  /*********************** CARGA DE HISTORIAS **************************/
  function loadStories() {
    firebase.database().ref('stories').on('value', snapshot => {
      let stories = [];
      snapshot.forEach(child => {
        stories.push(child.val());
      });
      let newReleases = stories.sort((a, b) => b.createdAt - a.createdAt);
      renderStories(newReleases, 'new-releases', false);
      let top10 = stories.sort((a, b) => b.views - a.views).slice(0, 10);
      renderStories(top10, 'top10', false);
      let popular = stories.sort((a, b) => b.views - a.views);
      renderStories(popular, 'popular', false);
      let terrorStories = stories.filter(story => story.category === 'terror');
      renderStories(terrorStories, 'terror-stories', false);
    });
  }

  function renderStories(stories, elementId, editMode) {
    const container = document.getElementById(elementId);
    container.innerHTML = '';
    stories.forEach(story => {
      if (story.blocked) return;
      const storyCard = document.createElement('div');
      storyCard.className = 'story-card cursor-pointer relative';
      storyCard.onclick = editMode ? () => openStoryEdit(story) : () => openStoryDetail(story);
      storyCard.innerHTML = `
          <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
            <div class="story-cover-container">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
            </div>
          </div>
          <div class="mt-2">
            <h3 class="font-semibold text-sm">${story.title}</h3>
          </div>
        `;
      const languageDiv = document.createElement('div');
      languageDiv.className = "mt-1 flex items-center space-x-2";
      languageDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
      if (story.rating === "18plus") {
        languageDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
      }
      storyCard.appendChild(languageDiv);
      container.appendChild(storyCard);
    });
  }
  /*********************** CARGA DE HISTORIAS DEL USUARIO **************************/
  function loadUserStories(userId) {
    const userStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(userId);
    userStoriesRef.on('value', snapshot => {
      const container = document.getElementById('user-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryEdit(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  
  /*********************** FUNCIONES AUXILIARES PARA CARGAR HISTORIAS DESDE AWS S3 **************************/
  
  async function loadStoriesFromAWS() {
    try {
      const response = await fetch('/.netlify/functions/get-stories');
      const data = await response.json();
      return data.stories || [];
    } catch (error) {
      console.error('Error loading stories from AWS:', error);
      return [];
    }
  }

  async function getUserRatingPreferences(userId) {
    const allStories = await loadStoriesFromAWS();
    const userRatings = {};
    const categoryScores = {};
    
    for (const story of allStories.slice(0, 30)) {
      try {
        const chaptersResponse = await fetch(`/.netlify/functions/get-chapters?storyId=${story.id}`);
        const chaptersData = await chaptersResponse.json();
        
        if (chaptersData.chapters) {
          chaptersData.chapters.forEach(chapter => {
            if (chapter.ratings && chapter.ratings[userId]) {
              const rating = chapter.ratings[userId];
              if (!categoryScores[story.category]) {
                categoryScores[story.category] = { total: 0, count: 0 };
              }
              categoryScores[story.category].total += rating;
              categoryScores[story.category].count += 1;
              
              if (!userRatings[story.id]) {
                userRatings[story.id] = { ratings: [], avgRating: 0, category: story.category };
              }
              userRatings[story.id].ratings.push(rating);
            }
          });
        }
      } catch (error) {
        console.error('Error loading chapters for story:', story.id, error);
      }
    }
    
    Object.keys(userRatings).forEach(storyId => {
      const ratings = userRatings[storyId].ratings;
      userRatings[storyId].avgRating = ratings.reduce((a, b) => a + b, 0) / ratings.length;
    });
    
    Object.keys(categoryScores).forEach(category => {
      categoryScores[category].avg = categoryScores[category].total / categoryScores[category].count;
    });
    
    return { userRatings, categoryScores };
  }

  function createStoryCard(story) {
    const card = document.createElement('div');
    card.className = 'cursor-pointer transform transition-transform hover:scale-105';
    card.onclick = () => openStoryDetail(story);
    card.innerHTML = `
      <div class="rounded-2xl overflow-hidden shadow-md">
        <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
      </div>
      <div class="mt-2">
        <h3 class="font-semibold text-sm truncate">${story.title}</h3>
        ${story.ratingValue ? `<div class="flex items-center mt-1">
          <i class="fas fa-star text-yellow-400 text-xs"></i>
          <span class="text-xs text-gray-600 ml-1">${story.ratingValue.toFixed(1)}</span>
        </div>` : ''}
      </div>
    `;
    return card;
  }

  async function followAuthor(authorId, buttonElement) {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('Debes iniciar sesi√≥n para seguir autores');
      return;
    }
    
    try {
      buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
      buttonElement.disabled = true;
      
      await firebase.database().ref('following/' + user.uid + '/' + authorId).set(true);
      await firebase.database().ref('followers/' + authorId + '/' + user.uid).set(true);
      
      buttonElement.classList.add('hidden');
      
      await addNotification(authorId, `${user.displayName || user.email} te ha seguido`, 'follow');
    } catch (error) {
      console.error('Error following author:', error);
      alert('Error al seguir al autor');
      buttonElement.innerHTML = '<i class="fas fa-plus text-xs"></i>';
      buttonElement.disabled = false;
    }
  }
  
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  async function loadSuggestedStories() {
    const user = firebase.auth().currentUser;
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('suggested-stories');
    container.innerHTML = '';
    
    if (!stories.length) {
      container.innerHTML = '<p class="text-gray-500">No hay historias disponibles</p>';
      return;
    }
    
    let suggestedStories = [];
    
    if (user) {
      const { userRatings, categoryScores } = await getUserRatingPreferences(user.uid);
      
      suggestedStories = stories.map(story => {
        let score = story.views || 0;
        
        if (userRatings[story.id]) {
          score += userRatings[story.id].avgRating * 500;
        }
        
        if (categoryScores[story.category]) {
          score += categoryScores[story.category].avg * 300;
        }
        
        if (story.ratingValue) {
          score += story.ratingValue * 100;
        }
        
        return { ...story, score };
      });
      
      suggestedStories.sort((a, b) => b.score - a.score);
    } else {
      suggestedStories = stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
    }
    
    const suggested = suggestedStories.slice(0, 10);
    suggested.forEach(story => {
      const card = document.createElement('div');
      card.className = 'story-card cursor-pointer';
      card.onclick = () => openStoryDetail(story);
      card.innerHTML = `
        <div class="rounded-2xl overflow-hidden shadow-md">
          <div class="story-cover-container">
            <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
          </div>
        </div>
        <div class="mt-2">
          <h3 class="font-semibold text-sm">${story.title}</h3>
        </div>
      `;
      container.appendChild(card);
    });
  }

  async function loadFeaturedAuthors() {
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('featured-authors');
    container.innerHTML = '';
    
    const authorCounts = {};
    stories.forEach(story => {
      if (story && story.userId) {
        if (!authorCounts[story.userId]) {
          authorCounts[story.userId] = { count: 0, username: story.username, email: story.email };
        }
        authorCounts[story.userId].count++;
      }
    });
    
    const authorsArray = Object.keys(authorCounts).map(uid => ({
      uid,
      ...authorCounts[uid]
    }));
    
    authorsArray.sort((a, b) => b.count - a.count);
    const topAuthors = authorsArray.slice(0, 10);
    
    const user = firebase.auth().currentUser;
    
    for (const author of topAuthors) {
      try {
        const userData = await new Promise((resolve, reject) => {
          firebase.database().ref('users/' + author.uid).once('value')
            .then(snap => resolve(snap.val()))
            .catch(reject);
        });
        
        const isFollowing = user ? await new Promise((resolve) => {
          firebase.database().ref('following/' + user.uid + '/' + author.uid).once('value')
            .then(snap => resolve(snap.exists()))
            .catch(() => resolve(false));
        }) : false;
        
        const card = document.createElement('div');
        card.className = 'flex-shrink-0 flex flex-col items-center relative';
        card.innerHTML = `
          <div class="relative">
            <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-[#FE2C55] cursor-pointer hover:scale-105 transition-transform"
                 onclick="openAuthorProfile('${author.uid}')">
              <img src="${userData?.profileImage || 'https://via.placeholder.com/150'}" 
                   alt="${userData?.username || author.username}" 
                   class="w-full h-full object-cover">
            </div>
            <button class="absolute -bottom-1 -right-1 w-7 h-7 bg-[#FE2C55] text-white rounded-full flex items-center justify-center hover:bg-[#ef2950] transition shadow-lg ${isFollowing ? 'hidden' : ''}"
                    onclick="followAuthor('${author.uid}', this)"
                    title="Seguir">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <span class="text-xs mt-2 text-center font-medium truncate w-20">${userData?.username || author.username || 'Usuario'}</span>
        `;
        container.appendChild(card);
      } catch (error) {
        console.error('Error loading author:', author.uid, error);
      }
    }
  }
  
  async function loadTrendingStories() {
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('trending-stories');
    container.innerHTML = '';
    
    if (!stories.length) return;
    
    const now = Date.now();
    const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
    
    const trending = stories
      .filter(story => story.timestamp > sevenDaysAgo)
      .map(story => ({
        ...story,
        trendingScore: (story.views || 0) * 2 + (story.ratingValue || 0) * 100
      }))
      .sort((a, b) => b.trendingScore - a.trendingScore)
      .slice(0, 8);
    
    trending.forEach(story => {
      container.appendChild(createStoryCard(story));
    });
  }

  async function loadMysteryStories() {
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('mystery-stories');
    container.innerHTML = '';
    
    const mysteryStories = stories
      .filter(story => story.category === 'misterio')
      .sort((a, b) => (b.views || 0) - (a.views || 0))
      .slice(0, 8);
    
    mysteryStories.forEach(story => {
      container.appendChild(createStoryCard(story));
    });
  }

  async function loadAdventureStories() {
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('adventure-stories');
    container.innerHTML = '';
    
    const adventureStories = stories
      .filter(story => story.category === 'aventura')
      .sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0))
      .slice(0, 8);
    
    adventureStories.forEach(story => {
      container.appendChild(createStoryCard(story));
    });
  }
  
  async function initializeFeedSections() {
    try {
      await Promise.all([
        loadSuggestedStories(),
        loadFeaturedAuthors(),
        loadTrendingStories(),
        loadMysteryStories(),
        loadAdventureStories()
      ]);
      console.log('Todas las secciones cargadas exitosamente');
    } catch (error) {
      console.error('Error cargando secciones:', error);
    }
  }
  
  /*********************** CARGA DE HISTORIAS DEL AUTOR **************************/
  function loadAuthorStories(authorId) {
    const authorStoriesRef = firebase.database().ref('stories').orderByChild('userId').equalTo(authorId);
    authorStoriesRef.on('value', snapshot => {
      const container = document.getElementById('author-stories');
      container.innerHTML = "";
      snapshot.forEach(child => {
        const story = child.val();
        if (story.blocked) return;
        const card = document.createElement('div');
        card.className = "cursor-pointer";
        card.onclick = () => openStoryDetail(story);
        card.innerHTML = `
            <div class="rounded-2xl overflow-hidden shadow-md transform transition-transform hover:scale-105">
              <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="w-full h-40 object-cover">
            </div>
            <div class="mt-2">
              <h3 class="font-semibold text-sm">${story.title}</h3>
            </div>
          `;
        const langDiv = document.createElement('div');
        langDiv.className = "mt-1 flex items-center space-x-2";
        langDiv.innerHTML = `<span class="text-xs text-gray-500">Idioma: ${story.language || "N/A"}</span>`;
        if (story.rating === "18plus") {
          langDiv.innerHTML += ' <span class="text-xs text-red-600 font-bold border border-red-600 rounded px-1">+18</span>';
        }
        card.appendChild(langDiv);
        container.appendChild(card);
      });
    });
  }
  /*********************** NUEVAS FUNCIONES: DESCARGAR HISTORIA COMPLETA PARA LECTURA OFFLINE **************************/
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada cap√≠tulo con t√≠tulo y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Cap√≠tulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
  /*********************** REPORTAR HISTORIA Y BLOQUEO **************************/
  let lastX = null,
    lastY = null,
    lastZ = null;
  let shakeThreshold = 15;
  let shakeTimeout = null;

  function deviceMotionHandler(event) {
    const acceleration = event.accelerationIncludingGravity;
    if (!acceleration) return;
    const {
      x,
      y,
      z
    } = acceleration;
    if (lastX === null) {
      lastX = x;
      lastY = y;
      lastZ = z;
      return;
    }
    const deltaX = Math.abs(x - lastX);
    const deltaY = Math.abs(y - lastY);
    const deltaZ = Math.abs(z - lastZ);
    if (deltaX + deltaY + deltaZ > shakeThreshold) {
      if (!shakeTimeout) {
        shakeTimeout = setTimeout(() => {
          shakeTimeout = null;
        }, 1000);
      }
    }
    lastX = x;
    lastY = y;
    lastZ = z;
  }

  function initShakeDetection() {
    if (window.DeviceMotionEvent) {
      window.addEventListener('devicemotion', deviceMotionHandler, false);
    } else {
      console.log("DeviceMotionEvent no est√° soportado");
    }
  }


  function listenForStoryBlock(storyId) {
    firebase.database().ref('stories/' + storyId + '/blocked').on('value', snapshot => {
      if (snapshot.exists() && snapshot.val() === true) {
        openStoryBlockedModal();
      }
    });
  }

  function openStoryBlockedModal() {
    const modal = document.getElementById('story-blocked-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }
  let blockedStartX = null;
  const storyBlockedModal = document.getElementById('story-blocked-modal');
  if (storyBlockedModal) {
    storyBlockedModal.addEventListener('touchstart', function(e) {
      blockedStartX = e.touches[0].clientX;
    });
    storyBlockedModal.addEventListener('touchmove', function(e) {
      if (blockedStartX === null) return;
      const diffX = blockedStartX - e.touches[0].clientX;
      if (diffX > 100) {
        triggerBlockedAnimation();
        blockedStartX = null;
      }
    });
  }

  function triggerBlockedAnimation() {
    const dot1 = document.createElement('div');
    const dot2 = document.createElement('div');
    [dot1, dot2].forEach(dot => {
      dot.style.position = 'absolute';
      dot.style.width = '20px';
      dot.style.height = '20px';
      dot.style.backgroundColor = '#58CC02';
      dot.style.borderRadius = '50%';
      dot.style.transition = 'all 0.5s ease-in-out';
    });
    dot1.style.top = '50%';
    dot1.style.left = '10%';
    dot2.style.top = '50%';
    dot2.style.left = '80%';
    storyBlockedModal.appendChild(dot1);
    storyBlockedModal.appendChild(dot2);
    setTimeout(() => {
      dot1.style.left = '45%';
      dot2.style.left = '55%';
    }, 100);
    setTimeout(() => {
      storyBlockedModal.style.display = 'none';
      dot1.remove();
      dot2.remove();
    }, 1000);
  }
  window.addEventListener('load', initShakeDetection);
  /*********************** MODAL DE CREACI√ìN DE CAP√çTULO **************************/
  document.getElementById('font-family').addEventListener('change', function() {
    document.getElementById('chapter-content').style.fontFamily = this.value;
  });
  document.getElementById('font-size').addEventListener('input', function() {
    var size = this.value;
    document.getElementById('chapter-content').style.fontSize = size + "px";
    document.getElementById('font-size-value').innerText = size + "px";
  });
  document.getElementById('chapter-content').addEventListener('input', function() {
    var text = this.value;
    var words = text.trim().split(/\s+/).filter(word => word.length > 0);
    document.getElementById('word-count').innerText = words.length + " palabras";
    document.getElementById('letter-count').innerText = text.replace(/\s/g, "").length + " letras";
  });
  /*********************** NUEVAS FUNCIONES: SUGERENCIAS Y AUTORES DESTACADOS **************************/
  async function loadSuggestedStories() {
    const user = firebase.auth().currentUser;
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('suggested-stories');
    container.innerHTML = '';
    
    if (!stories.length) {
      container.innerHTML = '<p class="text-gray-500">No hay historias disponibles</p>';
      return;
    }
    
    let suggestedStories = [];
    
    if (user) {
      const { userRatings, categoryScores } = await getUserRatingPreferences(user.uid);
      
      suggestedStories = stories.map(story => {
        let score = story.views || 0;
        
        if (userRatings[story.id]) {
          score += userRatings[story.id].avgRating * 500;
        }
        
        if (categoryScores[story.category]) {
          score += categoryScores[story.category].avg * 300;
        }
        
        if (story.ratingValue) {
          score += story.ratingValue * 100;
        }
        
        return { ...story, score };
      });
      
      suggestedStories.sort((a, b) => b.score - a.score);
    } else {
      suggestedStories = stories.sort((a, b) => (b.ratingValue || 0) - (a.ratingValue || 0));
    }
    
    const suggested = suggestedStories.slice(0, 10);
    suggested.forEach(story => {
      const card = document.createElement('div');
      card.className = 'story-card cursor-pointer';
      card.onclick = () => openStoryDetail(story);
      card.innerHTML = `
        <div class="rounded-2xl overflow-hidden shadow-md">
          <div class="story-cover-container">
            <img src="${story.coverImage || '/api/placeholder/200/300'}" alt="${story.title}" class="story-cover-image">
          </div>
        </div>
        <div class="mt-2">
          <h3 class="font-semibold text-sm">${story.title}</h3>
        </div>
      `;
      container.appendChild(card);
    });
  }

  async function loadFeaturedAuthors() {
    const stories = await loadStoriesFromAWS();
    const container = document.getElementById('featured-authors');
    container.innerHTML = '';
    
    const authorCounts = {};
    stories.forEach(story => {
      if (story && story.userId) {
        if (!authorCounts[story.userId]) {
          authorCounts[story.userId] = { count: 0, username: story.username, email: story.email };
        }
        authorCounts[story.userId].count++;
      }
    });
    
    const authorsArray = Object.keys(authorCounts).map(uid => ({
      uid,
      ...authorCounts[uid]
    }));
    
    authorsArray.sort((a, b) => b.count - a.count);
    const topAuthors = authorsArray.slice(0, 10);
    
    const user = firebase.auth().currentUser;
    
    for (const author of topAuthors) {
      try {
        const userData = await new Promise((resolve, reject) => {
          firebase.database().ref('users/' + author.uid).once('value')
            .then(snap => resolve(snap.val()))
            .catch(reject);
        });
        
        const isFollowing = user ? await new Promise((resolve) => {
          firebase.database().ref('following/' + user.uid + '/' + author.uid).once('value')
            .then(snap => resolve(snap.exists()))
            .catch(() => resolve(false));
        }) : false;
        
        const card = document.createElement('div');
        card.className = 'flex-shrink-0 flex flex-col items-center relative';
        card.innerHTML = `
          <div class="relative">
            <div class="w-20 h-20 rounded-full overflow-hidden border-2 border-[#FE2C55] cursor-pointer hover:scale-105 transition-transform"
                 onclick="openAuthorProfile('${author.uid}')">
              <img src="${userData?.profileImage || 'https://via.placeholder.com/150'}" 
                   alt="${userData?.username || author.username}" 
                   class="w-full h-full object-cover">
            </div>
            <button class="absolute -bottom-1 -right-1 w-7 h-7 bg-[#FE2C55] text-white rounded-full flex items-center justify-center hover:bg-[#ef2950] transition shadow-lg ${isFollowing ? 'hidden' : ''}"
                    onclick="followAuthor('${author.uid}', this)"
                    title="Seguir">
              <i class="fas fa-plus text-xs"></i>
            </button>
          </div>
          <span class="text-xs mt-2 text-center font-medium truncate w-20">${userData?.username || author.username || 'Usuario'}</span>
        `;
        container.appendChild(card);
      } catch (error) {
        console.error('Error loading author:', author.uid, error);
      }
    }
  }
  /*************** FIN NUEVAS FUNCIONES **************************/

  /*********************** SISTEMA DE MENSAJER√çA EN TIEMPO REAL **************************/
  let currentChatUserId = null;
  let selectedAuthorForMessage = null;
  let typingTimeout = null;
  let isTyping = false;
  let voiceRecordingActive = false;

  function openMessages() {
    showLoader();
    setTimeout(() => {
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('chat-view').classList.remove('hidden');
      showConversationsView();
      loadConversations();
      listenForUnreadMessages();
      loadCurrentUserInfo();
      hideLoader();
    }, 300);
  }

  function closeChat() {
    document.getElementById('chat-view').classList.add('hidden');
    document.getElementById('main-app').classList.remove('hidden');
    currentChatUserId = null;
    // Limpiar listeners en tiempo real
    clearTypingListeners();
  }

  function showConversationsView() {
    document.getElementById('conversations-view').classList.remove('hidden');
    document.getElementById('individual-chat-view').classList.add('hidden');
  }

  function showIndividualChatView() {
    document.getElementById('conversations-view').classList.add('hidden');
    document.getElementById('individual-chat-view').classList.remove('hidden');
  }

  function backToConversations() {
    showConversationsView();
    currentChatUserId = null;
    clearTypingListeners();
  }

  function loadCurrentUserInfo() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('users/' + user.uid).once('value', snapshot => {
      const userData = snapshot.val();
      if (userData && userData.profileImage) {
        document.getElementById('current-user-avatar').src = userData.profileImage;
      }
    });
  }

  function loadConversations() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).on('value', snapshot => {
      const conversationsContainer = document.getElementById('conversations-container');
      conversationsContainer.innerHTML = '';

      if (!snapshot.exists()) {
        document.getElementById('no-conversations').classList.remove('hidden');
        return;
      }

      document.getElementById('no-conversations').classList.add('hidden');

      const conversations = [];
      snapshot.forEach(child => {
        conversations.push({
          userId: child.key,
          data: child.val()
        });
      });

      // Ordenar por √∫ltima actividad
      conversations.sort((a, b) => (b.data.lastMessageTime || 0) - (a.data.lastMessageTime || 0));

      conversations.forEach(conv => {
        const otherUserId = conv.userId;
        const conversation = conv.data;
        
        // Obtener informaci√≥n del otro usuario
        firebase.database().ref('users/' + otherUserId).once('value', userSnap => {
          const userData = userSnap.val();
          if (!userData) return;

          const conversationDiv = document.createElement('div');
          conversationDiv.className = 'p-4 hover:bg-gray-50 cursor-pointer transition-colors active:bg-gray-100';
          conversationDiv.onclick = () => openChat(otherUserId);

          const hasUnread = conversation.unreadCount > 0;
          const isOnline = Math.random() > 0.5; // Simulado, implementar l√≥gica real de estado

          conversationDiv.innerHTML = `
            <div class="flex items-center space-x-3">
              <div class="relative">
                <img src="${userData.profileImage || 'https://via.placeholder.com/50'}" 
                     alt="${userData.username}" class="w-14 h-14 rounded-full object-cover">
                ${isOnline ? '<div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                ${hasUnread ? '<div class="absolute -top-1 -left-1 w-5 h-5 bg-[#FE2C55] rounded-full flex items-center justify-center"><span class="text-xs text-white font-bold">' + (conversation.unreadCount > 9 ? '9+' : conversation.unreadCount) + '</span></div>' : ''}
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex justify-between items-start mb-1">
                  <h4 class="font-semibold truncate ${hasUnread ? 'text-black' : 'text-gray-800'}">${userData.username}</h4>
                  <span class="text-xs text-gray-500 flex-shrink-0">${formatTime(conversation.lastMessageTime)}</span>
                </div>
                <div class="flex justify-between items-center">
                  <p class="text-sm text-gray-600 truncate ${hasUnread ? 'font-medium' : ''}">${conversation.lastMessage || 'Sin mensajes'}</p>
                  ${conversation.lastMessageType === 'file' ? '<svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/></svg>' : ''}
                </div>
              </div>
            </div>
          `;
          
          conversationsContainer.appendChild(conversationDiv);
        });
      });
    });
  }

  function searchConversations(query) {
    const conversations = document.querySelectorAll('#conversations-container > div');
    conversations.forEach(conv => {
      const username = conv.querySelector('h4').textContent.toLowerCase();
      const lastMessage = conv.querySelector('p').textContent.toLowerCase();
      
      if (username.includes(query.toLowerCase()) || lastMessage.includes(query.toLowerCase())) {
        conv.style.display = 'block';
      } else {
        conv.style.display = 'none';
      }
    });
  }

  function toggleChatOptions() {
    const menu = document.getElementById('chat-options-menu');
    menu.classList.toggle('hidden');
  }

  function markAllAsRead() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).once('value', snapshot => {
      const updates = {};
      snapshot.forEach(child => {
        updates[child.key + '/unreadCount'] = 0;
      });
      firebase.database().ref('conversations/' + user.uid).update(updates);
    });
    
    document.getElementById('chat-options-menu').classList.add('hidden');
  }

  function clearAllChats() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los chats? Esta acci√≥n no se puede deshacer.')) return;
    
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).remove();
    document.getElementById('chat-options-menu').classList.add('hidden');
  }

  function openChat(userId) {
    currentChatUserId = userId;
    const user = firebase.auth().currentUser;
    if (!user) return;

    showIndividualChatView();

    // Cargar informaci√≥n del usuario
    firebase.database().ref('users/' + userId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('chat-user-avatar').src = userData.profileImage || 'https://via.placeholder.com/50';
      document.getElementById('chat-user-name').textContent = userData.username || 'Usuario';
      
      // Simular estado en l√≠nea (implementar l√≥gica real)
      const isOnline = Math.random() > 0.3;
      if (isOnline) {
        document.getElementById('chat-user-online-indicator').classList.remove('hidden');
        document.getElementById('chat-user-status').textContent = 'En l√≠nea';
        document.getElementById('chat-user-status').className = 'text-sm text-green-200';
      } else {
        document.getElementById('chat-user-online-indicator').classList.add('hidden');
        document.getElementById('chat-user-status').textContent = '√öltima vez hace ' + Math.floor(Math.random() * 60) + ' min';
        document.getElementById('chat-user-status').className = 'text-sm text-red-100';
      }
    });

    // Marcar conversaci√≥n como le√≠da
    firebase.database().ref('conversations/' + user.uid + '/' + userId).update({
      unreadCount: 0
    });

    // Cargar mensajes
    loadMessages(userId);
    
    // Configurar listeners de escritura en tiempo real
    setupTypingListeners(userId);
    
    // Limpiar el input
    document.getElementById('message-input').value = '';
    updateSendButton();
  }

  function setupTypingListeners(userId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const conversationId = [user.uid, userId].sort().join('_');
    
    // Escuchar cuando el otro usuario est√° escribiendo
    firebase.database().ref('typing/' + conversationId + '/' + userId).on('value', snapshot => {
      if (snapshot.exists() && snapshot.val() === true) {
        showTypingIndicator(userId);
      } else {
        hideTypingIndicator();
      }
    });
  }

  function clearTypingListeners() {
    if (currentChatUserId) {
      const user = firebase.auth().currentUser;
      if (user) {
        const conversationId = [user.uid, currentChatUserId].sort().join('_');
        firebase.database().ref('typing/' + conversationId + '/' + currentChatUserId).off();
        
        // Limpiar nuestro estado de escritura
        firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      }
    }
  }

  function showTypingIndicator(userId) {
    firebase.database().ref('users/' + userId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('typing-user-name').textContent = userData.username || 'Usuario';
      document.getElementById('typing-indicator').classList.remove('hidden');
    });
  }

  function hideTypingIndicator() {
    document.getElementById('typing-indicator').classList.add('hidden');
  }

  function handleMessageInput(textarea) {
    // Auto-resize textarea
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
    
    // Update send button state
    updateSendButton();
    
    // Handle typing indicator
    handleTypingIndicator(textarea.value.trim().length > 0);
  }

  function handleTypingIndicator(isTyping) {
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    
    if (isTyping && !window.isTyping) {
      window.isTyping = true;
      firebase.database().ref('typing/' + conversationId + '/' + user.uid).set(true);
      
      // Limpiar despu√©s de 3 segundos
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        window.isTyping = false;
        firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      }, 3000);
    } else if (!isTyping && window.isTyping) {
      window.isTyping = false;
      firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
      clearTimeout(typingTimeout);
    }
  }

  function updateSendButton() {
    const input = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    if (input.value.trim().length > 0) {
      sendButton.disabled = false;
      sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      sendButton.disabled = true;
      sendButton.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }

  function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  }

  function toggleChatMenu() {
    document.getElementById('chat-menu').classList.toggle('hidden');
  }

  function clearCurrentChat() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar este chat?')) return;
    
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    firebase.database().ref('messages/' + conversationId).remove().then(() => {
      document.getElementById('messages-container').innerHTML = '';
      document.getElementById('chat-menu').classList.add('hidden');
    });
  }

  function makeVoiceCall(userId) {
    // Implementar llamadas de voz (placeholder)
    alert('Funci√≥n de llamadas pr√≥ximamente disponible');
  }

  function toggleVoiceMessage() {
    if (!voiceRecordingActive) {
      startVoiceRecording();
    } else {
      stopVoiceRecording();
    }
  }

  function loadMessages(userId) {
    const user = firebase.auth().currentUser;
    if (!user) return;

    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '';

    // Crear ID √∫nico para la conversaci√≥n
    const conversationId = [user.uid, userId].sort().join('_');

    firebase.database().ref('messages/' + conversationId).orderByChild('timestamp').on('value', snapshot => {
      messagesContainer.innerHTML = '';
      
      let lastMessageDate = null;
      
      snapshot.forEach(child => {
        const message = child.val();
        const messageDate = new Date(message.timestamp).toDateString();
        
        // Agregar separador de fecha si es necesario
        if (lastMessageDate !== messageDate) {
          const dateSeparator = document.createElement('div');
          dateSeparator.className = 'flex justify-center my-4';
          dateSeparator.innerHTML = `
            <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs">
              ${formatDateSeparator(message.timestamp)}
            </span>
          `;
          messagesContainer.appendChild(dateSeparator);
          lastMessageDate = messageDate;
        }
        
        const messageDiv = document.createElement('div');
        const isOwnMessage = message.senderId === user.uid;
        
        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mb-3 group`;

        let messageContent = '';
        
        if (message.type === 'file') {
          const fileType = getFileType(message.fileName);
          messageContent = `
           <body class="bg-gray-100">
  <!-- MODAL DE BLOQUEO DE PANTALLA COMPLETA (ERROR 503) -->
  <div id="error-503-blocker" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: white;
    color: black;
    display: none; /* Por defecto oculto */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 99999;
    font-family: sans-serif;
  ">
    <h1 style="font-size: 4rem; font-weight: bold; margin-bottom: 1rem;">Error 503</h1>
    <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">Service Unavailable</p>
    <p style="font-size: 1.2rem;">The server is temporarily unable to handle the request.</p>
    <p style="font-size: 1.2rem;">Please try again later.</p>
  </div>
  <!-- FIN MODAL DE BLOQUEO -->
                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center">
                  <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4z"/>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">${message.fileName}</p>
                  <p class="text-xs text-gray-500">${fileType}</p>
                </div>
              </div>
              <a href="${message.fileUrl}" download="${message.fileName}" class="inline-block mt-2 text-blue-600 hover:text-blue-800 text-sm">
                Descargar archivo
              </a>
            </div>
          `;
        } else if (message.type === 'voice') {
          messageContent = `
            <div class="flex items-center space-x-2 p-2">
              <button onclick="playVoiceMessage('${message.voiceUrl}')" class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M8 5v10l7-5-7-5z"/>
                </svg>
              </button>
              <div class="flex-1 bg-gray-300 h-1 rounded">
                <div class="bg-blue-500 h-1 rounded" style="width: 0%"></div>
              </div>
              <span class="text-xs text-gray-500">${message.duration || '0:00'}</span>
            </div>
          `;
        } else {
          // Detectar enlaces y convertirlos a clickeable
          messageContent = linkifyText(message.text);
        }

        messageDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md relative">
            <div class="px-4 py-3 rounded-2xl ${isOwnMessage ? 'bg-[#FE2C55] text-white rounded-br-md' : 'bg-white text-black border border-gray-200 rounded-bl-md'} shadow-sm">
              ${messageContent}
            </div>
            <div class="flex ${isOwnMessage ? 'justify-end' : 'justify-start'} mt-1 px-2">
              <span class="text-xs text-gray-500">
                ${formatTime(message.timestamp)}
                ${isOwnMessage ? (message.read ? ' <span class="text-blue-500">‚úì‚úì</span>' : ' <span class="text-gray-400">‚úì</span>') : ''}
              </span>
            </div>
            
            <!-- Men√∫ contextual del mensaje -->
            <div class="hidden group-hover:block absolute top-0 ${isOwnMessage ? 'left-0 -translate-x-full' : 'right-0 translate-x-full'} p-2">
              <div class="bg-white border border-gray-200 rounded-lg shadow-lg py-1">
                <button onclick="replyToMessage('${child.key}', '${message.text}')" class="w-full px-3 py-1 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                  <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                  </svg>
                  Responder
                </button>
                ${isOwnMessage ? `
                  <button onclick="deleteMessage('${child.key}')" class="w-full px-3 py-1 text-sm text-red-600 hover:bg-gray-100 flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Eliminar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;

        messagesContainer.appendChild(messageDiv);
      });

      // Scroll al final con animaci√≥n suave
      setTimeout(() => {
        messagesContainer.scrollTo({
          top: messagesContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);

      // Marcar mensajes como le√≠dos
      if (currentChatUserId === userId) {
        snapshot.forEach(child => {
          const message = child.val();
          if (message.senderId !== user.uid && !message.read) {
            child.ref.update({ read: true });
          }
        });
      }
    });
  }

  function linkifyText(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, '<a href="$1" target="_blank" class="underline">$1</a>');
  }

  function getFileType(fileName) {
    const extension = fileName.split('.').pop().toLowerCase();
    const types = {
      'pdf': 'Documento PDF',
      'doc': 'Documento Word',
      'docx': 'Documento Word',
      'txt': 'Archivo de texto',
      'jpg': 'Imagen JPEG',
      'jpeg': 'Imagen JPEG',
      'png': 'Imagen PNG',
      'gif': 'Imagen GIF',
      'mp4': 'Video MP4',
      'mp3': 'Audio MP3'
    };
    return types[extension] || 'Archivo';
  }

  function formatDateSeparator(timestamp) {
    const date = new Date(timestamp);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
      return 'Hoy';
    } else if (date.toDateString() === yesterday.toDateString()) {
      return 'Ayer';
    } else {
      return date.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
  }

  function replyToMessage(messageId, originalText) {
    const input = document.getElementById('message-input');
    input.value = `> ${originalText.substring(0, 50)}${originalText.length > 50 ? '...' : ''}\n\n`;
    input.focus();
    updateSendButton();
  }

  function deleteMessage(messageId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este mensaje?')) return;
    
    const user = firebase.auth().currentUser;
    if (!user || !currentChatUserId) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    firebase.database().ref('messages/' + conversationId + '/' + messageId).remove();
  }

  function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentChatUserId) return;

    const user = firebase.auth().currentUser;
    if (!user) return;

    const conversationId = [user.uid, currentChatUserId].sort().join('_');
    const messageData = {
      senderId: user.uid,
      receiverId: currentChatUserId,
      text: messageText,
      timestamp: Date.now(),
      read: false,
      type: 'text'
    };

    // Limpiar estado de escritura
    window.isTyping = false;
    firebase.database().ref('typing/' + conversationId + '/' + user.uid).remove();
    clearTimeout(typingTimeout);

    // Guardar mensaje
    firebase.database().ref('messages/' + conversationId).push(messageData);

    // Actualizar conversaciones
    const conversationUpdate = {
      lastMessage: messageText,
      lastMessageTime: Date.now(),
      lastMessageType: 'text'
    };

    firebase.database().ref('conversations/' + user.uid + '/' + currentChatUserId).update(conversationUpdate);
    firebase.database().ref('conversations/' + currentChatUserId + '/' + user.uid).update({
      ...conversationUpdate,
      unreadCount: firebase.database.ServerValue.increment(1)
    });

    // Enviar notificaci√≥n
    firebase.database().ref('users/' + user.uid).once('value', senderSnap => {
      const senderData = senderSnap.val();
      addNotification(currentChatUserId, `${senderData.username} te ha enviado un mensaje: ${messageText}`, 'message');
    });

    // Limpiar input y reset UI
    messageInput.value = '';
    messageInput.style.height = 'auto';
    updateSendButton();

    // Scroll inmediato al final
    const messagesContainer = document.getElementById('messages-container');
    setTimeout(() => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }, 50);
  }

  function openNewMessage() {
    const modal = document.getElementById('new-message-modal');
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevenir scroll del fondo
  }

  function closeNewMessage() {
    const modal = document.getElementById('new-message-modal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll del fondo
    document.getElementById('author-search').value = '';
    document.getElementById('new-message-text').value = '';
    document.getElementById('authors-results').classList.add('hidden');
    selectedAuthorForMessage = null;
  }

  function searchAuthors(query) {
    if (!query.trim()) {
      document.getElementById('authors-results').classList.add('hidden');
      return;
    }

    firebase.database().ref('users').once('value', snapshot => {
      const resultsContainer = document.getElementById('authors-results');
      resultsContainer.innerHTML = '';
      resultsContainer.classList.remove('hidden');

      let hasResults = false;
      snapshot.forEach(child => {
        const userData = child.val();
        if (userData.username && userData.username.toLowerCase().includes(query.toLowerCase())) {
          hasResults = true;
          const authorDiv = document.createElement('div');
          authorDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center space-x-3';
          authorDiv.onclick = () => selectAuthor(child.key, userData);
          
          authorDiv.innerHTML = `
            <img src="${userData.profileImage || 'https://via.placeholder.com/40'}" 
                 alt="${userData.username}" class="w-10 h-10 rounded-full object-cover">
            <div>
              <h4 class="font-semibold">${userData.username}</h4>
              <p class="text-sm text-gray-500">${userData.bio || 'Autor'}</p>
            </div>
          `;
          
          resultsContainer.appendChild(authorDiv);
        }
      });

      if (!hasResults) {
        resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-center">No se encontraron autores</div>';
      }
    });
  }

  function selectAuthor(userId, userData) {
    selectedAuthorForMessage = userId;
    document.getElementById('author-search').value = userData.username;
    document.getElementById('authors-results').classList.add('hidden');
  }

  function sendNewMessage() {
    const messageText = document.getElementById('new-message-text').value.trim();
    
    if (!messageText || !selectedAuthorForMessage) {
      alert('Por favor selecciona un autor y escribe un mensaje');
      return;
    }

    const user = firebase.auth().currentUser;
    if (!user) return;

    const conversationId = [user.uid, selectedAuthorForMessage].sort().join('_');
    const messageData = {
      senderId: user.uid,
      receiverId: selectedAuthorForMessage,
      text: messageText,
      timestamp: Date.now(),
      read: false,
      type: 'text'
    };

    // Guardar mensaje
    firebase.database().ref('messages/' + conversationId).push(messageData);

    // Crear/actualizar conversaciones
    const conversationUpdate = {
      lastMessage: messageText,
      lastMessageTime: Date.now()
    };

    firebase.database().ref('conversations/' + user.uid + '/' + selectedAuthorForMessage).update(conversationUpdate);
    firebase.database().ref('conversations/' + selectedAuthorForMessage + '/' + user.uid).update({
      ...conversationUpdate,
      unreadCount: 1
    });

    // Enviar notificaci√≥n
    firebase.database().ref('users/' + user.uid).once('value', senderSnap => {
      const senderData = senderSnap.val();
      addNotification(selectedAuthorForMessage, `${senderData.username} te ha enviado un mensaje: ${messageText}`, 'message');
    });

    closeNewMessage();
    alert('Mensaje enviado correctamente');
  }

  function deleteConversation(userId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar esta conversaci√≥n?')) return;

    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid + '/' + userId).remove();
    
    // Volver a la vista sin chat seleccionado
    document.getElementById('chat-header').classList.add('hidden');
    document.getElementById('messages-container').classList.add('hidden');
    document.getElementById('message-input-container').classList.add('hidden');
    document.getElementById('no-chat-selected').classList.remove('hidden');
    
    currentChatUserId = null;
  }

  function listenForUnreadMessages() {
    const user = firebase.auth().currentUser;
    if (!user) return;

    firebase.database().ref('conversations/' + user.uid).on('value', snapshot => {
      let totalUnread = 0;
      snapshot.forEach(child => {
        const conversation = child.val();
        totalUnread += conversation.unreadCount || 0;
      });

      const unreadBadge = document.getElementById('unread-messages-count');
      if (totalUnread > 0) {
        unreadBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
        unreadBadge.classList.remove('hidden');
      } else {
        unreadBadge.classList.add('hidden');
      }
    });
  }

  function attachFile() {
    document.getElementById('file-input').click();
  }

  async function handleFileAttachment(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      alert('El archivo es muy grande. M√°ximo 5MB.');
      return;
    }

    const user = firebase.auth().currentUser;
    const conversationId = [user.uid, currentChatUserId].sort().join('_');

    try {
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64String = e.target.result;
        const timestamp = Date.now();

        const response = await fetch('/.netlify/functions/upload-image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            imageData: base64String,
            fileName: file.name,
            userId: user.uid,
            timestamp: timestamp,
            contentType: file.type,
            imageType: 'messages'
          })
        });

        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'Error al subir archivo');
        }

        const messageData = {
          senderId: user.uid,
          receiverId: currentChatUserId,
          type: 'file',
          fileName: file.name,
          fileUrl: result.imageUrl,
          timestamp: Date.now(),
          read: false
        };

        firebase.database().ref('messages/' + conversationId).push(messageData);

        const conversationUpdate = {
          lastMessage: `üìé ${file.name}`,
          lastMessageTime: Date.now()
        };

        firebase.database().ref('conversations/' + user.uid + '/' + currentChatUserId).update(conversationUpdate);
        firebase.database().ref('conversations/' + currentChatUserId + '/' + user.uid).update({
          ...conversationUpdate,
          unreadCount: firebase.database.ServerValue.increment(1)
        });
      };
      
      reader.onerror = (error) => {
        console.error('Error al procesar archivo:', error);
        alert('Error al procesar el archivo');
      };
      
      reader.readAsDataURL(file);
    } catch (error) {
      console.error('Error al enviar archivo:', error);
      alert('Error al enviar el archivo');
    }
  }

  function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.toggle('hidden');
  }

  function insertEmoji(emoji) {
    const input = document.getElementById('message-input');
    input.value += emoji;
    document.getElementById('emoji-picker').classList.add('hidden');
    input.focus();
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);

    if (diffInHours < 1) {
      return 'Ahora';
    } else if (diffInHours < 24) {
      return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    } else if (diffInHours < 168) { // Una semana
      return date.toLocaleDateString('es-ES', { weekday: 'short' });
    } else {
      return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
    }
  }

  // Funci√≥n para abrir perfil de usuario desde el chat
  function openUserProfile(userId) {
    if (userId) {
      closeMessages();
      openAuthorProfile(userId);
    }
  }

  // Funci√≥n mejorada para agregar el bot√≥n de mensaje en perfiles de autor
  function addMessageButtonToProfile(authorId) {
    const user = firebase.auth().currentUser;
    if (!user || user.uid === authorId) return;

    const messageButton = document.createElement('button');
    messageButton.className = 'bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center hover:bg-blue-600 transition';
    messageButton.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      Mensaje
    `;
    messageButton.onclick = () => startConversationWithAuthor(authorId);

    const actionsContainer = document.querySelector('#author-profile-modal .flex.items-center.justify-center.w-full.mt-4.space-x-2');
    if (actionsContainer) {
      actionsContainer.appendChild(messageButton);
    }
  }

  function startConversationWithAuthor(authorId) {
    document.getElementById('author-profile-modal').style.display = 'none';
    selectedAuthorForMessage = authorId;
    
    firebase.database().ref('users/' + authorId).once('value', snapshot => {
      const userData = snapshot.val();
      document.getElementById('author-search').value = userData.username;
      openNewMessage();
    });
  }

  /*************** FIN SISTEMA DE MENSAJER√çA **************************/
</script>
<!-- NUEVO SCRIPT: Funci√≥n para descargar la historia completa y almacenarla offline -->
<script>
  function downloadStory() {
    if (!window.currentStoryId) {
      alert("No se ha seleccionado una historia.");
      return;
    }
    const storyId = window.currentStoryId;
    const btn = document.getElementById('download-story-btn');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    firebase.database().ref('stories/' + storyId).once('value')
      .then(storySnap => {
        const storyData = storySnap.val();
        if (!storyData) {
          throw new Error("Historia no encontrada");
        }
        return firebase.database().ref('stories/' + storyId + '/chapters').once('value')
          .then(chaptersSnap => {
            let chaptersHTML = '';
            chaptersSnap.forEach(child => {
              const chapter = child.val();
              chapter.id = child.key;
              // Se crea un bloque para cada cap√≠tulo con t√≠tulo y contenido completo
              chaptersHTML += `<div class="chapter" style="margin-bottom:20px;">
                  <h3 style="margin-bottom:10px;">Cap√≠tulo ${chapter.chapterNumber}</h3>
                  <p style="text-align:justify; white-space: pre-wrap;">${chapter.content}</p>
                </div>`;
            });
            storyData.chaptersHTML = chaptersHTML;
            return storyData;
          });
      })
      .then(storyData => {
        const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>${storyData.title}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .cover { max-width: 100%; height: auto; }
    .chapter { margin-top: 20px; margin-bottom: 20px; }
    .chapter h3 { margin-bottom: 10px; }
    .chapter p { text-align: justify; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>${storyData.title}</h1>
  <img src="${storyData.coverImage}" alt="Portada" class="cover">
  <div class="chapters">
    ${storyData.chaptersHTML}
  </div>
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>
</html>`;
        const blob = new Blob([htmlContent], {
          type: 'text/html'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = storyData.title.replace(/\s+/g, '_') + '.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        icon.classList.remove('fa-spin');
        icon.classList.remove('fa-download');
        icon.classList.add('fa-check');
        alert("Historia descargada para lectura offline.");
        setTimeout(() => {
          icon.classList.remove('fa-check');
          icon.classList.add('fa-download');
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error al descargar la historia: " + err.message);
        icon.classList.remove('fa-spin');
      });
  }
</script>
<!-- BEABOO STUDIO SECTION -->
<div id="beaboo-studio-modal" class="fixed inset-0 z-50 hidden bg-white overflow-y-auto">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeBeabooStudio()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <h2 class="text-2xl font-bold mb-6">BeaBoo Studio</h2>

    <!-- Selector de Fechas -->
    <div class="mb-6 flex items-center space-x-4">
      <select id="date-range" class="p-2 border rounded-lg">
        <option value="7">√öltimos 7 d√≠as</option>
        <option value="30">√öltimos 30 d√≠as</option>
        <option value="90">√öltimos 3 meses</option>
        <option value="365">√öltimo a√±o</option>
      </select>
      <div class="flex items-center space-x-2">
        <input type="date" id="date-start" class="p-2 border rounded-lg">
        <span>hasta</span>
        <input type="date" id="date-end" class="p-2 border rounded-lg">
      </div>
      <button onclick="updateStudioStats()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg">
        Actualizar
      </button>
    </div>

    <!-- Panel de Estad√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Historias</h3>
        <p id="total-stories" class="text-2xl font-bold">0</p>
        <p id="stories-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Total Vistas</h3>
        <p id="total-views" class="text-2xl font-bold">0</p>
        <p id="views-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Seguidores</h3>
        <p id="total-followers" class="text-2xl font-bold">0</p>
        <p id="followers-trend" class="text-sm text-green-500">+0%</p>
      </div>
      <div class="bg-gray-50 p-4 rounded-xl text-center">
        <h3 class="text-[#FE2C55] text-sm mb-1">Calificaci√≥n</h3>
        <p id="average-rating" class="text-2xl font-bold">0.0</p>
        <p id="rating-trend" class="text-sm text-green-500">+0%</p>
      </div>
    </div>

    <!-- Gr√°ficos de Tendencias -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Tendencias de Lectura</h3>
        <canvas id="reading-trends" class="w-full h-64"></canvas>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-bold mb-4">Interacci√≥n por Hora</h3>
        <canvas id="hourly-engagement" class="w-full h-64"></canvas>
      </div>
    </div>

    <!-- Gesti√≥n de Historias -->
    <div class="bg-white rounded-xl shadow p-4 mb-8">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">Mis Historias</h3>
        <div class="flex space-x-4">
          <button onclick="openStoryCreation()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nueva Historia
          </button>
          <button onclick="analyzeAccount()" class="bg-[#FE2C55] text-white px-4 py-2 rounded-lg flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Analizar Cuenta
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-4 text-left">Historia</th>
              <th class="p-4 text-left">Cap√≠tulos</th>
              <th class="p-4 text-left">Vistas</th>
              <th class="p-4 text-left">Rating</th>
              <th class="p-4 text-left">Estado</th>
              <th class="p-4 text-left">Acciones</th>
            </tr>
          </thead>
          <tbody id="stories-table" class="divide-y divide-gray-200">
            <!-- Las historias se cargar√°n aqu√≠ din√°micamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Insights y Recomendaciones -->
    <div class="bg-white rounded-xl shadow p-4">
      <h3 class="text-lg font-bold mb-4">Insights</h3>
      <div id="insights" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="font-bold text-blue-700">Mejor hora para publicar</h4>
          <p id="best-time" class="mt-2">Analizando datos...</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="font-bold text-green-700">Contenido m√°s exitoso</h4>
          <p id="best-content" class="mt-2">Analizando datos...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE CALENDARIO -->
<div id="calendar-modal" class="fixed inset-0 z-50 hidden bg-white">
  <div class="p-4">
    <!-- Bot√≥n Volver -->
    <button onclick="closeCalendar()" class="text-[#FE2C55] mb-4 flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      <span>Volver</span>
    </button>

    <h2 class="text-2xl font-bold mb-4">Pr√≥ximas Publicaciones</h2>
    <div id="scheduled-content" class="space-y-4">
      <!-- Aqu√≠ se mostrar√°n los cap√≠tulos programados -->
    </div>
  </div>
</div>

<script>
function openDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDisneyModal() {
  const modal = document.getElementById('disney-modal');
  modal.classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function openCalendar() {
  const modal = document.getElementById('calendar-modal');
  modal.classList.remove('hidden');
  
  // Cargar cap√≠tulos programados
  firebase.database().ref('scheduledChapters').once('value').then(snapshot => {
    const container = document.getElementById('scheduled-content');
    container.innerHTML = '';
    
    snapshot.forEach(child => {
      const scheduled = child.val();
      const storyId = scheduled.storyId;
      const releaseDate = new Date(scheduled.publishDate);
      const now = new Date();
      const daysUntil = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
      const isAvailable = now >= releaseDate;
      
      // Obtener informaci√≥n de la historia
      firebase.database().ref('stories/' + storyId).once('value').then(storySnap => {
        const story = storySnap.val();
        const isNew = (now - new Date(story.createdAt)) < 7 * 24 * 60 * 60 * 1000; // 7 d√≠as
        
        const div = document.createElement('div');
        div.className = 'bg-gray-100 p-4 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center space-x-4">
            <img src="${story.coverImage || '/api/placeholder/100/150'}" alt="${story.title}" class="w-20 h-30 object-cover rounded">
            <div class="flex-1">
              <div class="flex items-center">
                <h3 class="font-bold">${story.title}</h3>
                ${isNew ? '<span class="ml-2 bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>' : ''}
              </div>
              <p class="text-gray-600">Cap√≠tulo ${scheduled.chapterNumber}</p>
              ${isAvailable ? 
                `<button onclick="openChapterReadModal('${storyId}', '${child.key}')" 
                  class="bg-[#58CC02] text-white px-3 py-1 rounded-full text-sm">
                  Leer ahora
                </button>` : 
                `<p class="text-gray-600">Se publicar√° en ${daysUntil} d√≠as</p>
                 <p class="text-gray-600">Fecha: ${releaseDate.toLocaleDateString()}</p>`
              }
            </div>
            ${isNew ? `
  <div class="flex flex-wrap items-center gap-2">
    <span class="bg-[#FE2C55] text-white px-2 py-1 rounded text-xs">ESTRENO</span>
    <button 
      onclick="toggleNotification(event, '${storyId}', '${child.key}', '${story.title}', ${scheduled.publishDate})"
      class="notification-bell-btn inline-flex items-center px-2 py-1 text-gray-600 hover:text-[#FE2C55] transition-colors"
    >
      <i class="fas fa-bell notification-bell text-sm"></i>
      <span class="ml-1 text-xs">Avisarme</span>
    </button>
  </div>
` : ''}
          </div>
        `;
        
        container.appendChild(div);

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
          .notification-bell {
            transform-origin: top;
          }
          
          .notification-bell.active {
            color: #FE2C55;
            animation: bellRing 1s ease-in-out;
          }
          
          @keyframes bellRing {
            0%, 100% { transform: rotate(0); }
            20%, 60% { transform: rotate(25deg); }
            40%, 80% { transform: rotate(-25deg); }
          }
        `;
        document.head.appendChild(style);
        
        // Programar notificaci√≥n
        const user = firebase.auth().currentUser;
        if (user) {
          const notificationTime = new Date(scheduled.publishDate);
          const currentTime = new Date();
          
          if (notificationTime > currentTime) {
            const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
            
            setTimeout(() => {
              addNotification(user.uid, `¬°Tu cap√≠tulo programado de "${story.title}" ha sido publicado!`, 'chapter_published');
              
              // Solo actualizar cuando llegue la fecha de publicaci√≥n
              if (new Date() >= notificationTime) {
                firebase.database().ref('stories/' + storyId + '/chapters/' + child.key).update({
                  status: 'published'
                });
              }
              
              // Eliminar de cap√≠tulos programados
              firebase.database().ref('scheduledChapters/' + child.key).remove();
            }, timeUntilNotification);
          }
        }
      });
    });
  });
}

function closeCalendar() {
  document.getElementById('calendar-modal').classList.add('hidden');
}

function toggleNotification(event, storyId, chapterId, storyTitle, publishDate) {
  event.stopPropagation();
  const user = firebase.auth().currentUser;
  if (!user) return;

  const bell = event.currentTarget.querySelector('.notification-bell');
  bell.classList.add('active');
  
  // Toggle notification in database
  const notificationRef = firebase.database().ref(`userNotifications/${user.uid}/${chapterId}`);
  
  notificationRef.once('value').then(snapshot => {
    if (snapshot.exists()) {
      // Remove notification
      notificationRef.remove();
      bell.style.color = '#666';
      alert('Notificaci√≥n cancelada');
    } else {
      // Add notification
      notificationRef.set({
        storyId,
        storyTitle,
        publishDate,
        status: 'pending'
      });
      bell.style.color = '#FE2C55';
      alert('¬°Te avisaremos cuando se publique el cap√≠tulo!');

      // Schedule notification
      const notificationTime = new Date(publishDate);
      const currentTime = new Date();
      
      if (notificationTime > currentTime) {
        const timeUntilNotification = notificationTime.getTime() - currentTime.getTime();
        
        setTimeout(() => {
          addNotification(
            user.uid, 
            `¬°El nuevo cap√≠tulo de "${storyTitle}" ya est√° disponible!`,
            'chapter_release'
          );
        }, timeUntilNotification);
      }
    }
  });

  setTimeout(() => {
    bell.classList.remove('active');
  }, 1000);
}

function openBeabooStudio() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  
  document.getElementById('beaboo-studio-modal').classList.remove('hidden');
  
  // Establecer fechas por defecto
  const end = new Date();
  const start = new Date();
  start.setDate(start.getDate() - 7);
  document.getElementById('date-start').value = start.toISOString().split('T')[0];
  document.getElementById('date-end').value = end.toISOString().split('T')[0];
  
  updateStudioStats();
}

function updateStudioStats() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const startDate = new Date(document.getElementById('date-start').value);
  const endDate = new Date(document.getElementById('date-end').value);
  
  firebase.database().ref('stories').orderByChild('userId').equalTo(user.uid).once('value')
    .then(snapshot => {
      let totalStories = 0;
      let totalViews = 0;
      let totalRating = 0;
      let ratingCount = 0;
      let viewsData = {};
      let hourlyData = new Array(24).fill(0);
      
      // Procesar datos
      snapshot.forEach(child => {
        const story = child.val();
        const storyDate = new Date(story.createdAt);
        
        if (storyDate >= startDate && storyDate <= endDate) {
          totalStories++;
          totalViews += story.views || 0;
          
          // Datos por hora
          const hour = storyDate.getHours();
          hourlyData[hour] += story.views || 0;
          
          // Datos para gr√°fico de tendencias
          const dateStr = storyDate.toLocaleDateString();
          viewsData[dateStr] = (viewsData[dateStr] || 0) + (story.views || 0);
          
          if (story.ratings) {
            Object.values(story.ratings).forEach(rating => {
              totalRating += rating;
              ratingCount++;
            });
          }
        }
        
        // Actualizar tabla de historias
        updateStoriesTable(story);
      });
      
      // Actualizar estad√≠sticas
      updateStatistics(totalStories, totalViews, totalRating, ratingCount);
      
      // Actualizar gr√°ficos
      updateCharts(viewsData, hourlyData);
      
      // Calcular y mostrar insights
      calculateInsights(hourlyData, viewsData);
    });
}

function updateStoriesTable(story) {
  const tbody = document.getElementById('stories-table');
  const row = document.createElement('tr');
  row.className = 'hover:bg-gray-50';
  
  const status = story.status || 'published';
  const statusColors = {
    'published': 'bg-green-100 text-green-800',
    'draft': 'bg-gray-100 text-gray-800',
    'scheduled': 'bg-blue-100 text-blue-800'
  };
  
  row.innerHTML = `
    <td class="p-4">
      <div class="flex items-center space-x-3">
        <img src="${story.coverImage || '/api/placeholder/50/75'}" class="w-12 h-16 object-cover rounded" alt="${story.title}">
        <div>
          <h4 class="font-bold">${story.title}</h4>
          <p class="text-sm text-gray-600">${new Date(story.createdAt).toLocaleDateString()}</p>
        </div>
      </div>
    </td>
    <td class="p-4">${(story.chapters || []).length}</td>
    <td class="p-4">${story.views || 0}</td>
    <td class="p-4">${calculateAverageRating(story.ratings)}</td>
    <td class="p-4">
      <span class="px-2 py-1 rounded-full text-xs ${statusColors[status]}">
        ${status.charAt(0).toUpperCase() + status.slice(1)}
      </span>
    </td>
    <td class="p-4">
      <div class="flex space-x-2">
        <button onclick="openStoryEdit(${JSON.stringify(story)})" class="text-blue-600 hover:text-blue-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
        </button>
        <button onclick="openChapterCreationModal()" class="text-green-600 hover:text-green-800">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>
    </td>
  `;
  
  tbody.appendChild(row);
}

function updateStatistics(totalStories, totalViews, totalRating, ratingCount) {
  document.getElementById('total-stories').textContent = totalStories;
  document.getElementById('total-views').textContent = totalViews;
  document.getElementById('average-rating').textContent = 
    ratingCount > 0 ? (totalRating / ratingCount).toFixed(1) : "0.0";
  
  // Actualizar tendencias (ejemplo)
  document.getElementById('stories-trend').textContent = '+5%';
  document.getElementById('views-trend').textContent = '+12%';
  document.getElementById('rating-trend').textContent = '+2%';
}

function updateCharts(viewsData, hourlyData) {
  // Gr√°fico de tendencias
  const trendCtx = document.getElementById('reading-trends').getContext('2d');
  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: Object.keys(viewsData),
      datasets: [{
        label: 'Vistas',
        data: Object.values(viewsData),
        borderColor: '#FE2C55',
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
  
  // Gr√°fico de actividad por hora
  const hourlyCtx = document.getElementById('hourly-engagement').getContext('2d');
  new Chart(hourlyCtx, {
    type: 'bar',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}:00`),
      datasets: [{
        label: 'Actividad',
        data: hourlyData,
        backgroundColor: '#FE2C55'
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

function calculateInsights(hourlyData, viewsData) {
  // Calcular mejor hora para publicar
  const bestHour = hourlyData.indexOf(Math.max(...hourlyData));
  document.getElementById('best-time').textContent = 
    `La mejor hora para publicar es a las ${bestHour}:00, donde tienes mayor engagement.`;
  
  // Calcular contenido m√°s exitoso
  const bestDate = Object.entries(viewsData)
    .reduce((a, b) => (b[1] > a[1] ? b : a))[0];
  document.getElementById('best-content').textContent = 
    `Tu contenido m√°s exitoso fue publicado el ${bestDate}.`;
}

function calculateAverageRating(ratings) {
  if (!ratings) return "0.0";
  const values = Object.values(ratings);
  return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
}

function analyzeAccount() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  // Show analysis modal
  const analysisModal = document.createElement('div');
  analysisModal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[60]';
  analysisModal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
      <div id="analysis-loading" class="text-center">
        <div class="spinner-ring mb-4">
          <div></div><div></div><div></div><div></div>
        </div>
        <h3 class="text-xl font-bold mb-2">Analizando cuenta</h3>
        <p id="analysis-status" class="text-gray-600">Recopilando datos...</p>
      </div>
      <div id="analysis-results" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Resultados del an√°lisis</h3>
          <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                  class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="analysis-metrics" class="space-y-4"></div>
      </div>
    </div>
  `;

  document.body.appendChild(analysisModal);

  // Add spinner styles
  const style = document.createElement('style');
  style.textContent = `
    .spinner-ring {
      display: inline-block;
      position: relative;
      width: 80px;
      height: 80px;
    }
    .spinner-ring div {
      box-sizing: border-box;
      display: block;
      position: absolute;
      width: 64px;
      height: 64px;
      margin: 8px;
      border: 8px solid #FE2C55;
      border-radius: 50%;
      animation: spinner-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
      border-color: #FE2C55 transparent transparent transparent;
    }
    .spinner-ring div:nth-child(1) { animation-delay: -0.45s; }
    .spinner-ring div:nth-child(2) { animation-delay: -0.3s; }
    .spinner-ring div:nth-child(3) { animation-delay: -0.15s; }
    @keyframes spinner-ring {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);

  // Start analysis
  let statusText = document.getElementById('analysis-status');
  let analysisData = {
    followers: 0,
    following: 0,
    posts: 0,
    warnings: [],
    suspiciousActivity: []
  };

  // Simulate analysis steps
  setTimeout(() => {
    statusText.textContent = "Analizando seguidores...";
    firebase.database().ref('followers/' + user.uid).once('value', snapshot => {
      analysisData.followers = snapshot.numChildren() || 0;
    });
  }, 5000);

  setTimeout(() => {
    statusText.textContent = "Analizando seguidos...";
    firebase.database().ref('following/' + user.uid).once('value', snapshot => {
      analysisData.following = snapshot.numChildren() || 0;
    });
  }, 10000);

  setTimeout(() => {
    statusText.textContent = "Verificando historial...";
    firebase.database().ref('userWarnings/' + user.uid).once('value', snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(child => {
          analysisData.warnings.push(child.val());
        });
      }
    });
  }, 15000);

  // Show results after 20 seconds
  setTimeout(() => {
    const loading = document.getElementById('analysis-loading');
    const results = document.getElementById('analysis-results');
    const metrics = document.getElementById('analysis-metrics');

    loading.classList.add('hidden');
    results.classList.remove('hidden');

    // Calculate account status
    let accountStatus = analysisData.warnings.length === 0 ? 
      { text: 'Cuenta en buen estado', color: 'bg-green-100 text-green-800' } :
      analysisData.warnings.length <= 2 ?
      { text: 'Advertencias activas', color: 'bg-yellow-100 text-yellow-800' } :
      { text: 'Cuenta en riesgo', color: 'bg-red-100 text-red-800' };

    metrics.innerHTML = `
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.followers}</div>
          <div class="text-sm text-gray-600">Seguidores</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.following}</div>
          <div class="text-sm text-gray-600">Seguidos</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-xl text-center">
          <div class="text-2xl font-bold text-[#FE2C55]">${analysisData.posts}</div>
          <div class="text-sm text-gray-600">Publicaciones</div>
        </div>
      </div>
      
      <div class="space-y-4">
        <div class="p-4 rounded-xl ${accountStatus.color}">
          <div class="font-bold">${accountStatus.text}</div>
        </div>
        
        ${analysisData.warnings.length > 0 ? `
          <div class="p-4 rounded-xl bg-gray-50">
            <div class="font-bold mb-2">Advertencias:</div>
            <ul class="list-disc list-inside space-y-1">
              ${analysisData.warnings.map(w => `<li>${w}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      </div>
    `;
  }, 20000);
}

function closeBeabooStudio() {
  document.getElementById('beaboo-studio-modal').classList.add('hidden');
  document.getElementById('story-stats').innerHTML = '';
}
</script>

<!-- (El modal de compra de monedas ha sido removido) -->

<script>
  const translations = {
    es: {
      appName: "BeaBoo",
      tagline: "Tu portal de historias inolvidables",
      authTitle: "BeaBoo",
      emailPlaceholder: "Correo electr√≥nico",
      passwordPlaceholder: "Contrase√±a",
      btnIniciarSesion: "Iniciar Sesi√≥n",
      btnToggleAuth: "¬øNo tienes cuenta? Reg√≠strate",
      btnVolver: "Volver",
      newReleases: "Nuevos Lanzamientos",
      top10: "Top 10",
      popular: "M√°s Populares",
      terror: "Historias de Terror Destacadas",
      searchPlaceholder: "Buscar historias o autores",
      searchResults: "Resultados de b√∫squeda",
      searchBooks: "Libros",
      searchAuthors: "Autores",
      profileStories: "Mis Historias",
      editProfile: "Editar nombre",
      saveBio: "Guardar biograf√≠a",
      createStory: "Crear Historia",
      storyTitlePlaceholder: "T√≠tulo de la historia",
      selectCategory: "Selecciona una categor√≠a",
      btnCreateStory: "Crear Historia",
      editStory: "Editar Historia",
      addChapter: "Agregar Cap√≠tulo",
      deleteStory: "Eliminar Historia",
      makePrivate: "Hacer privada",
      chapterCreationTitle: "Agregar Nuevo Cap√≠tulo",
      chapterPlaceholder: "Escribe el contenido del cap√≠tulo aqu√≠...",
      btnSaveChapter: "Guardar Cap√≠tulo",
      readChapter: "Cap√≠tulo",
      btnPrevChapter: "Anterior",
      btnNextChapter: "Siguiente",
      rateChapter: "Califica:",
      authorProfile: "Por",
      reportProfile: "Reportar Perfil",
      reportInstructions: "Selecciona un motivo o describe el problema:",
      btnSendReport: "Enviar Reporte",
      reportSuccess: "Reporte enviado con √©xito. En breve recibir√°s una respuesta.",
      noInfraccion: "No se detectaron infracciones en este perfil.",
      followers: "Seguidores",
      following: "Siguiendo",
      ratings: "Calificaciones",
      languageModalTitle: "Selecciona tu idioma",
      editUsernamePrompt: "Introduce tu nuevo nombre de usuario:",
      usernameUpdated: "Nombre de usuario actualizado.",
      bioUpdated: "Biograf√≠a actualizada.",
      chapterAdded: "Cap√≠tulo agregado.",
      noEditingStory: "No hay historia en edici√≥n.",
      userNotAuthenticated: "Usuario no autenticado.",
      chapterNotFound: "Cap√≠tulo no encontrado.",
      firstChapter: "Este es el primer cap√≠tulo.",
      lastChapter: "Este es el √∫ltimo cap√≠tulo.",
      chapterRated: "Cap√≠tulo calificado con {value} estrella(s).",
      followSelfError: "No puedes seguirte a ti mismo.",
      nowFollowing: "Ahora sigues a este autor.",
      stoppedFollowing: "Has dejado de seguir a este autor.",
      alreadyFollowing: "Ya sigues a este usuario.",
      storyDeleted: "Historia eliminada.",
      editLater: "Puedes editar tu historia m√°s tarde desde tu perfil."
    },
    en: {
      appName: "BeaBoo",
      editLater: "You can edit your story later from your profile."
    },
    pt: {
      appName: "BeaBoo",
      tagline: "Seu portal para hist√≥rias inesquec√≠veis",
      editLater: "Voc√™ pode editar sua hist√≥ria mais tarde em seu perfil."
    }
  };
  // Funci√≥n que actualiza los textos de la interfaz seg√∫n currentLanguage
  function updateTranslations() {
    // Ejemplo: Actualizamos el t√≠tulo de la aplicaci√≥n y el tagline
    document.getElementById('app-name').innerText = translations[currentLanguage].appName;
    document.getElementById('tagline').innerText = translations[currentLanguage].tagline;
    // ... (contin√∫a actualizando todos los elementos que dependan de traducciones)
  }
  // Funci√≥n para establecer el idioma y guardar la selecci√≥n
  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("selectedLanguage", lang);
    const langOverlay = document.getElementById('lang-loading-overlay');
    if (langOverlay) langOverlay.style.display = "flex";
    setTimeout(() => {
      updateTranslations();
      if (langOverlay) langOverlay.style.display = "none";
      const langModal = document.getElementById('language-modal');
      if (langModal) langModal.style.display = "none";
    }, 1000);
  }

  function blockAuthor() {
    const currentUser = firebase.auth().currentUser;
    if (!currentUser || !currentViewedAuthorId) return;
    
    const blockRef = firebase.database().ref('blocks/' + currentUser.uid + '/' + currentViewedAuthorId);
    const blockButton = document.getElementById('block-button');
    
    blockRef.once('value').then(snapshot => {
      if (snapshot.exists()) {
        // Desbloquear
        blockRef.remove().then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>`;
          alert('Usuario desbloqueado');
        });
      } else {
        // Bloquear
        blockRef.set({
          blockedAt: Date.now()
        }).then(() => {
          blockButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>`;
          alert('Usuario bloqueado');
        });
      }
    });
  }
</script>

  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>

<!-- Story Viewer Modal -->
<div id="story-viewer">
    <div class="story-content">
        <!-- Story content will be loaded here -->
    </div>
    <button id="story-viewer-close" class="story-close">&times;</button>
</div>

<!-- Story Upload Modal -->
<div id="story-upload-modal">
    <div class="story-upload-content">
        <div class="story-upload-header">
            <button class="back-btn" id="story-upload-back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 style="margin: 0;">Subir Historia</h2>
            <div style="width: 40px;"></div>
        </div>
        
        <div class="story-upload-preview">
            <img src="" alt="Preview">
        </div>
        
        <form id="story-upload-form">
            <div class="file-input-wrapper">
                <label for="story-file" class="file-input-label">
                    <i class="fas fa-camera"></i>
                    <span>Seleccionar imagen</span>
                    <span class="file-hint">Toca para elegir de tu galer√≠a</span>
                </label>
                <input type="file" id="story-file" accept="image/*" required>
            </div>
            
            <div class="upload-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar"></div>
                </div>
                <div class="progress-text">Subiendo...</div>
            </div>
            
            <button type="submit">Subir Historia</button>
        </form>
    </div>
</div>

<!-- Global Loading Spinner -->
<div id="global-loader" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden items-center justify-center">
  <div class="loader"></div>
</div>

<style>
.loader {
  border: 4px solid rgba(254, 44, 85, 0.1);
  border-radius: 50%;
  border-top: 4px solid #FE2C55;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
// Global loading spinner functions
function showLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'flex';
  }
}

function hideLoader() {
  const loader = document.getElementById('global-loader');
  if (loader) {
    loader.style.display = 'none';
  }
}

// Automatic Firebase to S3 migration on first load
async function autoMigrateFirebaseData() {
  const migrationKey = 'firebase_s3_migration_completed';
  const migrationCompleted = localStorage.getItem(migrationKey);
  
  if (migrationCompleted === 'true') {
    console.log('Migration already completed');
    return;
  }

  try {
    console.log('Starting automatic Firebase to S3 migration...');
    showLoader();
    
    const response = await fetch('/.netlify/functions/migrate-firebase-to-s3', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ deleteFromFirebase: false })
    });

    const result = await response.json();
    
    if (response.ok && result.success) {
      console.log(`Migration successful: ${result.migrated} stories migrated`);
      localStorage.setItem(migrationKey, 'true');
    } else {
      console.warn('Migration had issues:', result);
    }
  } catch (error) {
    console.error('Auto-migration error:', error);
  } finally {
    hideLoader();
  }
}

// Run migration on authenticated user
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    autoMigrateFirebaseData();
  }
});
</script>

<script src="stories.js"></script>
  <footer class="bg-white border-t border-gray-200 mt-10">
    <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
      <a href="support.html" class="hover:text-pink-600 transition duration-300">Soporte y Ayuda</a>
    </div>
  </footer>
</body>
</html>

